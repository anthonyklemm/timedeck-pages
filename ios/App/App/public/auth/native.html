<!doctype html>
<html><head>
  <meta charset="utf-8" />
  <title>Sign in to Apple Music</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://js-cdn.music.apple.com/musickit/v3/musickit.js"></script>
  <style>body{font:16px -apple-system,system-ui;display:grid;place-items:center;height:100dvh;margin:0;background:#0a0f17;color:#e5e7eb}</style>
</head>
<body>
  <div id="msg">Contacting Apple…</div>
<script>
(async function(){
  const API = 'https://timedeck-api.onrender.com';
  function set(m){ document.getElementById('msg').textContent = m; }

  try{
    const r = await fetch(`${API}/v1/apple/dev-token`);
    if(!r.ok) throw new Error('dev-token failed');
    const { token: developerToken } = await r.json();
    if(!developerToken) throw new Error('no developer token');

    await new Promise((res,rej)=>{
      if (window.MusicKit && window.MusicKit.configure) return res();
      const t = setTimeout(()=>rej(new Error('MusicKit load timeout')), 10000);
      window.addEventListener('musickitloaded', ()=>{ clearTimeout(t); res(); }, {once:true});
    });

    window.MusicKit.configure({ developerToken, app:{ name:'TapeDeck Time Machine', build:'native' } });
    const music = window.MusicKit.getInstance();
    const userToken = await music.authorize();
    if(!userToken) throw new Error('authorize returned empty token');

    set('Signed in, returning to app…');

    // Redirect to the Universal Link (iOS should hand this to your app)
    const cb = 'https://tapedecktimemachine.com/auth/callback?token=' + encodeURIComponent(userToken);
    window.location.replace(cb);
  }catch(e){
    console.error(e);
    set('Sign-in failed: ' + (e.message || e));
  }
})();
</script>
</body></html>
