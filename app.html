<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TapeDeck Time Machine</title>
<style>
  :root { --bg:#0b0f1a; --card:#121829; --ink:#e8eaf3; --muted:#9aa3b2; --accent:#a855f7; --accent2:#22d3ee; }
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1100px;margin:40px auto;padding:0 16px}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.00)),var(--card);
        border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.35);padding:16px}
  .hdr{display:flex;align-items:center;gap:12px;font-weight:800;font-size:22px;margin-bottom:10px}
  .tip{opacity:.7;font-size:12px}
  label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
  input,select{background:#0d1324;border:1px solid #1d2542;color:var(--ink);padding:10px 12px;border-radius:12px;outline:none;width:100%}
  button{background:linear-gradient(90deg,var(--accent),var(--accent2));color:white;border:0;border-radius:12px;padding:10px 14px;
         font-weight:700;cursor:pointer;box-shadow:0 10px 30px rgba(168,85,247,.25)}
  .tabs{display:flex;gap:10px;margin:10px 0 8px}
  .tab{background:#171e34;border:1px solid #242c4b;border-radius:12px;padding:9px 12px;cursor:pointer}
  .tab.active{outline:2px solid #6d28d9}
  .cols{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
  .tracklist{border:1px dashed #283255;border-radius:14px;padding:12px;min-height:260px}
  .tr{display:flex;justify-content:space-between;border-bottom:1px solid #202743;padding:10px 4px}
  .tr:last-child{border-bottom:0}
  .meta{font-size:12px;color:var(--muted)}
  iframe{width:100%;height:360px;border:0;border-radius:12px;background:#0d1324}
  .btn{display:inline-block;background:#0d1324;border:1px solid #273055;color:var(--ink);padding:10px 12px;border-radius:12px;
       font-weight:700;text-decoration:none}
  .status{font-size:12px;color:var(--muted);margin-top:6px}
</style>

<div class="wrap">
  <div class="hdr">
    <div style="width:36px;height:36px;background:#1c2444;border-radius:9px;display:grid;place-items:center">⏺️</div>
    TapeDeck Time Machine
    <div class="tip" style="margin-left:auto">Tip: append <code>?api=YOUR_API_URL</code> to use your backend</div>
  </div>

  <div class="card">
    <div class="row">
      <div style="flex:1;min-width:220px">
        <label>Date</label>
        <input id="date" type="text" placeholder="mm/dd/yyyy" />
      </div>
      <div style="flex:1;min-width:220px">
        <label>Genre</label>
        <select id="genre">
          <option value="alternative">Alternative</option>
          <option value="hot-100">Hot 100</option>
          <option value="rock">Rock</option>
          <option value="adult-alternative">Adult Alternative</option>
        </select>
      </div>
      <div style="width:140px">
        <label>Hours</label>
        <select id="hours">
          <option>1</option><option selected>4</option><option>8</option>
        </select>
      </div>
      <div style="width:180px">
        <label>Repeat gap (min)</label>
        <input id="gap" type="number" value="90" />
      </div>
      <div style="width:220px">
        <label>Seed (opt)</label>
        <input id="seed" placeholder="e.g. 20020707" />
      </div>
      <div style="align-self:flex-end">
        <button id="go">Generate</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="yt">YouTube</div>
      <div class="tab" data-tab="am">Apple Music</div>
      <div class="tab" data-tab="sp">Spotify</div>
    </div>

    <div class="cols">
      <div id="panel-left" class="card">
        <div id="yt-wrap">
          <iframe id="yt-embed" allow="autoplay; encrypted-media" allowfullscreen></iframe>
          <div style="display:flex;gap:10px;margin-top:10px">
            <a id="open-yt" class="btn" target="_blank" rel="noopener">Open in YouTube</a>
            <span id="yt-status" class="status"></span>
          </div>
        </div>

        <div id="am-wrap" style="display:none">
          <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px">
            <button id="am-sign">Sign in to Apple Music</button>
            <div id="am-user" class="status">Not signed in</div>
          </div>
          <div style="display:flex;gap:10px">
            <button id="am-create" disabled>Create Playlist</button>
            <span id="am-status" class="status"></span>
          </div>
        </div>

        <div id="sp-wrap" style="display:none">
          <div class="status">Spotify export coming soon.</div>
        </div>
      </div>

      <div class="tracklist" id="list"></div>
    </div>
  </div>
</div>

<script>
const API = new URLSearchParams(location.search).get('api') || '';
const $ = sel => document.querySelector(sel);
const fmtDate = (d) => {
  const dt = new Date(d);
  const y = dt.getFullYear(), m = String(dt.getMonth()+1).padStart(2,'0'), da = String(dt.getDate()).padStart(2,'0');
  return `${y}-${m}-${da}`;
};

let lastTracks = [];   // [{artist,title,year}]
let ytIds = [];

function setTab(tab){
  for (const el of document.querySelectorAll('.tab')) el.classList.toggle('active', el.dataset.tab===tab);
  $('#yt-wrap').style.display = tab==='yt'?'block':'none';
  $('#am-wrap').style.display = tab==='am'?'block':'none';
  $('#sp-wrap').style.display = tab==='sp'?'block':'none';
}
document.querySelectorAll('.tab').forEach(t => t.onclick = () => setTab(t.dataset.tab));

function renderList(rows){
  const box = $('#list');
  if (!rows || !rows.length){ box.innerHTML = '<div class="status">Tracklist will appear here.</div>'; return; }
  box.innerHTML = rows.map(r => `
    <div class="tr">
      <div>
        <div>${r.artist} — <b>${r.title}</b></div>
        <div class="meta">${r.timestamp || ''}${r.year? ' • '+r.year : ''}</div>
      </div>
    </div>
  `).join('');
}

function setYT(ids){
  ytIds = ids || [];
  const link = 'https://www.youtube.com/watch_videos?video_ids=' + ytIds.join(',');
  $('#open-yt').href = link;
  // embed: cue the first ID as a playlist if we have any
  const first = ytIds[0] || '';
  const src = first
    ? `https://www.youtube.com/embed/${first}?enablejsapi=1&playsinline=1&modestbranding=1&rel=0&playlist=${ytIds.slice(1).join(',')}`
    : 'about:blank';
  $('#yt-embed').src = src;
}

async function simulate(){
  const date = $('#date').value.trim();
  const payload = {
    date: fmtDate(date),
    genre: $('#genre').value,
    hours: parseInt($('#hours').value,10),
    repeat_gap_min: parseInt($('#gap').value,10),
    seed: $('#seed').value || undefined
  };
  const r = await fetch(`${API}/v1/simulate`, {
    method:'POST', headers:{'content-type':'application/json'},
    body: JSON.stringify(payload)
  });
  if (!r.ok){
    $('#list').innerHTML = `<div class="status">Simulation failed: ${r.status}</div>`;
    return [];
  }
  const data = await r.json();
  // expect data.rows like [{timestamp,artist,title,year}]
  const rows = data.rows || data || [];
  renderList(rows);
  lastTracks = rows.map(x => ({artist: x.artist, title: x.title, year: x.year || null}));
  return rows;
}

async function resolveYouTube(tracks){
  $('#yt-status').textContent = 'Building…';
  // 1) cache-only fast pass
  let fast;
  try {
    fast = await fetch(`${API}/v1/resolve_batch_fast?region=US`, {
      method:'POST', headers:{'content-type':'application/json'},
      body: JSON.stringify(tracks)
    }).then(r=>r.json());
  } catch(e){
    $('#yt-status').textContent = 'Error contacting backend.';
    return;
  }
  const cached = (fast.items||[]).map(x => x.videoId).filter(Boolean);
  setYT(cached);
  $('#yt-status').textContent = `Ready (${cached.length} cached)… resolving more`;
  // 2) background full resolve
  const misses = tracks.filter((t,i)=> !(fast.items[i] && fast.items[i].videoId));
  if (misses.length){
    fetch(`${API}/v1/resolve_batch?region=US`, {
      method:'POST', headers:{'content-type':'application/json'},
      body: JSON.stringify({tracks: misses})
    }).then(r=>r.json()).then(full => {
      const news = (full.items||[]).map(x => x.videoId).filter(Boolean);
      const merged = Array.from(new Set([...cached, ...news]));
      setYT(merged);
      $('#yt-status').textContent = `Playable: ${merged.length}`;
    }).catch(()=>{
      $('#yt-status').textContent = `Playable: ${cached.length}`;
    });
  } else {
    $('#yt-status').textContent = `Playable: ${cached.length}`;
  }
}

$('#go').onclick = async () => {
  const rows = await simulate();
  if (rows.length) resolveYouTube(lastTracks);
};

/* ---------- Apple Music (MusicKit) ---------- */
let music = null, amSigned = false;
async function getDevToken(){
  const r = await fetch(`${API}/dev-token`).then(r=>r.json());
  return r.token;
}
async function ensureMusicKit(){
  if (window.MusicKit) return window.MusicKit;
  await new Promise(res => {
    const s = document.createElement('script');
    s.src = "https://js-cdn.music.apple.com/musickit/v3/musickit.js";
    s.onload = res;
    document.head.appendChild(s);
  });
  return window.MusicKit;
}
async function amInit(){
  const MK = await ensureMusicKit();
  const devToken = await getDevToken();
  MK.configure({ developerToken: devToken, app: { name: 'TimeDeck', build: '1.0' }});
  music = MK.getInstance();
}
async function amSignIn(){
  try{
    if (!music) await amInit();
    const userToken = await music.authorize();
    amSigned = !!userToken;
    $('#am-user').textContent = amSigned ? 'Signed in ✅' : 'Not signed in';
    $('#am-create').disabled = !amSigned;
  }catch(e){
    $('#am-user').textContent = 'Sign-in failed';
  }
}
$('#am-sign').onclick = amSignIn;

async function amCreate(){
  if (!amSigned){ await amSignIn(); if(!amSigned) return; }
  $('#am-status').textContent = 'Searching & creating…';

  // 1) create empty library playlist
  const name = `TimeDeck — ${$('#date').value} — ${$('#genre').value}`;
  const desc = 'Generated with TimeDeck.';
  const payload = {
    data: [{
      type: 'library-playlists',
      attributes: { name, description: desc }
    }]
  };
  const pl = await music.api.v1.post('/me/library/playlists', payload);
  const plId = pl?.data?.[0]?.id;
  if (!plId){ $('#am-status').textContent = 'Create playlist failed'; return; }

  // 2) search & collect catalog song IDs in small batches
  const toAdd = [];
  for (const t of lastTracks.slice(0, 100)) { // cap for demo
    const term = `${t.artist} ${t.title}`;
    try{
      const q = await music.api.v1.get('/catalog/us/search', { term, limit: 1, types: 'songs' });
      const song = q?.results?.songs?.data?.[0];
      if (song) toAdd.push({ id: song.id, type: 'songs' });
    }catch(_){}
    if (toAdd.length && toAdd.length % 20 === 0) {
      await music.api.v1.post(`/me/library/playlists/${plId}/tracks`, { data: toAdd.splice(0) });
      $('#am-status').textContent = `Added ${toAdd.length}…`;
    }
  }
  if (toAdd.length){
    await music.api.v1.post(`/me/library/playlists/${plId}/tracks`, { data: toAdd });
  }
  $('#am-status').textContent = `Done! Open Apple Music and look for “${name}”.`;
}
$('#am-create').onclick = amCreate;

/* ---------- Init defaults ---------- */
(function init(){
  // set a nice default date
  $('#date').value = '07/07/2002';
  setTab('yt');
})();
</script>
