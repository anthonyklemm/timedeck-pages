<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TapeDeck Time Machine</title>
<style>
  :root{
    --bg:#0a0f17; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#8b5cf6; --accent2:#22d3ee;
    --br:14px; --shadow:0 12px 48px rgba(2,10,20,.45);
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 600px at 10% -10%, #0e1630 0%, transparent 60%),
                    radial-gradient(700px 400px at 120% 10%, #06101f 0%, transparent 60%), var(--bg);
    color:var(--text); font:16px/1.5 -apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;}
  .wrap{max-width:1100px;margin:40px auto;padding:0 18px}
  .bar{display:flex;align-items:center;gap:14px}
  .logo{width:36px;height:36px;border-radius:12px;background:
        linear-gradient(135deg,#8b5cf6 0%,#22d3ee 55%,#16a34a 120%); display:grid;place-items:center;
        color:white;font-weight:800;box-shadow:var(--shadow)}
  h1{font-size:22px;margin:0}
  .panel{background:rgba(17,24,39,.75);border:1px solid rgba(148,163,184,.12);
          border-radius:18px;padding:16px 16px;box-shadow:var(--shadow)}
  .grid{display:grid;grid-template-columns:1.2fr 1fr 1fr 1fr 1fr auto; gap:12px; align-items:end}
  label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px 2px}
  input,select,button{width:100%;padding:12px 12px;border-radius:12px;border:1px solid rgba(148,163,184,.18);
    background:#0c1422;color:var(--text);outline:none}
  button.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));border:0;font-weight:700}
  .tabs{display:flex;gap:10px;margin:14px 0 8px}
  .tab{padding:9px 14px;border-radius:999px;border:1px solid rgba(148,163,184,.2);
        background:#0c1422;color:var(--text);cursor:pointer}
  .tab.active{background:linear-gradient(135deg,rgba(139,92,246,.25),rgba(34,211,238,.18));border-color:transparent}
  .cols{display:grid;grid-template-columns:1.05fr .95fr; gap:16px}
  .box{min-height:380px}
  iframe{width:100%;height:360px;border:0;border-radius:12px;box-shadow:var(--shadow)}
  .btn{display:inline-block;margin-top:8px;padding:10px 14px;border-radius:12px;border:1px solid rgba(148,163,184,.2);
        background:#0c1422;color:var(--text);text-decoration:none;font-weight:700}
  .list{padding:12px 8px;max-height:420px;overflow:auto}
  .row{display:grid;grid-template-columns:110px 1fr;gap:14px; padding:10px 6px;border-bottom:1px dashed rgba(148,163,184,.12)}
  .ts{font:12px/1.3 ui-monospace,SFMono-Regular,Menlo,monospace;color:var(--muted)}
  .err{color:#fda4af;margin-top:6px}
  .ok{color:#86efac;margin-top:6px}
  .muted{color:var(--muted)}
</style>

<div class="wrap">
  <div class="bar" style="margin-bottom:14px">
    <div class="logo">TD</div>
    <h1>TapeDeck Time Machine</h1>
    <div class="muted" style="margin-left:auto;font-size:12px">Tip: append <code>?api=YOUR_API_URL</code> to use your backend</div>
  </div>

  <div class="panel">
    <div class="grid">
      <div>
        <label>Date</label>
        <input id="date" placeholder="mm/dd/yyyy" value="07/07/2002">
      </div>
      <div>
        <label>Genre</label>
        <select id="genre">
          <option>Alternative</option>
          <option>Hot-100</option>
          <option>Rock</option>
          <option>Country</option>
          <option>R&B/Hip-Hop</option>
          <option>Dance/Electronic</option>
        </select>
      </div>
      <div>
        <label>Hours</label>
        <select id="hours">
          <option>3</option><option selected>4</option><option>6</option><option>12</option>
        </select>
      </div>
      <div>
        <label>Repeat gap (min)</label>
        <input id="gap" type="number" value="90">
      </div>
      <div>
        <label>Seed (opt)</label>
        <input id="seed" placeholder="e.g. 20020707">
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="go" class="primary">Generate</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="yt">YouTube</button>
      <button class="tab" data-tab="am">Apple Music</button>
      <button class="tab" data-tab="sp" disabled title="Coming soon">Spotify</button>
    </div>

    <div class="cols">
      <div class="panel box" id="pane-yt">
        <div id="ytWrap">
          <div class="muted" id="ytStatus">Waiting for a simulation…</div>
          <iframe id="ytp" allow="autoplay; encrypted-media" allowfullscreen style="display:none"></iframe>
          <a class="btn" id="ytOpen" href="#" target="_blank" rel="noopener" style="display:none">Open in YouTube</a>
          <div id="ytErr" class="err"></div>
        </div>
      </div>

      <div class="panel box" id="pane-am" style="display:none">
        <div id="amWrap">
          <div class="muted" style="margin-bottom:8px">Sign in with Apple Music to create a playlist from the simulation.</div>
          <button class="btn" id="amSign">Sign in to Apple Music</button>
          <button class="btn" id="amCreate" style="display:none">Create Playlist</button>
          <div id="amMsg" class="muted" style="margin-top:8px"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="panel" style="margin-top:16px">
    <div class="muted" style="margin-bottom:6px">Tracklist will appear here.</div>
    <div id="list" class="list"></div>
  </div>
</div>

<script>
  // ======= helpers =======
  const API = new URLSearchParams(location.search).get('api') || 'https://timedeck-api.onrender.com';
  const qs = sel => document.querySelector(sel);

  function toISO(mmddyyyy){
    const [mm,dd,yyyy] = mmddyyyy.split('/');
    return `${yyyy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}`;
  }

  function setTab(id){
    document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
    qs('#pane-yt').style.display = id==='yt' ? '' : 'none';
    qs('#pane-am').style.display = id==='am' ? '' : 'none';
  }
  document.querySelectorAll('.tab').forEach(b=>b.onclick=()=>setTab(b.dataset.tab));

  // ======= simulate -> render list -> build YouTube =======
  let lastTracks = [];

  async function simulate(){
    const body = {
      date: toISO(qs('#date').value.trim()),
      genre: qs('#genre').value,
      hours: Number(qs('#hours').value || 3),
      repeat_gap_min: Number(qs('#gap').value || 90),
      seed: (qs('#seed').value.trim() || undefined) ? String(qs('#seed').value.trim()) : undefined,
      limit: 500
    };

    // UI state
    qs('#ytStatus').textContent = 'Building…';
    qs('#ytErr').textContent = '';
    qs('#ytp').style.display = 'none';
    qs('#ytOpen').style.display = 'none';
    qs('#list').innerHTML = '';

    // call simulate
    let data;
    try{
      const r = await fetch(`${API}/v1/simulate`, {
        method:'POST', headers:{'content-type':'application/json'},
        body: JSON.stringify(body)
      });
      if(!r.ok){
        const txt = await r.text();
        throw new Error(`simulate ${r.status}: ${txt}`);
      }
      data = await r.json();
    }catch(err){
      qs('#ytStatus').textContent = '';
      qs('#ytErr').textContent = err.message;
      console.error(err);
      return;
    }

    lastTracks = data.tracks || [];
    renderList(lastTracks);
    buildYouTube(lastTracks);
  }

  function renderList(rows){
    if(!rows?.length){ qs('#list').innerHTML = '<div class="muted">No tracks.</div>'; return; }
    const frag = document.createDocumentFragment();
    rows.slice(0,500).forEach(t=>{
      const d = document.createElement('div');
      d.className='row';
      d.innerHTML = `<div class="ts">${t.timestamp.replace('T',' ')}</div>
                      <div><strong>${t.artist}</strong> — <em>${t.title}</em> 
                      <span class="muted">• ${t.source_rank ?? ''}</span></div>`;
      frag.appendChild(d);
    });
    qs('#list').innerHTML = '';
    qs('#list').appendChild(frag);
  }

  // ======= YouTube mini-player =======
  // loads the iFrame API
  (function(){
    const tag=document.createElement('script'); tag.src="https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);
  })();

  let YTready = false, player = null, pendingPlaylist = null; // Added pendingPlaylist
  
  // New onPlayerReady function
  function onPlayerReady(event) {
    YTready = true;
    // Now that we're ready, check if a playlist was generated while we were loading.
    if (pendingPlaylist) {
      player.cuePlaylist(pendingPlaylist, 0, 0);
      qs('#ytp').style.display = 'block';
      qs('#ytStatus').textContent = `${pendingPlaylist.length} videos queued`;
      pendingPlaylist = null; // Clear it after loading
    }
  }

  // Modified onYouTubeIframeAPIReady to use onPlayerReady event
  window.onYouTubeIframeAPIReady = () => {
    player = new YT.Player('ytp', {
      playerVars: { playsinline: 1, rel: 0, modestbranding: 1 },
      events: {
        'onReady': onPlayerReady // Tell the player to call our function when it's ready
      }
    });
  };

  async function buildYouTube(tracks){
    qs('#ytStatus').textContent = 'Resolving YouTube IDs…';
    try{
      const r = await fetch(`${API}/v1/yt/resolve`, {
        method:'POST', headers:{'content-type':'application/json'},
        body: JSON.stringify({ tracks: tracks.map(t=>({artist:t.artist,title:t.title})), region:'US', limit:50 })
      });
      if(!r.ok){
        const txt = await r.text();
        throw new Error(`yt/resolve ${r.status}: ${txt}`);
      }
      const data = await r.json();
      const ids = (data.ids || []).filter(Boolean);
      if(!ids.length){
        qs('#ytStatus').textContent = 'No playable videos found (try another date/genre).';
        return;
      }
      // cue playlist (no autoplay) and show "Open in YouTube"
      const openUrl = `https://www.youtube.com/watch_videos?video_ids=${ids.join(',')}`;
      qs('#ytOpen').href = openUrl;
      qs('#ytOpen').style.display = 'inline-block';

      // Modified logic to handle player readiness
      if (YTready && player) {
        // Player is already ready, load the playlist now.
        qs('#ytp').style.display = 'block';
        player.cuePlaylist(ids, 0, 0);
        qs('#ytStatus').textContent = `${ids.length} videos queued`;
      } else {
        // Player is not ready yet, store these IDs.
        // The onPlayerReady function will load them when it fires.
        pendingPlaylist = ids;
        qs('#ytStatus').textContent = 'Player loading, queuing videos...';
      }
    }catch(err){
      qs('#ytErr').textContent = err.message;
      qs('#ytStatus').textContent = '';
      console.error(err);
    }
  }

  // ======= Apple Music =======
  let mkInstance=null, amSignedIn=false;

  async function amSignIn(){
    try{
      const tok = await fetch(`${API}/v1/apple/dev-token`).then(r=>r.json());
      if(!tok || !tok.token) throw new Error('No dev token');
      // load MusicKit JS once
      if(!window.MusicKit){
        await new Promise((res,rej)=>{
          const s=document.createElement('script');
          s.src="https://js-cdn.music.apple.com/musickit/v3/musickit.js";
          s.onload=res; s.onerror=()=>rej(new Error('MusicKit load failed')); document.head.appendChild(s);
        });
      }
      window.MusicKit.configure({
        developerToken: tok.token,
        app: { name: "TapeDeck Time Machine", build: "web" }
      });
      mkInstance = window.MusicKit.getInstance();
      await mkInstance.authorize(); // user signs in
      amSignedIn = true;
      qs('#amMsg').textContent = 'Signed in.';
      qs('#amCreate').style.display = 'inline-block';
    }catch(e){
      amSignedIn=false;
      qs('#amMsg').textContent = 'Sign-in failed: ' + e.message;
      console.error(e);
    }
  }

  async function amCreatePlaylist(){
    if(!amSignedIn || !mkInstance){ qs('#amMsg').textContent='Please sign in first.'; return; }
    if(!lastTracks?.length){ qs('#amMsg').textContent='Generate a tracklist first.'; return; }
    qs('#amMsg').textContent='Creating playlist… (searching tracks)';
    try{
      const name = `TimeDeck — ${qs('#date').value} — ${qs('#genre').value.toLowerCase()}`;
      // create empty playlist
      const pl = await mkInstance.api.v3.post('/me/library/playlists', {
        attributes: { name, description: 'Generated with TapeDeck Time Machine' }
      });
      const playlistId = pl?.data?.data?.[0]?.id;
      if(!playlistId) throw new Error('Failed to create playlist');

      // best-effort search & collect song ids (cap to 75 to be safe)
      const want = lastTracks.slice(0,75);
      const ids = [];
      for(const t of want){
        const q = `${t.artist} ${t.title}`;
        const res = await mkInstance.api.v3.get('/catalog/us/search', { term:q, types:'songs', limit:5 });
        const hit = res?.data?.results?.songs?.data?.find(s =>
          s?.attributes?.artistName?.toLowerCase().includes(t.artist.toLowerCase()) &&
          s?.attributes?.name?.toLowerCase().includes(t.title.toLowerCase())
        ) || res?.data?.results?.songs?.data?.[0];
        if(hit) ids.push({ id: hit.id, type: 'songs' });
        await new Promise(r=>setTimeout(r,120)); // gentle pacing
      }

      if(!ids.length) throw new Error('No Apple Music matches found');
      await mkInstance.api.v3.post(`/me/library/playlists/${playlistId}/tracks`, { data: ids });
      qs('#amMsg').innerHTML = `Playlist created: <strong>${name}</strong> (${ids.length} tracks). Open Music app to view.`;
    }catch(e){
      qs('#amMsg').textContent = 'Create failed: ' + e.message;
      console.error(e);
    }
  }

  // events
  qs('#go').onclick = simulate;
  qs('#amSign').onclick = amSignIn;
  qs('#amCreate').onclick = amCreatePlaylist;

  // init
  setTab('yt');
</script>
</html>