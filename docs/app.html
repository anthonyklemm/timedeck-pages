<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TapeDeck Time Machine</title>

  <!-- MusicKit for web fallback -->
  <script src="https://js-cdn.music.apple.com/musickit/v3/musickit.js"></script>

  <!-- Meta / Icons -->
  <meta name="description" content="Rewind the radio you grew up with. Generate playlists from any date and genre, powered by Billboard chart data.">
  <link rel="icon" href="/logo.svg" type="image/svg+xml">
  <link rel="alternate icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/logo.svg"> <!-- Consider a specific 180x180 PNG -->

  <!-- Social / OG Tags -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://tapedecktimemachine.com/">
  <meta property="og:title" content="TapeDeck Time Machine - Historical Music Playlist Generator">
  <meta property="og:description" content="Rewind the radio you grew up with. Generate playlists from any date and genre, powered by Billboard chart data.">
  <meta property="og:image" content="https://tapedecktimemachine.com/tapedeck-preview.png"> <!-- Use a dedicated preview image -->
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://tapedecktimemachine.com/">
  <meta property="twitter:title" content="TapeDeck Time Machine - Historical Music Playlist Generator">
  <meta property="twitter:description" content="Rewind the radio you grew up with. Generate playlists from any date and genre, powered by Billboard chart data.">
  <meta property="twitter:image" content="https://tapedecktimemachine.com/tapedeck-preview.png">

  <!-- Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HPZT6BMJVD"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-HPZT6BMJVD');
  </script>

  <!-- Styles -->
  <style>
    :root{--bg:#0a0f17;--panel:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#8b5cf6;--accent2:#22d3ee;--shadow:0 12px 48px rgba(2,10,20,.45)}
    *{box-sizing:border-box}
    body{margin:0;background:
      radial-gradient(1200px 600px at 10% -10%, #0e1630 0%, transparent 60%),
      radial-gradient(700px 400px at 120% 10%, #06101f 0%, transparent 60%), #0a0f17;
      color:var(--text); font:16px/1.5 -apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;}
    .wrap{max-width:1100px;margin:40px auto;padding:0 18px}
    .bar{display:flex;align-items:center;gap:14px}
    /* Style for the logo link */
    .bar a { color: inherit; text-decoration: none; display: flex; align-items: center; gap: 14px; }
    .logo{width:36px;height:36px;border-radius:12px;background:
      linear-gradient(135deg,#8b5cf6 0%,#22d3ee 55%,#16a34a 120%); display:grid;place-items:center;
      color:#fff;font-weight:800;box-shadow:var(--shadow); flex-shrink: 0;} /* Added flex-shrink */
    h1{font-size:22px;margin:0}
    .panel{background:rgba(17,24,39,.75);border:1px solid rgba(148,163,184,.12);
      border-radius:18px;padding:16px;box-shadow:var(--shadow)}
    .grid{display:grid;grid-template-columns:1.2fr 1fr 1fr 1fr 1fr auto; gap:12px; align-items:end}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px 2px}
    input,select,button{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(148,163,184,.18);
      background:#0c1422;color:var(--text);outline:none;font-size:1rem}
    button.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));border:0;font-weight:700; cursor: pointer;}
    button:disabled{background:#475569;color:#cbd5e1;cursor:not-allowed}
    .tabs{display:flex;gap:10px;margin:14px 0 8px}
    .tab{padding:9px 14px;border-radius:999px;border:1px solid rgba(148,163,184,.2);
      background:#0c1422;color:var(--text);cursor:pointer}
    .tab.active{background:linear-gradient(135deg,rgba(139,92,246,.25),rgba(34,211,238,.18));border-color:transparent}
    .cols{display:grid;grid-template-columns:1.05fr .95fr; gap:16px}
    .box{min-height:380px}
    iframe{width:100%;height:360px;border:0;border-radius:12px;box-shadow:var(--shadow)}
    .btn{display:inline-block;margin-top:8px;padding:10px 14px;border-radius:12px;border:1px solid rgba(148,163,184,.2);
      background:#0c1422;color:var(--text);text-decoration:none;font-weight:700; cursor: pointer;}
    .list{padding:12px 8px;max-height:420px;overflow:auto}
    .row{display:grid;grid-template-columns:110px 1fr;gap:14px; padding:10px 6px;border-bottom:1px dashed rgba(148,163,184,.12)}
    .ts{font:12px/1.3 ui-monospace,SFMono-Regular,Menlo,monospace;color:var(--muted)}
    .err{color:#fda4af;margin-top:6px; white-space: pre-wrap; word-break: break-all;}
    .ok{color:#86efac;margin-top:6px}
    .muted{color:var(--muted)}
    @media (max-width:800px){.grid{grid-template-columns:1fr 1fr}.grid>div:last-child{grid-column:1/-1}}
    @media (max-width:700px){.wrap{margin:20px auto}.cols{grid-template-columns:1fr}h1{font-size:18px}}
    @media (max-width:500px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>

<div class="wrap">
  <!-- Link added to logo/title -->
  <div class="bar" style="margin-bottom:14px">
    <a href="/">
      <div class="logo">TD</div>
      <h1>TapeDeck Time Machine</h1>
    </a>
  </div>

  <!-- Controls -->
  <div class="panel">
    <div class="grid">
      <div><label>Date</label><input id="date" placeholder="mm/dd/yyyy" value="07/01/2002"></div>
      <div><label>Genre</label>
        <select id="genre">
          <option>Alternative</option><option>Hot-100</option><option>Pop</option>
          <option>Rock</option><option>Country</option><option>R&B/Hip-Hop</option><option>Dance/Electronic</option>
        </select>
      </div>
      <div><label>Hours</label><select id="hours"><option>0.5</option><option selected>1</option><option>2</option><option>3</option></select></div>
      <div><label>Repeat gap (min)</label><input id="gap" type="number" value="90"></div>
      <div><label>Seed (opt)</label><input id="seed" placeholder="e.g. 20020701"></div>
      <div><label>&nbsp;</label><button id="go" class="primary">Generate</button></div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="yt">YouTube</button>
      <button class="tab" data-tab="am">Apple Music</button>
      <button class="tab" data-tab="sp" disabled title="Coming soon">Spotify</button>
    </div>
    <div class="muted" style="margin:-6px 0 8px 2px">Spotify sign-in is under construction. Coming soon!</div>

    <div class="cols">
      <!-- YouTube -->
      <div class="panel box" id="pane-yt">
        <div id="ytWrap">
          <div class="muted" id="ytStatus">Waiting for a simulationâ€¦</div>
          <div id="ytp"></div>
          <a class="btn" id="ytOpen" href="#" target="_blank" rel="noopener" style="display:none">Open in YouTube</a>
          <div id="ytErr" class="err"></div>
        </div>
      </div>

      <!-- Apple Music Pane -->
      <div class="panel box" id="pane-am" style="display:none">
        <div id="amWrap">
          <div class="muted" style="margin-bottom:8px">Sign in with Apple Music to play or create a playlist.</div>
          <button class="btn" id="amSign">Sign in to Apple Music</button>
          <button class="btn" id="amPlay" style="display:none">Play Playlist</button>
          <button class="btn" id="amCreate" style="display:none">Create Playlist</button>
          <div id="amMsg" class="muted" style="margin-top:8px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tracklist -->
  <div class="panel" style="margin-top:16px">
    <h2>Your Music Time Machine Playlist</h2>
    <p class="muted" style="margin-bottom:6px">
      Ever wonder <strong>what songs were popular on your birthday?</strong>
      Just pick a date and genre, and we'll <strong>generate a music playlist</strong>
      of the top songs from that week, based on <strong>historical Billboard charts</strong>.
      The tracklist will appear below.
    </p>
    <div id="list" class="list"></div>
  </div>
</div>

<script>
  // ---------- config & helpers ----------
  const qs = s => document.querySelector(s);

  const API = new URLSearchParams(location.search).get('api') || 'https://timedeck-api.onrender.com';
  const NET_TIMEOUT_MS = 180000; // 3 minutes
  const NATIVE_HOST = 'https://tapedecktimemachine.com';

  function toISO(mmddyyyy){
    try {
      const parts = mmddyyyy.split('/');
      if (parts.length !== 3) throw new Error('Invalid date format');
      const [mm,dd,yyyy] = parts.map(p => p.trim());
      if (yyyy.length !== 4 || isNaN(parseInt(yyyy))) throw new Error('Invalid year format');
      return `${yyyy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}`;
    } catch (e) {
      console.error("Date parsing error:", e);
      qs('#ytErr').textContent = `Invalid date format. Please use MM/DD/YYYY.`;
      throw e;
    }
  }

  function setTab(id){
    document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
    qs('#pane-yt').style.display = id==='yt' ? '' : 'none';
    qs('#pane-am').style.display = id==='am' ? '' : 'none';
  }
  document.querySelectorAll('.tab').forEach(b=>b.onclick=()=>setTab(b.dataset.tab));

  function withTimeout(promise, ms = NET_TIMEOUT_MS) {
    let t; const timer = new Promise((_, rej)=>{ t=setTimeout(()=>rej(new Error(`Network timeout after ${Math.round(ms/1000)}s`)), ms); });
    return Promise.race([promise.finally(()=>clearTimeout(t)), timer]);
  }

  // ---------- state ----------
  let lastTracks = [];

  // ---------- YouTube globals ----------
  let player = null;
  let YTapiReady = false;

  // ---------- simulate + list ----------
  async function simulate(){
    qs('#go').disabled = true;
    qs('#ytStatus').textContent = 'Buildingâ€¦';
    qs('#ytErr').textContent = '';
    qs('#list').innerHTML = '';
    lastTracks = [];

    if (player) { try{ player.destroy(); }catch{} player = null; }
    qs('#ytp').innerHTML = '';
    qs('#ytp').style.display = 'none';
    qs('#ytOpen').style.display = 'none';

    try{
      const body = {
        date: toISO(qs('#date').value.trim()),
        genre: qs('#genre').value,
        hours: Number(qs('#hours').value || 3),
        repeat_gap_min: Number(qs('#gap').value || 90),
        seed: (qs('#seed').value.trim() || undefined) ? String(qs('#seed').value.trim()) : undefined,
        limit: 500
      };

      const r = await withTimeout(fetch(`${API}/v1/simulate`, {
        method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body)
      }));
      if(!r.ok){ const txt = await r.text().catch(()=> ''); throw new Error(`simulate ${r.status}: ${txt}`); }
      const data = await r.json();
      lastTracks = data.tracks || [];
      if(!lastTracks.length){ qs('#ytStatus').textContent=''; qs('#ytErr').textContent='No tracks returned. Try a different date/genre.'; return; }
      renderList(lastTracks);
      buildYouTube(lastTracks);
    }catch(err){
      console.error('[simulate] failed:', err);
      if (!qs('#ytErr').textContent) {
          qs('#ytErr').textContent = err.message || String(err);
      }
      qs('#ytStatus').textContent = '';
    } finally {
      qs('#go').disabled = false;
    }
  }

  function renderList(rows){
    if(!rows?.length){ qs('#list').innerHTML = '<div class="muted">No tracks.</div>'; return; }
    const frag = document.createDocumentFragment();
    rows.slice(0,500).forEach(t=>{
      const d = document.createElement('div'); d.className='row';
      d.innerHTML = `<div class="ts">${t.timestamp.replace('T',' ')}</div>
                     <div><strong>${t.artist}</strong> â€” <em>${t.title}</em>
                     <span class="muted">â€¢ ${t.source_rank ?? ''}</span></div>`;
      frag.appendChild(d);
    });
    qs('#list').replaceChildren(frag);
  }

  // ---------- YouTube mini-player ----------
  (function(){ const tag=document.createElement('script'); tag.src="https://www.youtube.com/iframe_api"; document.head.appendChild(tag); })();
  window.onYouTubeIframeAPIReady = () => { YTapiReady = true; console.log("YT API Ready"); };

  async function buildYouTube(tracks){
    qs('#ytStatus').textContent = 'Resolving YouTube IDsâ€¦';
    qs('#ytErr').textContent = '';
    try{
      const r = await withTimeout(fetch(`${API}/v1/yt/resolve`, {
        method:'POST', headers:{'content-type':'application/json'},
        body: JSON.stringify({ tracks: tracks.map(t=>({artist:t.artist,title:t.title})), limit:50 })
      }));
      if(!r.ok){ throw new Error(`yt/resolve ${r.status}: ${await r.text()}`); }
      const data = await r.json();
      const ids = (data.ids || []).filter(Boolean);

      if(!ids.length){ qs('#ytStatus').textContent = 'No playable videos found (try another date/genre).'; return; }

      const openUrl = `https://www.youtube.com/watch_videos?video_ids=${ids.join(',')}`;
      qs('#ytOpen').href = openUrl;
      qs('#ytOpen').style.display = 'inline-block';
      qs('#ytStatus').textContent = `${ids.length} videos found. Loading player...`;

      if (player) {
        try{ player.cuePlaylist(ids, 0, 0); qs('#ytStatus').textContent = `${ids.length} videos queued.`; }
        catch(e) { console.error("YT cuePlaylist failed:", e); player = null; }
      }
      if (!player) {
        if (YTapiReady && qs('.tab[data-tab="yt"]').classList.contains('active')) {
          console.log("YT: Creating new player instance...");
          qs('#ytp').style.display = 'block';
          player = new YT.Player('ytp', {
            height: '360', width: '100%',
            playerVars: { playsinline: 1, rel: 0, modestbranding: 1, origin: location.origin },
            events: {
              onReady: (e) => {
                console.log("YT Player Ready, cueing playlist...");
                try {
                  e.target.cuePlaylist(ids, 0, 0);
                  qs('#ytStatus').textContent = `${ids.length} videos queued.`;
                } catch (cueError) {
                  console.error("YT cuePlaylist in onReady failed:", cueError);
                  qs('#ytStatus').textContent = 'Error loading videos into player.';
                  qs('#ytErr').textContent = cueError.message || String(cueError);
                }
              },
              onError: (e) => {
                console.error("YT Player Error:", e.data);
                qs('#ytErr').textContent = `Youtubeer Error: ${e.data}`; // Typo fixed
              }
            }
          });
        } else if (!YTapiReady) {
          qs('#ytStatus').textContent = 'YouTube API is still loading. Use "Open in YouTube".';
        } else {
          qs('#ytStatus').textContent = `${ids.length} videos ready. Switch to YouTube tab to play.`;
        }
      }
    }catch(err){
      console.error("[buildYouTube] failed:", err);
      qs('#ytErr').textContent = err.message || String(err);
      qs('#ytStatus').textContent = '';
    }
  }

  // ---------- Universal Link / custom-scheme listener (native) ----------
  (function(){
    const Cap = window.Capacitor || {};
    const App = Cap.Plugins && Cap.Plugins.App;

    function parseQuery(u){
      const i = u.indexOf('?'); if (i < 0) return {};
      const q = u.slice(i+1).split('&'); const out = {};
      for (const p of q) { const [k,v] = p.split('='); out[decodeURIComponent(k)] = decodeURIComponent(v||''); }
      return out;
    }

    if (App && App.addListener) {
      App.addListener('appUrlOpen', ({ url }) => {
        console.log('[appUrlOpen]', url);
        if (!url || !url.startsWith('com.tapedecktimemachine.app://auth/callback')) return;
        const q = parseQuery(url);
        if (q.token) {
          localStorage.setItem('appleMusicUserToken', q.token);
          qs('#amSign').style.display = 'none';
          qs('#amPlay').style.display = 'inline-block';
          qs('#amCreate').style.display = 'inline-block';
          qs('#amMsg').textContent = 'Signed in. Generate a list to play or create.';
          // Attempt to get instance now that we have a token from native
          getMusicInstance().catch(e => console.warn("[AM Init BG after native auth]", e));
        } else {
           console.warn('[appUrlOpen] Received callback without token:', url);
           qs('#amMsg').textContent = 'Sign-in callback received, but no token found.';
        }
      });
      console.log('[AM] appUrlOpen listener attached');
    } else {
      console.warn('[AM] Capacitor App plugin not available for appUrlOpen listener.');
    }
  })();

  // ---------- MusicKit Initialization (NEW APPROACH) ----------
  let musicInstance = null; // Holds the ready instance
  let musicInstancePromise = null; // Tracks the initialization promise

  function waitForMusicKitLoaded(timeoutMs = 15000) {
    if (window.MusicKit && typeof window.MusicKit.configure === 'function') return Promise.resolve();
    return new Promise((resolve, reject) => {
      console.log('[AM Wait] Waiting for MusicKit script load...');
      const t = setTimeout(() => { console.error('[AM Wait] MusicKit load timed out.'); reject(new Error('MusicKit load timed out')); }, timeoutMs);
      window.addEventListener('musickitloaded', () => { console.log('[AM Wait] MusicKit script loaded.'); clearTimeout(t); resolve(); }, { once: true });
    });
  }

  // Function to configure and get instance ONCE
  async function configureAndGetInstance() {
    await waitForMusicKitLoaded();

    console.log('[AM Configure] Fetching dev token...');
    const r = await withTimeout(fetch(`${API}/v1/apple/dev-token`));
    if (!r.ok) throw new Error(`dev-token ${r.status}`);
    const { token: developerToken, storefront: apiStorefront } = await r.json();
    if (!developerToken || typeof developerToken !== 'string') {
      throw new Error('No valid developer token.');
    }

    console.log('[AM Configure] Configuring MusicKit...');
    window.MusicKit.configure({
      developerToken: developerToken.trim(),
      app: { name: 'TapeDeck Time Machine', build: 'web' }
    });

    console.log('[AM Configure] Getting instance...');
    const instance = window.MusicKit.getInstance();
    if (!instance) {
        // Add a small delay and retry getInstance once if it fails initially
        await new Promise(res => setTimeout(res, 300));
        instance = window.MusicKit.getInstance();
        if (!instance) throw new Error('MusicKit instance failed after configure and delay.');
    }

    console.log('[AM Configure] Instance obtained. Applying stored token if needed.');
    // Apply stored token if instance doesn't have one
    const storedToken = localStorage.getItem('appleMusicUserToken');
    if (storedToken && !instance.musicUserToken) {
      instance.musicUserToken = storedToken;
      console.log('[AM Configure] Applied stored user token.');
    }

    // Set storefront (best effort)
    instance.storefrontId = apiStorefront || 'us';
    console.log('[AM Configure] Storefront set to:', instance.storefrontId);
    // Asynchronously try to confirm/update storefront from API in background
    instance.api.storefront().then(sf => {
        const confirmedSf = sf?.data?.[0]?.id;
        if (confirmedSf && confirmedSf !== instance.storefrontId) {
            console.log(`[AM Configure] Updated storefront from ${instance.storefrontId} to ${confirmedSf}`);
            instance.storefrontId = confirmedSf;
        }
    }).catch(e => console.warn('[AM Configure] Background storefront fetch failed:', e));

    return instance; // Return the configured instance
  }

  // Gets the instance, initializing it only the first time
  function getMusicInstance() {
    if (musicInstance) return Promise.resolve(musicInstance); // Return cached instance
    if (!musicInstancePromise) {
      // Start initialization only if it hasn't started yet
      musicInstancePromise = configureAndGetInstance()
        .then(instance => {
          musicInstance = instance; // Cache the instance on success
          console.log('[AM GetInstance] Initialization successful.');
          return instance;
        })
        .catch(e => {
          console.error('[AM GetInstance] Initialization failed:', e);
          musicInstancePromise = null; // Reset promise on failure
          throw e; // Re-throw error
        });
    }
    return musicInstancePromise; // Return the ongoing promise
  }

  // --- End MusicKit Initialization ---


  // ---------- Native-first sign-in (Browser.open) ----------
  async function amSignIn(){
    const Cap = window.Capacitor || {};
    const Plugins = (Cap && Cap.Plugins) || {};
    const Browser = Plugins.Browser;
    qs('#amMsg').textContent = ''; // Clear previous messages

    if (Browser && typeof Browser.open === 'function') {
      const url = `${NATIVE_HOST}/auth/native/?native=1&v=5`;
      console.log('[AM] Native SFSafariViewController â†’', url);
      qs('#amMsg').textContent = 'Opening Apple sign-inâ€¦';
      try {
        await Browser.open({ url, presentationStyle: 'fullscreen' });
      } catch (e) {
        console.error('[AM] Browser.open failed:', e);
        qs('#amMsg').textContent = 'Failed to open sign-in window: ' + (e.message || e);
      }
      return;
    }

    // Website fallback - Uses the new getMusicInstance
    try {
      console.log('[AM] Web Fallback â†’ MusicKit.authorize()');
      qs('#amMsg').textContent = 'Contacting Appleâ€¦';
      const m = await getMusicInstance(); // Get or initialize instance
      const userToken = await m.authorize(); // Authorize
      if (!userToken) throw new Error('Authorization failed (user cancelled?)');

      localStorage.setItem('appleMusicUserToken', userToken);
      m.musicUserToken = userToken; // Apply token to current instance

      qs('#amMsg').textContent = 'Signed in. Generate a list to play or create.';
      qs('#amSign').style.display = 'none';
      qs('#amPlay').style.display = 'inline-block';
      qs('#amCreate').style.display = 'inline-block';
    } catch(e){
      console.error('[AM] Web fallback failed:', e);
      qs('#amMsg').textContent = 'Sign-in failed: ' + (e.message || e);
    }
  }

  // ---------- Play Playlist in Apple Music ----------
  async function amPlayPlaylist() {
    qs('#amMsg').textContent = '';
    let m; // Use 'm' consistent with sign-in

    try {
      console.log('[AM Play] Getting MusicKit instance...');
      m = await getMusicInstance(); // Get or initialize instance

      if (!m.isAuthorized) {
        console.log('[AM Play] Not authorized, attempting authorize...');
        qs('#amMsg').textContent = 'Authorizing...';
        try {
          // Listen for the status change event *before* calling authorize
          const authPromise = new Promise((resolve, reject) => {
             const listener = (event) => {
                 console.log('[AM Play] Auth status changed:', event.authorizationStatus);
                 // Check if authorized or denied/restricted
                 if (event.authorizationStatus === 'authorized') {
                     resolve(m.musicUserToken); // Resolve with the token
                 } else if (event.authorizationStatus === 'denied' || event.authorizationStatus === 'restricted') {
                     reject(new Error('User denied or restricted authorization'));
                 }
                 // Remove listener once status changes (or after timeout)
                 m.removeEventListener('authorizationStatusDidChange', listener);
             };
             m.addEventListener('authorizationStatusDidChange', listener);
             // Timeout for the listener
             setTimeout(() => {
                 m.removeEventListener('authorizationStatusDidChange', listener);
                 reject(new Error('Authorization status did not change in time.'));
             }, 15000); // 15 second timeout

             // Now trigger the authorization popup
             m.authorize().catch(reject); // Catch immediate errors from authorize itself
          });

          const tok = await authPromise; // Wait for the event or timeout/error
          if (!tok) throw new Error('Authorization failed or timed out.');

          localStorage.setItem('appleMusicUserToken', tok);
          m.musicUserToken = tok; // Apply token
          console.log('[AM Play] Authorization successful via event.');

        } catch (authErr) {
          console.error('[AM Play] Authorization failed:', authErr);
          qs('#amMsg').textContent = 'Sign-in needed or failed: ' + (authErr.message || authErr);
          return;
        }
      }

      // Final check for readiness after potentially complex auth flow
      if (!m || !m.isAuthorized || !m.api || typeof m.api.search !== 'function') {
        console.error('[AM Play] Instance lacks .api.search after all checks.');
        throw new Error('MusicKit API not ready after auth attempt.');
      }
      console.log('[AM Play] Instance ready for search with storefront:', m.storefrontId || 'us');

    } catch (e) {
      console.error('[AM Play] init/auth failed:', e);
      qs('#amMsg').textContent = 'Apple Music connection not ready. Please try signing in again.';
      localStorage.removeItem('appleMusicUserToken');
      qs('#amSign').style.display = 'inline-block';
      qs('#amPlay').style.display = 'none';
      qs('#amCreate').style.display = 'none';
      return;
    }

    if (!lastTracks?.length) {
      qs('#amMsg').textContent = 'Generate a tracklist first.';
      return;
    }

    // --- Search logic remains the same ---
    qs('#amMsg').textContent = `Searching for ${lastTracks.length} tracks...`;
    const songIds = [];
    let i = 0;
    const storefront = m.storefrontId || 'us';

    for (const t of lastTracks) {
      i++;
      if (i % 5 === 0 || i === lastTracks.length) {
        qs('#amMsg').textContent = `Searching... (${i}/${lastTracks.length})`;
      }
      try {
        const term = `${t.artist} ${t.title}`;
        const res = await withTimeout(
            m.api.search(term, { types: ['songs'], limit: 1, storefront: storefront }),
            10000 // 10 second timeout per search
        );
        const id = res?.songs?.data?.[0]?.id;
        if (id) {
            songIds.push(id);
        } else {
             console.warn(`[AM Play] Track not found in ${storefront}: ${term}`);
        }
        await new Promise(r => setTimeout(r, 150)); // Keep delay
      } catch (e) {
        console.warn(`[AM Play] search failed for "${t.artist} - ${t.title}":`, e);
      }
    }

    if (!songIds.length) {
      qs('#amMsg').textContent = 'None of the tracks could be found in Apple Music.';
      return;
    }

    qs('#amMsg').textContent = `Found ${songIds.length} tracks. Adding to queue...`;
    try {
      await m.setQueue({ songs: songIds });
      await m.play();
      qs('#amMsg').textContent = `Now playing ${songIds.length} tracks!`;
    } catch (e) {
      console.error('[AM Play] playback:', e);
      qs('#amMsg').textContent = 'Error starting playback: ' + (e.message || e);
    }
  }

  // ---------- Create playlist (shared) ----------
  async function amCreatePlaylist(){
    const userToken = localStorage.getItem('appleMusicUserToken');
    if(!userToken){ qs('#amMsg').textContent='Please sign in first.'; return; }
    if(!lastTracks?.length){ qs('#amMsg').textContent='Generate a tracklist first.'; return; }

    qs('#amMsg').textContent='Creating playlistâ€¦';
    try{
      const name = `TimeDeck â€” ${qs('#date').value} â€” ${qs('#genre').value.toLowerCase()}`;
      const r = await withTimeout(fetch(`${API}/v1/apple/create-playlist`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userToken, name, tracks: lastTracks.map(t=>({artist:t.artist,title:t.title})) })
      }));
      if(!r.ok){
        const j = await r.json().catch(() => ({ detail: 'Unknown error during create' }));
        throw new Error(j.detail || `Create failed with status ${r.status}`);
      }
      const j = await r.json();
      qs('#amMsg').textContent = `Playlist created! Added ${j.added_count} of ${j.total_tracks} tracks.`;
    } catch(e){
      console.error('[AM Create] Failed:', e);
      qs('#amMsg').textContent = 'Create failed: ' + (e.message || String(e));
    }
  }

  // ---------- Check initial signed-in state ----------
  (function(){
    const storedToken = localStorage.getItem('appleMusicUserToken');
    if (storedToken) {
      qs('#amSign').style.display = 'none';
      qs('#amPlay').style.display = 'inline-block';
      qs('#amCreate').style.display = 'inline-block';
      qs('#amMsg').textContent = 'Signed in. Generate a list to play or create.';
      // Try to initialize silently on load
      getMusicInstance().catch(e => console.warn("[AM Init BG]", e));
    }
  })();

  // ---------- wire up ----------
  qs('#go').onclick = simulate;
  qs('#amSign').onclick = amSignIn;
  qs('#amPlay').onclick = amPlayPlaylist;
  qs('#amCreate').onclick = amCreatePlaylist;

  setTab('yt');
</script>

</body>
</html>

