<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TapeDeck Time Machine</title>

  <!-- MusicKit JS (needed for sign-in and for creating the playlist via your backend) -->
  <script src="https://js-cdn.music.apple.com/musickit/v3/musickit.js"></script>

  <!-- Meta / Social -->
  <meta name="description" content="Rewind the radio you grew up with. Generate playlists from any date and genre, powered by Billboard chart data.">
  <link rel="icon" href="/logo.svg" type="image/svg+xml"><!-- no favicon.ico until you add one -->
  <link rel="apple-touch-icon" href="/logo.svg">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://tapedecktimemachine.com/">
  <meta property="og:title" content="TapeDeck Time Machine - Historical Music Playlist Generator">
  <meta property="og:description" content="Rewind the radio you grew up with. Generate playlists from any date and genre.">
  <meta property="og:image" content="https://tapedecktimemachine.com/tapedeck-preview.png">
  <meta property="og:image:width" content="1200"><meta property="og:image:height" content="630">
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://tapedecktimemachine.com/">
  <meta property="twitter:title" content="TapeDeck Time Machine - Historical Music Playlist Generator">
  <meta property="twitter:description" content="Rewind the radio you grew up with. Generate playlists from any date and genre.">
  <meta property="twitter:image" content="https://tapedecktimemachine.com/tapedeck-preview.png">

  <!-- GA -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HPZT6BMJVD"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-HPZT6BMJVD');
  </script>

  <style>
    :root{
      --bg:#0a0f17;--panel:#111827;--muted:#94a3b8;--text:#e5e7eb;
      --accent:#8b5cf6;--accent2:#22d3ee;--shadow:0 12px 48px rgba(2,10,20,.45)
    }
    *{box-sizing:border-box}
    body{margin:0;background:
      radial-gradient(1200px 600px at 10% -10%, #0e1630 0%, transparent 60%),
      radial-gradient(700px 400px at 120% 10%, #06101f 0%, transparent 60%), #0a0f17;
      color:var(--text); font:16px/1.5 -apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;}
    .wrap{max-width:1100px;margin:40px auto;padding:0 18px}
    .bar{display:flex;align-items:center;gap:14px}
    .logo{width:36px;height:36px;border-radius:12px;background:
      linear-gradient(135deg,#8b5cf6 0%,#22d3ee 55%,#16a34a 120%);
      display:grid;place-items:center;color:#fff;font-weight:800;box-shadow:var(--shadow);text-decoration:none}
    h1{font-size:22px;margin:0}
    .panel{background:rgba(17,24,39,.75);border:1px solid rgba(148,163,184,.12);
      border-radius:18px;padding:16px;box-shadow:var(--shadow)}
    .grid{display:grid;grid-template-columns:1.2fr 1fr 1fr 1fr 1fr auto; gap:12px; align-items:end}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px 2px}
    input,select,button{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(148,163,184,.18);
      background:#0c1422;color:var(--text);outline:none;font-size:1rem}
    button.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));border:0;font-weight:700;cursor:pointer}
    .tabs{display:flex;gap:10px;margin:14px 0 8px}
    .tab{padding:9px 14px;border-radius:999px;border:1px solid rgba(148,163,184,.2);
      background:#0c1422;color:var(--text);cursor:pointer}
    .tab.active{background:linear-gradient(135deg,rgba(139,92,246,.25),rgba(34,211,238,.18));border-color:transparent}
    .cols{display:grid;grid-template-columns:1.05fr .95fr; gap:16px}
    .box{min-height:380px}
    iframe{width:100%;height:360px;border:0;border-radius:12px;box-shadow:var(--shadow)}
    .btn{display:inline-block;margin-top:8px;padding:10px 14px;border-radius:12px;border:1px solid rgba(148,163,184,.2);
      background:#0c1422;color:#e5e7eb;text-decoration:none;font-weight:700;cursor:pointer}
    .muted{color:var(--muted)}
    .list{padding:12px 8px;max-height:420px;overflow:auto}
    .row{display:grid;grid-template-columns:110px 1fr;gap:14px; padding:10px 6px;border-bottom:1px dashed rgba(148,163,184,.12)}
    .ts{font:12px/1.3 ui-monospace,SFMono-Regular,Menlo,monospace;color:var(--muted)}
    .err{color:#fda4af;margin-top:6px}
    .ok{color:#86efac;margin-top:6px}

    /* Embed panel */
    .embedWrap{display:none;margin-top:12px}
    .embedBar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:8px}
    .linkRow{display:flex;gap:10px;flex-wrap:wrap}
  </style>
</head>
<body>

<div class="wrap">
  <div class="bar" style="margin-bottom:14px">
    <a class="logo" href="/" title="Back to home">TD</a>
    <h1>TapeDeck Time Machine</h1>
  </div>

  <div class="panel">
    <div class="grid">
      <div><label>Date</label><input id="date" placeholder="mm/dd/yyyy" value="07/01/2002"></div>
      <div><label>Genre</label>
        <select id="genre">
          <option>Alternative</option><option>Hot-100</option><option>Pop</option>
          <option>Rock</option><option>Country</option><option>R&B/Hip-Hop</option><option>Dance/Electronic</option>
        </select>
      </div>
      <div><label>Hours</label><select id="hours"><option>0.5</option><option selected>1</option><option>2</option><option>3</option></select></div>
      <div><label>Repeat gap (min)</label><input id="gap" type="number" value="90"></div>
      <div><label>Seed (opt)</label><input id="seed" placeholder="e.g. 20020701"></div>
      <div><label>&nbsp;</label><button id="go" class="primary">Generate</button></div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="yt">YouTube</button>
      <button class="tab" data-tab="am">Apple Music</button>
      <button class="tab" data-tab="sp" disabled title="Coming soon">Spotify</button>
    </div>
    <div class="muted" style="margin:-6px 0 8px 2px">Spotify sign-in is under construction. Coming soon!</div>

    <div class="cols">
      <div class="panel box" id="pane-yt">
        <div id="ytWrap">
          <div class="muted" id="ytStatus">Waiting for a simulation…</div>
          <div id="ytp"></div>
          <a class="btn" id="ytOpen" href="#" target="_blank" rel="noopener" style="display:none">Open in YouTube</a>
          <div id="ytErr" class="err"></div>
        </div>
      </div>

      <div class="panel box" id="pane-am" style="display:none">
        <div id="amWrap">
          <p class="muted" style="margin-bottom:8px">Generate a list, sign in, create the playlist, then play it below with the official Apple Music embed.</p>
          <div class="linkRow">
            <button class="btn" id="amSign">Sign in to Apple Music</button>
            <button class="btn" id="amCreate" style="display:none">Create Playlist</button>
            <button class="btn" id="amPlayEmbed" style="display:none">Play in Apple Embed</button>
          </div>
          <div id="amMsg" class="muted" style="margin-top:8px"></div>

          <!-- Official Apple Music Embed -->
          <div id="embedWrap" class="embedWrap">
            <div class="embedBar">
              <div class="muted">Apple Music Player</div>
              <div class="linkRow">
                <a id="openInAm" class="btn" href="#" target="_blank" rel="noopener">Open in Apple Music ↗</a>
                <button id="copyLink" class="btn">Copy Link</button>
              </div>
            </div>
            <iframe id="amEmbed" allow="autoplay *; encrypted-media *;" loading="lazy"></iframe>
            <div id="embedNote" class="muted" style="margin-top:8px;display:none"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="panel" style="margin-top:16px">
    <h2>Your Music Time Machine Playlist</h2>
    <p class="muted" style="margin-bottom:6px">
      Ever wonder <strong>what songs were popular on your birthday?</strong>
      Just pick a date and genre, and we'll <strong>generate a music playlist</strong>
      of the top songs from that week, based on <strong>historical Billboard charts</strong>.
      The tracklist will appear below.
    </p>
    <div id="list" class="list"></div>
  </div>
</div>

<script>
  // ---------- helpers / config ----------
  const qs = s => document.querySelector(s);
  const API = new URLSearchParams(location.search).get('api') || 'https://timedeck-api.onrender.com';
  const NET_TIMEOUT_MS = 180000;
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  function toISO(mmddyyyy){ const [mm,dd,yyyy] = mmddyyyy.split('/'); return `${yyyy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}`; }
  function setTab(id){
    document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
    qs('#pane-yt').style.display = id==='yt' ? '' : 'none';
    qs('#pane-am').style.display = id==='am' ? '' : 'none';
  }
  document.querySelectorAll('.tab').forEach(b=>b.onclick=()=>setTab(b.dataset.tab));
  function withTimeout(promise, ms = NET_TIMEOUT_MS) {
    let t; const timer = new Promise((_, rej)=>{ t=setTimeout(()=>rej(new Error(`Network timeout after ${Math.round(ms/1000)}s`)), ms); });
    return Promise.race([promise.finally(()=>clearTimeout(t)), timer]);
  }

  // ---------- state ----------
  let lastTracks = [];
  let isAuthorizing = false;
  let DEV_TOKEN = null;

  // ---------- YouTube ----------
  let player = null, YTapiReady = false;
  (function(){ const tag=document.createElement('script'); tag.src="https://www.youtube.com/iframe_api"; document.head.appendChild(tag); })();
  window.onYouTubeIframeAPIReady = () => { YTapiReady = true; };

  async function simulate(){
    const body = {
      date: toISO(qs('#date').value.trim()),
      genre: qs('#genre').value,
      hours: Number(qs('#hours').value || 3),
      repeat_gap_min: Number(qs('#gap').value || 90),
      seed: (qs('#seed').value.trim() || undefined) ? String(qs('#seed').value.trim()) : undefined,
      limit: 500
    };
    qs('#ytStatus').textContent = 'Building…';
    qs('#ytErr').textContent = '';

    if (player) { try{ player.destroy(); }catch{} player = null; }
    qs('#ytp').innerHTML = ''; qs('#ytp').style.display = 'none';
    qs('#ytOpen').style.display = 'none'; qs('#list').innerHTML = '';
    lastTracks = [];

    try{
      const r = await withTimeout(fetch(`${API}/v1/simulate`, {
        method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body)
      }));
      if(!r.ok){ const txt = await r.text().catch(()=> ''); throw new Error(`simulate ${r.status}: ${txt}`); }
      const data = await r.json();
      lastTracks = data.tracks || [];
      if(!lastTracks.length){ qs('#ytStatus').textContent=''; qs('#ytErr').textContent='No tracks returned. Try a different date/genre.'; return; }
      renderList(lastTracks);
      buildYouTube(lastTracks);
    }catch(err){
      qs('#ytStatus').textContent = '';
      qs('#ytErr').textContent = err.message || String(err);
    }
  }

  function renderList(rows){
    if(!rows?.length){ qs('#list').innerHTML = '<div class="muted">No tracks.</div>'; return; }
    const frag = document.createDocumentFragment();
    rows.slice(0,500).forEach(t=>{
      const d = document.createElement('div'); d.className='row';
      d.innerHTML = `<div class="ts">${t.timestamp.replace('T',' ')}</div>
                     <div><strong>${t.artist}</strong> — <em>${t.title}</em>
                     <span class="muted">• ${t.source_rank ?? ''}</span></div>`;
      frag.appendChild(d);
    });
    qs('#list').replaceChildren(frag);
  }

  async function buildYouTube(tracks){
    qs('#ytStatus').textContent = 'Resolving YouTube IDs…';
    try{
      const r = await withTimeout(fetch(`${API}/v1/yt/resolve`, {
        method:'POST', headers:{'content-type':'application/json'},
        body: JSON.stringify({ tracks: tracks.map(t=>({artist:t.artist,title:t.title})), limit:50 })
      }));
      if(!r.ok){ throw new Error(`yt/resolve ${r.status}: ${await r.text()}`); }
      const data = await r.json();
      const ids = (data.ids || []).filter(Boolean);

      if(!ids.length){ qs('#ytStatus').textContent = 'No playable videos found (try another date/genre).'; return; }

      const openUrl = `https://www.youtube.com/watch_videos?video_ids=${ids.join(',')}`;
      qs('#ytOpen').href = openUrl; qs('#ytOpen').style.display = 'inline-block';
      qs('#ytStatus').textContent = `${ids.length} videos found. Loading player...`;

      if (player) {
        try{ player.cuePlaylist(ids, 0, 0); qs('#ytStatus').textContent = `${ids.length} videos queued.`; }
        catch { player = null; }
      }
      if (!player) {
        if (YTapiReady && qs('.tab[data-tab="yt"]').classList.contains('active')) {
          qs('#ytp').style.display = 'block';
          player = new YT.Player('ytp', {
            height: '360', width: '100%',
            playerVars: { playsinline: 1, rel: 0, modestbranding: 1, origin: location.origin },
            events: { onReady: (e) => { e.target.cuePlaylist(ids, 0, 0); qs('#ytStatus').textContent = `${ids.length} videos queued.`; } }
          });
        } else if (!YTapiReady) {
          qs('#ytStatus').textContent = 'YouTube API is still loading. Use "Open in YouTube".';
        } else {
          qs('#ytStatus').textContent = `${ids.length} videos ready. Switch to YouTube tab to play.`;
        }
      }
    }catch(err){
      qs('#ytErr').textContent = err.message; qs('#ytStatus').textContent = '';
    }
  }

  // ---------- MusicKit minimal (for sign-in only) ----------
  let music = null, musicInitPromise = null;

  function waitForMusicKitLoaded(timeoutMs = 10000){
    if (window.MusicKit && typeof window.MusicKit.configure === 'function') return Promise.resolve();
    return new Promise((resolve, reject) => {
      const t = setTimeout(()=>reject(new Error('MusicKit load timed out')), timeoutMs);
      window.addEventListener('musickitloaded', () => { clearTimeout(t); resolve(); }, { once:true });
    });
  }

  async function fetchDeveloperToken() {
    if (DEV_TOKEN) return DEV_TOKEN;
    const r = await withTimeout(fetch(`${API}/v1/apple/dev-token`, { headers: { 'accept':'application/json' } }));
    if (!r.ok) throw new Error(`dev-token ${r.status}`);
    const { token } = await r.json();
    if (!token || typeof token !== 'string' || token.trim().length < 20) throw new Error('Invalid developer token');
    DEV_TOKEN = token.trim();
    return DEV_TOKEN;
  }

  async function getWebMusicInstance(force = false){
    if (music && !force) return music;
    if (!musicInitPromise || force) {
      musicInitPromise = (async () => {
        await waitForMusicKitLoaded();
        const developerToken = await fetchDeveloperToken();
        window.MusicKit.configure({ developerToken, app: { name:'TapeDeck Time Machine', build:'web' } });

        let inst = null;
        for (let i=0;i<40;i++){ try{ inst = window.MusicKit.getInstance(); }catch{} if(inst) break; await sleep(50); }
        if (!inst) throw new Error('MusicKit instance missing');

        const stored = localStorage.getItem('appleMusicUserToken');
        if (stored) inst.musicUserToken = stored;
        music = inst;
        return music;
      })().catch(e=>{ musicInitPromise=null; throw e; });
    }
    return musicInitPromise;
  }

  function showAmControls() {
    qs('#amSign').style.display = 'none';
    qs('#amCreate').style.display = 'inline-block';
    qs('#amPlayEmbed').style.display = localStorage.getItem('applePlaylistUrl') ? 'inline-block' : 'none';
  }

  async function amSignIn(){
    if (isAuthorizing) return;
    isAuthorizing = true;
    try {
      qs('#amMsg').textContent = 'Contacting Apple…';
      let m = await getWebMusicInstance(true);
      const tok = await m.authorize();
      await sleep(150);
      if (!tok || typeof tok !== 'string' || tok.length < 20) {
        qs('#amMsg').textContent = 'Sign-in cancelled or failed. Apple Music subscription required for full playback.';
        return;
      }
      localStorage.setItem('appleMusicUserToken', tok);
      m.musicUserToken = tok;
      await getWebMusicInstance(true);
      qs('#amMsg').textContent = 'Signed in. Now create your playlist.';
      showAmControls();
    } catch(e){
      qs('#amMsg').textContent = 'Sign-in failed: ' + (e.message || e);
    } finally { isAuthorizing = false; }
  }

  // ---------- Create playlist via backend, then embed ----------
  function deriveEmbedFromUrl(url) {
    try {
      const u = new URL(url);
      if (!/music\.apple\.com$/.test(u.host)) return null;
      // Turn music.apple.com/... into embed.music.apple.com/...
      return url.replace('://music.apple.com/', '://embed.music.apple.com/');
    } catch { return null; }
  }
  function buildEmbedFromId(id, storefront='us') {
    // Works for public/catalog playlists; may not for private library ones
    return `https://embed.music.apple.com/${encodeURIComponent(storefront)}/playlist/${encodeURIComponent(id)}`;
  }
  function showEmbed(embedUrl, openUrl){
    const frame = qs('#amEmbed');
    const wrap = qs('#embedWrap');
    const note = qs('#embedNote');
    qs('#openInAm').href = openUrl || embedUrl;
    frame.src = embedUrl;
    wrap.style.display = '';
    note.style.display = 'none';
    // After load, if framing is blocked, we’ll still have the Open link as fallback
    frame.addEventListener('error', ()=>{ note.textContent = 'This playlist might not be embeddable. Use “Open in Apple Music”.'; note.style.display='block'; }, { once:true });
  }

  async function amCreatePlaylist(){
    const userToken = localStorage.getItem('appleMusicUserToken');
    if(!userToken){ qs('#amMsg').textContent='Please sign in first.'; return; }
    if(!lastTracks?.length){ qs('#amMsg').textContent='Generate a tracklist first.'; return; }

    qs('#amMsg').textContent='Creating playlist…';
    try{
      const name = `TimeDeck — ${qs('#date').value} — ${qs('#genre').value.toLowerCase()}`;
      const r = await withTimeout(fetch(`${API}/v1/apple/create-playlist`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userToken, name, tracks: lastTracks.map(t=>({artist:t.artist,title:t.title})) })
      }));
      if(!r.ok){
        const j = await r.json().catch(() => ({ detail: 'Unknown error during create' }));
        throw new Error(j.detail || `Create failed with status ${r.status}`);
      }
      const j = await r.json(); // expected shape: { added_count, total_tracks, url?, id?, storefront? }
      const { url, id, storefront } = j || {};

      // Persist for “Play in Apple Embed”
      if (url) localStorage.setItem('applePlaylistUrl', url);
      if (id) localStorage.setItem('applePlaylistId', id);
      if (storefront) localStorage.setItem('applePlaylistStorefront', storefront);

      qs('#amMsg').textContent = `Playlist created! Added ${j.added_count} of ${j.total_tracks} tracks.`;
      qs('#amPlayEmbed').style.display = 'inline-block';

      // Try to embed immediately
      let embedUrl = url ? deriveEmbedFromUrl(url) : null;
      if (!embedUrl && id) embedUrl = buildEmbedFromId(id, storefront || 'us');

      if (embedUrl) {
        showEmbed(embedUrl, url || embedUrl);
      } else {
        // Fallback: just show link
        const open = url || (id ? `https://music.apple.com/${storefront||'us'}/playlist/${encodeURIComponent(id)}` : null);
        if (open) {
          qs('#embedWrap').style.display = '';
          qs('#amEmbed').style.display = 'none';
          qs('#openInAm').href = open;
          qs('#embedNote').textContent = 'Could not render an embed for this playlist. Use “Open in Apple Music”.';
          qs('#embedNote').style.display = 'block';
        }
      }
    } catch(e){
      qs('#amMsg').textContent = 'Create failed: ' + (e.message || String(e));
    }
  }

  function amPlayEmbed(){
    // Use stored info to (re)show the embed
    const url = localStorage.getItem('applePlaylistUrl');
    const id = localStorage.getItem('applePlaylistId');
    const sf = localStorage.getItem('applePlaylistStorefront') || 'us';

    let embedUrl = url ? deriveEmbedFromUrl(url) : null;
    if (!embedUrl && id) embedUrl = buildEmbedFromId(id, sf);
    const openUrl = url || (id ? `https://music.apple.com/${sf}/playlist/${encodeURIComponent(id)}` : '#');

    if (embedUrl) showEmbed(embedUrl, openUrl);
    else {
      qs('#embedWrap').style.display = '';
      qs('#amEmbed').style.display = 'none';
      qs('#openInAm').href = openUrl;
      qs('#embedNote').textContent = 'Could not render an embed for this playlist. Use “Open in Apple Music”.';
      qs('#embedNote').style.display = 'block';
    }
  }

  // Copy link helper
  qs('#copyLink').onclick = async () => {
    const url = qs('#openInAm').href;
    try { await navigator.clipboard.writeText(url); }
    catch {}
  };

  // ---------- initial state ----------
  (function(){
    const storedToken = localStorage.getItem('appleMusicUserToken');
    if (storedToken) {
      qs('#amMsg').textContent = 'Signed in. Now create your playlist.';
      showAmControls();
    }
    const haveSaved = localStorage.getItem('applePlaylistUrl') || localStorage.getItem('applePlaylistId');
    if (haveSaved) { qs('#amPlayEmbed').style.display = 'inline-block'; }
  })();

  // ---------- wire up ----------
  qs('#go').onclick = simulate;
  qs('#amSign').onclick = amSignIn;
  qs('#amCreate').onclick = amCreatePlaylist;
  qs('#amPlayEmbed').onclick = amPlayEmbed;

  // Default tab
  setTab('yt');
</script>

</body>
</html>
