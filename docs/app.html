<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TapeDeck Time Machine</title>

  <!-- MusicKit JS -->
  <script src="https://js-cdn.music.apple.com/musickit/v3/musickit.js"></script>

  <!-- Meta / Social -->
  <meta name="description" content="Rewind the radio you grew up with. Generate playlists from any date and genre, powered by Billboard chart data.">
  <link rel="icon" href="/logo.svg" type="image/svg+xml"><!-- no favicon.ico until you add one -->
  <link rel="apple-touch-icon" href="/logo.svg">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://tapedecktimemachine.com/">
  <meta property="og:title" content="TapeDeck Time Machine - Historical Music Playlist Generator">
  <meta property="og:description" content="Rewind the radio you grew up with. Generate playlists from any date and genre.">
  <meta property="og:image" content="https://tapedecktimemachine.com/tapedeck-preview.png">
  <meta property="og:image:width" content="1200"><meta property="og:image:height" content="630">
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://tapedecktimemachine.com/">
  <meta property="twitter:title" content="TapeDeck Time Machine - Historical Music Playlist Generator">
  <meta property="twitter:description" content="Rewind the radio you grew up with. Generate playlists from any date and genre.">
  <meta property="twitter:image" content="https://tapedecktimemachine.com/tapedeck-preview.png">

  <!-- GA -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HPZT6BMJVD"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-HPZT6BMJVD');
  </script>

  <style>
    :root{
      --bg:#0a0f17;--panel:#111827;--muted:#94a3b8;--text:#e5e7eb;
      --accent:#8b5cf6;--accent2:#22d3ee;--shadow:0 12px 48px rgba(2,10,20,.45)
    }
    *{box-sizing:border-box}
    body{margin:0;background:
      radial-gradient(1200px 600px at 10% -10%, #0e1630 0%, transparent 60%),
      radial-gradient(700px 400px at 120% 10%, #06101f 0%, transparent 60%), #0a0f17;
      color:var(--text); font:16px/1.5 -apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;}
    .wrap{max-width:1100px;margin:40px auto;padding:0 18px}
    .bar{display:flex;align-items:center;gap:14px}
    .bar a { color: inherit; text-decoration: none; display: flex; align-items: center; gap: 14px; }
    .logo{width:36px;height:36px;border-radius:12px;background:
      linear-gradient(135deg,#8b5cf6 0%,#22d3ee 55%,#16a34a 120%);
      display:grid;place-items:center;color:#fff;font-weight:800;box-shadow:var(--shadow);text-decoration:none; flex-shrink: 0;}
    h1{font-size:22px;margin:0}
    .panel{background:rgba(17,24,39,.75);border:1px solid rgba(148,163,184,.12);
      border-radius:18px;padding:16px;box-shadow:var(--shadow)}
    .grid{display:grid;grid-template-columns:1.2fr 1fr 1fr 1fr 1fr auto; gap:12px; align-items:end}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px 2px}
    input,select,button{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(148,163,184,.18);
      background:#0c1422;color:var(--text);outline:none;font-size:1rem}
    button.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));border:0;font-weight:700;cursor:pointer}
    button:disabled{background:#475569;color:#cbd5e1;cursor:not-allowed}
    .tabs{display:flex;gap:10px;margin:14px 0 8px}
    .tab{padding:9px 14px;border-radius:999px;border:1px solid rgba(148,163,184,.2);
      background:#0c1422;color:var(--text);cursor:pointer}
    .tab.active{background:linear-gradient(135deg,rgba(139,92,246,.25),rgba(34,211,238,.18));border-color:transparent}
    .cols{display:grid;grid-template-columns:1.05fr .95fr; gap:16px}
    .box{min-height:380px}
    iframe{width:100%;height:360px;border:0;border-radius:12px;box-shadow:var(--shadow)}
    .btn{display:inline-block;margin-top:8px;padding:10px 14px;border-radius:12px;border:1px solid rgba(148,163,184,.2);
      background:#0c1422;color:#e5e7eb;text-decoration:none;font-weight:700;cursor:pointer}
    .btn.inline{padding:8px 10px}
    .btn.ghost{background:transparent}
    .muted{color:var(--muted)}
    .list{padding:12px 8px;max-height:420px;overflow:auto}
    .row{display:grid;grid-template-columns:110px 1fr;gap:14px; padding:10px 6px;border-bottom:1px dashed rgba(148,163,184,.12)}
    .ts{font:12px/1.3 ui-monospace,SFMono-Regular,Menlo,monospace;color:var(--muted)}
    .err{color:#fda4af;margin-top:6px; white-space: pre-wrap; word-break: break-all;}
    .ok{color:#86efac;margin-top:6px}

    /* Mini-player */
    .mini{display:none;margin-top:12px;background:rgba(12,20,34,.8);border:1px solid rgba(148,163,184,.12);border-radius:14px;padding:10px}
    .mini .row1{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
    .mini .art{width:44px;height:44px;border-radius:10px;background:#0c1422;object-fit:cover; flex-shrink: 0;}
    .mini .meta{min-width:0} /* Allow text to shrink */
    .mini .title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .mini .artist{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .mini .controls{display:flex;gap:6px;align-items:center; flex-shrink: 0;}
    .mini .controls .btn{padding:6px 10px}
    .mini .row2{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;margin-top:8px}
    .mini .time{font-size: 11px; font-variant-numeric: tabular-nums; color: var(--muted);} /* Consistent class for times */
    .mini input[type="range"]{width:100%; margin: 0; padding: 0; height: 8px; cursor: pointer; background: transparent; accent-color: var(--accent);} /* Basic range styling */
    /* Input range thumb styling (cross-browser) */
    .mini input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 12px; height: 12px; background: var(--accent2); border-radius: 50%; cursor: pointer; margin-top: -2px; /* Adjust vertical align */}
    .mini input[type=range]::-moz-range-thumb { width: 12px; height: 12px; background: var(--accent2); border-radius: 50%; cursor: pointer; border: none;}

    .mini .row3{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;margin-top:8px}
    .mini .vol{display:flex;align-items:center;gap:8px}
    .mini .vol input[type="range"] { max-width: 80px; height: 6px; } /* Smaller volume slider */
    .mini .vol input[type=range]::-webkit-slider-thumb { margin-top: -3px;} /* Adjust thumb for smaller track */
    .mini .open{font-size:12px; color: var(--muted); text-decoration:none}

    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(148,163,184,.2);border-radius:999px;padding:6px 10px;background:#0c1422}

    @media (max-width:800px){.grid{grid-template-columns:1fr 1fr}.grid>div:last-child{grid-column:1/-1}}
    @media (max-width:700px){.wrap{margin:20px auto}.cols{grid-template-columns:1fr}h1{font-size:18px}}
    @media (max-width:500px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>

<div class="wrap">
  <!-- Link added to logo/title -->
  <div class="bar" style="margin-bottom:14px">
    <a href="/">
      <div class="logo">TD</div>
      <h1>TapeDeck Time Machine</h1>
    </a>
  </div>

  <!-- Controls -->
  <div class="panel">
    <div class="grid">
      <div><label>Date</label><input id="date" placeholder="mm/dd/yyyy" value="07/01/2002"></div>
      <div><label>Genre</label>
        <select id="genre">
          <option>Alternative</option><option>Hot-100</option><option>Pop</option>
          <option>Rock</option><option>Country</option><option>R&B/Hip-Hop</option><option>Dance/Electronic</option>
        </select>
      </div>
      <div><label>Hours</label><select id="hours"><option>0.5</option><option selected>1</option><option>2</option><option>3</option></select></div>
      <div><label>Repeat gap (min)</label><input id="gap" type="number" value="90"></div>
      <div><label>Seed (opt)</label><input id="seed" placeholder="e.g. 20020701"></div>
      <div><label>&nbsp;</label><button id="go" class="primary">Generate</button></div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="yt">YouTube</button>
      <button class="tab" data-tab="am">Apple Music</button>
      <button class="tab" data-tab="sp" disabled title="Coming soon">Spotify</button>
    </div>
    <div class="muted" style="margin:-6px 0 8px 2px">Spotify sign-in is under construction. Coming soon!</div>

    <div class="cols">
      <!-- YouTube -->
      <div class="panel box" id="pane-yt">
        <div id="ytWrap">
          <div class="muted" id="ytStatus">Waiting for a simulation…</div>
          <div id="ytp"></div>
          <a class="btn" id="ytOpen" href="#" target="_blank" rel="noopener" style="display:none">Open in YouTube</a>
          <div id="ytErr" class="err"></div>
        </div>
      </div>

      <!-- Apple Music Pane -->
      <div class="panel box" id="pane-am" style="display:none">
        <div id="amWrap">
          <div class="muted" style="margin-bottom:8px">Sign in with Apple Music to play or create a playlist.</div>
          <!-- Grouped buttons -->
          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <button class="btn" id="amSign">Sign in to Apple Music</button>
            <button class="btn" id="amPlay" style="display:none">Play Playlist</button>
            <button class="btn" id="amCreate" style="display:none">Create Playlist</button>
          </div>
          <div id="amMsg" class="muted" style="margin-top:8px"></div>

          <!-- Mini-player (Apple MusicKit driven) -->
          <div id="mini" class="mini">
            <div class="row1">
              <img id="miniArt" class="art" alt="Album Art">
              <div class="meta">
                <div id="miniTitle" class="title">—</div>
                <div id="miniArtist" class="artist">—</div>
              </div>
              <div class="controls">
                <button id="btnPrev" class="btn inline ghost" title="Previous">⟨⟨</button>
                <button id="btnPlayPause" class="btn inline" title="Play/Pause">▶</button>
                <button id="btnNext" class="btn inline ghost" title="Next">⟩⟩</button>
                <button id="btnShuffle" class="btn inline ghost" title="Shuffle">🔀</button>
                <button id="btnRepeat" class="btn inline ghost" title="Repeat">🔁</button>
              </div>
            </div>
            <div class="row2">
              <div id="miniT1" class="time">0:00</div>
              <input id="miniSeek" type="range" min="0" max="1000" value="0" step="1">
              <div id="miniT2" class="time">0:00</div>
            </div>
            <div class="row3">
              <span class="badge">Apple Music Player</span>
              <div class="vol">
                <span class="muted" style="font-size:12px;">Vol</span>
                <input id="miniVol" type="range" min="0" max="1" step="0.01" value="1">
              </div>
              <a id="miniOpen" class="open" href="#" target="_blank" rel="noopener">Open in Music ↗</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tracklist -->
  <div class="panel" style="margin-top:16px">
    <h2>Your Music Time Machine Playlist</h2>
    <p class="muted" style="margin-bottom:6px">
      Ever wonder <strong>what songs were popular on your birthday?</strong>
      Just pick a date and genre, and we'll <strong>generate a music playlist</strong>
      of the top songs from that week, based on <strong>historical Billboard charts</strong>.
      The tracklist will appear below.
    </p>
    <div id="list" class="list"></div>
  </div>
</div>

<script>
  // ---------- config & helpers ----------
  const qs = s => document.querySelector(s);
  const API = new URLSearchParams(location.search).get('api') || 'https://timedeck-api.onrender.com';
  const NET_TIMEOUT_MS = 180000;
  const NATIVE_HOST = 'https://tapedecktimemachine.com';
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  function toISO(mmddyyyy){ /* ... unchanged ... */ }
  function setTab(id){ /* ... unchanged ... */ }
  document.querySelectorAll('.tab').forEach(b=>b.onclick=()=>setTab(b.dataset.tab));
  function withTimeout(promise, ms = NET_TIMEOUT_MS) { /* ... unchanged ... */ }

  // ---------- state ----------
  let lastTracks = [];
  let DEV_TOKEN = null;

  // ---------- YouTube ----------
  // ... (unchanged) ...
  let player = null, YTapiReady = false;
  (function(){ const tag=document.createElement('script'); tag.src="https://www.youtube.com/iframe_api"; document.head.appendChild(tag); })();
  window.onYouTubeIframeAPIReady = () => { YTapiReady = true; console.log("YT API Ready"); };
  async function simulate(){ /* ... unchanged ... */ }
  function renderList(rows){ /* ... unchanged ... */ }
  async function buildYouTube(tracks){ /* ... unchanged ... */ }

  // ---------- Universal Link / custom-scheme listener (native) ----------
  // ... (unchanged) ...
   (function(){
    const Cap = window.Capacitor || {}; const App = Cap.Plugins && Cap.Plugins.App;
    function parseQuery(u){ const i = u.indexOf('?'); if (i < 0) return {}; const q = u.slice(i+1).split('&'); const out = {}; for (const p of q) { const [k,v] = p.split('='); out[decodeURIComponent(k)] = decodeURIComponent(v||''); } return out; }
    if (App && App.addListener) {
      App.addListener('appUrlOpen', ({ url }) => {
        console.log('[appUrlOpen]', url); if (!url || !url.startsWith('com.tapedecktimemachine.app://auth/callback')) return;
        const q = parseQuery(url); if (q.token) { localStorage.setItem('appleMusicUserToken', q.token); updateAmUIState(); getMusicInstance().catch(e => console.warn("[AM Init BG after native auth]", e)); }
        else { console.warn('[appUrlOpen] Received callback without token:', url); qs('#amMsg').textContent = 'Sign-in callback received, but no token found.'; }
      }); console.log('[AM] appUrlOpen listener attached');
    } else { console.warn('[AM] Capacitor App plugin not available for appUrlOpen listener.'); }
  })();


  // ---------- MusicKit Initialization (V10 - Corrected const/let) ----------
  let musicInstance = null;
  let musicInstancePromise = null;

  function waitForMusicKitLoaded(timeoutMs = 15000) { /* ... unchanged ... */ }
  async function fetchDeveloperToken() { /* ... unchanged ... */ }

  async function configureMusicKit() {
    await waitForMusicKitLoaded();
    const developerToken = await fetchDeveloperToken();

    console.log('[AM Configure] Configuring MusicKit...');
    window.MusicKit.configure({
      developerToken: developerToken,
      app: { name: 'TapeDeck Time Machine', build: 'web' }
    });

    console.log('[AM Configure] Getting instance...');
    // --- CORRECTED FIX: Use 'let' for the variable ---
    let instance = null; // Initialize as null, declare with let
    for (let i = 0; i < 5; i++) {
        instance = window.MusicKit.getInstance(); // Assign using let
        if (instance) break;
        console.warn(`[AM Configure] getInstance attempt ${i+1} failed, retrying...`);
        await sleep(200);
    }
    // --- END FIX ---
    if (!instance) throw new Error('MusicKit instance failed after configure and retries.');

    console.log('[AM Configure] Instance obtained.');
    instance.storefrontId = instance.storefrontId || window.mkDefaultStorefront || 'us';
    console.log('[AM Configure] Storefront set to:', instance.storefrontId);

    const storedToken = localStorage.getItem('appleMusicUserToken');
    if (storedToken && !instance.musicUserToken) {
      instance.musicUserToken = storedToken;
      console.log('[AM Configure] Applied stored user token.');
    }

    instance.removeEventListener('authorizationStatusDidChange', handleAuthorizationStatusChange);
    instance.addEventListener('authorizationStatusDidChange', handleAuthorizationStatusChange);
    console.log('[AM Configure] Attached auth listener.');

    registerPlayerEvents(instance); // Register player events

    console.log('[AM Configure] Initial configuration complete. Current auth status:', instance.authorizationStatus);
    return instance;
  }

  function getMusicInstance() {
    if (musicInstance) return Promise.resolve(musicInstance);
    if (!musicInstancePromise) {
      musicInstancePromise = configureMusicKit()
        .then(instance => {
          musicInstance = instance;
          console.log('[AM GetInstance] Initialization successful.');
          updateAmUIState();
          return instance;
        })
        .catch(e => {
          console.error('[AM GetInstance] Initialization failed:', e);
          qs('#amMsg').textContent = 'Failed to initialize Apple Music: ' + (e.message || e);
          musicInstancePromise = null;
          musicInstance = null;
          throw e;
        });
    }
    return musicInstancePromise;
  }

  // UI Update Function
  function updateAmUIState() { /* ... unchanged ... */ }
  // Event Handler
  function handleAuthorizationStatusChange(event) { /* ... unchanged ... */ }
  // --- End MusicKit Initialization ---


  // ---------- Native-first sign-in ----------
  async function amSignIn(){ /* ... unchanged ... */ }

  // ---------- Play Playlist (Programmatic) ----------
  async function appleCatalogSearch(term, storefront = 'us', limit = 1) { /* ... unchanged ... */ }

  async function amPlayPlaylist() {
    qs('#amMsg').textContent = '';
    let m;
    try {
      console.log('[AM Play] Getting MusicKit instance...');
      m = await getMusicInstance();

      if (!m || !m.isAuthorized) {
        console.log('[AM Play] Not authorized.');
        qs('#amMsg').textContent = 'Sign-in required. Please click "Sign in to Apple Music".';
        updateAmUIState(); return;
      }

      console.log('[AM Play] Waiting for API readiness...');
      qs('#amMsg').textContent = 'Connecting to Apple Music API...';
      let apiReady = false;
      for (let i = 0; i < 15; i++) {
          if (m && m.api && typeof m.api.search === 'function') {
              apiReady = true; console.log(`[AM Play] API ready after ${i} retries.`); break;
          }
          console.warn(`[AM Play] API not ready on instance 'm', retry ${i+1}...`); await sleep(200);
      }
      if (!apiReady) throw new Error('MusicKit API failed to become ready in time.');

      m.storefrontId = m.storefrontId || 'us';
      console.log('[AM Play] Instance ready for search with storefront:', m.storefrontId);

    } catch (e) {
      console.error('[AM Play] init/check failed:', e);
      qs('#amMsg').textContent = 'Apple Music connection issue: ' + (e.message || e);
      updateAmUIState(); return;
    }

    if (!lastTracks?.length) { qs('#amMsg').textContent = 'Generate a tracklist first.'; return; }

    // --- Search logic ---
    qs('#amMsg').textContent = `Searching for ${lastTracks.length} tracks...`;
    const songIds = [];
    let i = 0;
    const storefront = m.storefrontId;
    for (const t of lastTracks) {
      i++;
      if (i % 5 === 0 || i === lastTracks.length) { qs('#amMsg').textContent = `Searching... (${i}/${lastTracks.length})`; }
      try {
        const term = `${t.artist} ${t.title}`; let id = null;
        if (m.api && typeof m.api.search === 'function') {
            try { const res = await withTimeout(m.api.search(term, { types: ['songs'], limit: 1, storefront: storefront }), 5000); id = res?.songs?.data?.[0]?.id; }
            catch (apiSearchErr) { console.warn(`MusicKit API search failed for "${term}", trying REST:`, apiSearchErr); id = null; }
        } else { console.warn(`MusicKit API search not available, falling back to REST for: ${term}`); }
        if (!id) { console.log(`[AM Play] Falling back to REST search for: ${term}`); const res = await appleCatalogSearch(term, storefront, 1); id = res?.results?.songs?.data?.[0]?.id; }
        if (id) { songIds.push(id); } else { console.warn(`[AM Play] Track not found in ${storefront}: ${term}`); }
        await sleep(100);
      } catch (e) { console.warn(`[AM Play] search loop error for "${t.artist} - ${t.title}":`, e); }
    }

    if (!songIds.length) { qs('#amMsg').textContent = 'None of the tracks could be found in Apple Music.'; return; }

    qs('#amMsg').textContent = `Found ${songIds.length} tracks. Adding to queue...`;
    try {
      await m.setQueue({ songs: songIds });
      await m.play();
      showMini(); // Show player
      // UI updates handled by event listeners registered in configureMusicKit
      qs('#amMsg').textContent = `Now playing ${songIds.length} tracks!`;
    } catch (e) { console.error('[AM Play] playback failed:', e); qs('#amMsg').textContent = 'Error starting playback: ' + (e.message || e); }
  }

  // ---------- Create playlist (shared) ----------
  async function amCreatePlaylist(){ /* ... unchanged ... */ }

  // ---------- Mini-player UI Functions ----------
  // ... (mini object, fmtTime, artworkURL, showMini, setPlayIcon, setShuffleIcon, setRepeatIcon remain unchanged) ...
  const mini = { root: qs('#mini'), art: qs('#miniArt'), title: qs('#miniTitle'), artist: qs('#miniArtist'), t1: qs('#miniT1'), t2: qs('#miniT2'), seek: qs('#miniSeek'), vol: qs('#miniVol'), open: qs('#miniOpen'), btnPrev: qs('#btnPrev'), btnPlayPause: qs('#btnPlayPause'), btnNext: qs('#btnNext'), btnShuffle: qs('#btnShuffle'), btnRepeat: qs('#btnRepeat'), showing: false, isSeeking: false };
  function fmtTime(sec){ sec = Math.max(0, Math.floor(sec||0)); const m = Math.floor(sec/60), s = sec%60; return `${m}:${String(s).padStart(2,'0')}`; }
  function artworkURL(art, size=120){ const u = art?.url || ''; return u ? u.replace('{w}', size).replace('{h}', size) : ''; }
  function showMini() { if (!mini.showing) { mini.root.style.display = 'block'; mini.showing = true; } }
  function setPlayIcon(isPlaying){ mini.btnPlayPause.textContent = isPlaying ? '⏸' : '▶'; }
  function setShuffleIcon(on){ mini.btnShuffle.style.opacity = on ? 1 : 0.6; }
  function setRepeatIcon(mode){ const map = {0:'🔁',1:'🔂',2:'🔁'}; mini.btnRepeat.textContent = map[mode] || '🔁'; mini.btnRepeat.style.opacity = mode ? 1 : 0.6; }

  function updateNowPlaying(m){ /* ... unchanged ... */ }
  function updateTimes(m){ /* ... unchanged ... */ }
  function registerPlayerEvents(m){ /* ... unchanged ... */ }

  // --- Mini-player controls wiring ---
  // ... (All button/slider onclick/oninput handlers remain unchanged) ...
  mini.btnPlayPause.onclick = async () => { try { const m = await getMusicInstance(); if (!m || !m.player) return; if (m.player.isPlaying) { await m.pause(); } else { await m.play(); } } catch (e) { console.error("Play/pause error:", e); } };
  mini.btnPrev.onclick = async () => { try { const m = await getMusicInstance(); if(m) await m.skipToPreviousItem(); } catch(e){ console.warn("Skip Previous failed:", e); } };
  mini.btnNext.onclick = async () => { try { const m = await getMusicInstance(); if(m) await m.skipToNextItem(); } catch(e){ console.warn("Skip Next failed:", e); } };
  mini.seek.onmousedown = () => { mini.isSeeking = true; };
  mini.seek.oninput = () => { const dur = musicInstance?.player?.nowPlayingItem?.attributes?.durationInMillis / 1000 || 0; mini.t1.textContent = fmtTime(Number(mini.seek.value)); };
  mini.seek.onchange = async (e) => { mini.isSeeking = false; try { const m = await getMusicInstance(); const targetTime = Number(e.target.value); if (m && m.player && !isNaN(targetTime)) { await m.seekToTime(targetTime); console.log("Seeked to:", targetTime); } } catch(e){ console.error("Seek error:", e); } };
  mini.vol.oninput = async (e) => { try { const m = await getMusicInstance(); if (m?.player) m.player.volume = Number(e.target.value); } catch (e) { console.error("Volume error:", e); } };
  mini.btnShuffle.onclick = async () => { try { const m = await getMusicInstance(); if (!m?.player) return; m.player.shuffleMode = m.player.shuffleMode === 0 ? 1 : 0; setShuffleIcon(m.player.shuffleMode); } catch (e) { console.error("Shuffle error:", e); } };
  mini.btnRepeat.onclick = async () => { try { const m = await getMusicInstance(); if (!m?.player) return; const next = (m.player.repeatMode === 0) ? 2 : (m.player.repeatMode === 2 ? 1 : 0); m.player.repeatMode = next; setRepeatIcon(next); } catch (e) { console.error("Repeat error:", e); } };

  // ---------- Initialize MusicKit on Load ----------
  document.addEventListener('DOMContentLoaded', () => {
      console.log('[AM Init] DOMContentLoaded, attempting initial MusicKit setup...');
      getMusicInstance().catch(e => {
          console.error("Initial MusicKit setup failed on load:", e);
      });
      // Update UI based on stored token immediately
      updateAmUIState();
  });

  // ---------- wire up ----------
  qs('#go').onclick = simulate;
  qs('#amSign').onclick = amSignIn;
  qs('#amPlay').onclick = amPlayPlaylist;
  qs('#amCreate').onclick = amCreatePlaylist;

  setTab('yt');
</script>

</body>
</html>

