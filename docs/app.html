<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TapeDeck Time Machine</title>

  <!-- MusicKit -->
  <script src="https://js-cdn.music.apple.com/musickit/v3/musickit.js"></script>

  <!-- Meta -->
  <meta name="description" content="Rewind the radio you grew up with. Generate playlists from any date and genre, powered by Billboard chart data.">
  <link rel="icon" href="/logo.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="/logo.svg">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://tapedecktimemachine.com/">
  <meta property="og:title" content="TapeDeck Time Machine - Historical Music Playlist Generator">
  <meta property="og:description" content="Rewind the radio you grew up with. Generate playlists from any date and genre.">
  <meta property="og:image" content="https://tapedecktimemachine.com/tapedeck-preview.png">
  <meta property="og:image:width" content="1200"><meta property="og:image:height" content="630">
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://tapedecktimemachine.com/">
  <meta property="twitter:title" content="TapeDeck Time Machine - Historical Music Playlist Generator">
  <meta property="twitter:description" content="Rewind the radio you grew up with. Generate playlists from any date and genre.">
  <meta property="twitter:image" content="https://tapedecktimemachine.com/tapedeck-preview.png">

  <!-- GA -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HPZT6BMJVD"></script>
  <script>
    window.dataLayer=window.dataLayer||[];
    function gtag(){dataLayer.push(arguments);}
    gtag('js',new Date()); gtag('config','G-HPZT6BMJVD');
  </script>

  <style>
    :root{--bg:#0a0f17;--panel:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#8b5cf6;--accent2:#22d3ee;--shadow:0 12px 48px rgba(2,10,20,.45)}
    *{box-sizing:border-box}
    body{margin:0;background:
      radial-gradient(1200px 600px at 10% -10%, #0e1630 0%, transparent 60%),
      radial-gradient(700px 400px at 120% 10%, #06101f 0%, transparent 60%), #0a0f17;
      color:var(--text); font:16px/1.5 -apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1100px;margin:40px auto;padding:0 18px}
    .bar{display:flex;align-items:center;gap:14px}
    .logo{width:36px;height:36px;border-radius:12px;background:
      linear-gradient(135deg,#8b5cf6 0%,#22d3ee 55%,#16a34a 120%);
      display:grid;place-items:center;color:#fff;font-weight:800;box-shadow:var(--shadow);text-decoration:none}
    h1{font-size:22px;margin:0}

    .panel{background:rgba(17,24,39,.75);border:1px solid rgba(148,163,184,.12);
      border-radius:18px;padding:16px;box-shadow:var(--shadow)}
    .grid{display:grid;grid-template-columns:1.2fr 1fr 1fr 1fr 1fr auto;gap:12px;align-items:end}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px 2px}
    input,select,button{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(148,163,184,.18);
      background:#0c1422;color:var(--text);outline:none;font-size:1rem}
    button.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));border:0;font-weight:700;cursor:pointer}
    .tabs{display:flex;gap:10px;margin:14px 0 8px}
    .tab{padding:9px 14px;border-radius:999px;border:1px solid rgba(148,163,184,.2);background:#0c1422;color:var(--text);cursor:pointer}
    .tab.active{background:linear-gradient(135deg,rgba(139,92,246,.25),rgba(34,211,238,.18));border-color:transparent}

    .cols{display:grid;grid-template-columns:1.05fr .95fr; gap:16px}
    .box{min-height:380px}
    iframe{width:100%;height:360px;border:0;border-radius:12px;box-shadow:var(--shadow)}
    .btn{display:inline-block;margin-top:8px;padding:10px 14px;border-radius:12px;border:1px solid rgba(148,163,184,.2);
      background:#0c1422;color:#e5e7eb;text-decoration:none;font-weight:700;cursor:pointer}
    .muted{color:var(--muted)}
    .list{padding:12px 8px;max-height:420px;overflow:auto}
    .row{display:grid;grid-template-columns:110px 1fr;gap:14px;padding:10px 6px;border-bottom:1px dashed rgba(148,163,184,.12)}
    .ts{font:12px/1.3 ui-monospace,SFMono-Regular,Menlo,monospace;color:var(--muted)}
    .err{color:#fda4af;margin-top:6px}
    .ok{color:#86efac;margin-top:6px}

    /* Apple panel internal split: left player + right info */
    .am-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){.am-grid{grid-template-columns:1fr}}

    /* Mini player */
    .mini{display:none;margin-top:12px;background:rgba(12,20,34,.8);border:1px solid rgba(148,163,184,.12);border-radius:14px;padding:12px}
    .mini .top{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center}
    .mini .art{width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,rgba(139,92,246,.15),rgba(34,211,238,.12));object-fit:cover;display:none}
    .mini .art.ready{display:block}
    .mini .meta{min-width:0}
    .mini .title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .mini .artist{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .mini .controls{display:flex;gap:8px;align-items:center}
    .mini .controls .btn{padding:8px 12px;border-radius:10px}
    .mini .bottom{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center;margin-top:10px}
    .mini input[type="range"]{width:100%}

    /* Right panel (Now Playing / Visualizer / Time Capsule) */
    #pane-am-side .tab{padding:8px 12px;border-radius:999px;border:1px solid rgba(148,163,184,.2);background:#0c1422}
    #pane-am-side .tab.active{background:linear-gradient(135deg,rgba(139,92,246,.25),rgba(34,211,238,.18));border-color:transparent}
  </style>
</head>
<body>

<div class="wrap">
  <div class="bar" style="margin-bottom:14px">
    <a class="logo" href="/" title="Back to home">TD</a>
    <h1>TapeDeck Time Machine</h1>
  </div>

  <div class="panel">
    <!-- Controls -->
    <div class="grid">
      <div><label>Date</label><input id="date" placeholder="mm/dd/yyyy" value="07/01/2002"></div>
      <div><label>Genre</label>
        <select id="genre">
          <option>Alternative</option><option>Hot-100</option><option>Pop</option>
          <option>Rock</option><option>Country</option><option>R&B/Hip-Hop</option><option>Dance/Electronic</option>
        </select>
      </div>
      <div><label>Hours</label><select id="hours"><option>0.5</option><option selected>1</option><option>2</option><option>3</option></select></div>
      <div><label>Repeat gap (min)</label><input id="gap" type="number" value="90"></div>
      <div><label>Seed (opt)</label><input id="seed" placeholder="e.g. 20020701"></div>
      <div><label>&nbsp;</label><button id="go" class="primary">Generate</button></div>
    </div>

    <!-- Top tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="yt">YouTube</button>
      <button class="tab" data-tab="am">Apple Music</button>
      <button class="tab" data-tab="sp" disabled title="Coming soon">Spotify</button>
    </div>
    <div class="muted" style="margin:-6px 0 8px 2px">Spotify sign-in is under construction. Coming soon!</div>

    <!-- Two columns: YT panel + Apple panel -->
    <div class="cols">
      <!-- YT -->
      <div class="panel box" id="pane-yt">
        <div id="ytWrap">
          <div class="muted" id="ytStatus">Waiting for a simulation…</div>
          <div id="ytp"></div>
          <a class="btn" id="ytOpen" href="#" target="_blank" rel="noopener" style="display:none">Open in YouTube</a>
          <div id="ytErr" class="err"></div>
        </div>
      </div>

      <!-- Apple (split internally) -->
      <div class="panel box" id="pane-am" style="display:none">
        <div class="am-grid">
          <!-- LEFT: sign-in, embed, mini-player -->
          <div>
            <p class="muted" style="margin-bottom:8px">
              Generate a list, sign in, create the playlist, then play it below with the official Apple embed.
              If embedding isn’t possible, we’ll use a built-in player.
            </p>
            <div class="linkRow" style="display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn" id="amSign">Sign in to Apple Music</button>
              <button class="btn" id="amCreate" style="display:none">Create Playlist</button>
              <button class="btn" id="amPlayEmbed" style="display:none">Play in Apple Embed</button>
              <button class="btn" id="amPlayLocal" style="display:none">Play with Built-In Player</button>
            </div>
            <div id="amMsg" class="muted" style="margin-top:8px"></div>

            <!-- Official embed -->
            <div id="embedWrap" class="embedWrap">
              <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:8px">
                <div class="muted">Apple Music Player</div>
                <div class="linkRow" style="display:flex;gap:10px;flex-wrap:wrap">
                  <a id="openInAm" class="btn" href="#" target="_blank" rel="noopener">Open in Apple Music ↗</a>
                  <button id="copyLink" class="btn">Copy Link</button>
                </div>
              </div>
              <iframe id="amEmbed" allow="autoplay *; encrypted-media *;" loading="lazy"></iframe>
              <div id="embedNote" class="muted" style="margin-top:8px;display:none"></div>
            </div>

            <!-- Mini player (fallback) -->
            <div id="mini" class="mini">
              <div class="top">
                <img id="miniArt" class="art" alt="">
                <div class="meta">
                  <div id="miniTitle" class="title">—</div>
                  <div id="miniArtist" class="artist">—</div>
                </div>
                <div class="controls">
                  <button id="btnPrev" class="btn">⟨⟨</button>
                  <button id="btnPlayPause" class="btn">▶</button>
                  <button id="btnNext" class="btn">⟩⟩</button>
                </div>
              </div>
              <div class="bottom">
                <div id="miniT1" class="muted" style="font-variant-numeric: tabular-nums;">0:00</div>
                <input id="miniSeek" type="range" min="0" max="1000" value="0">
                <div id="miniT2" class="muted" style="font-variant-numeric: tabular-nums;">0:00</div>
              </div>
              <div class="bottom" style="margin-top:8px">
                <span class="muted" style="font-size:12px;">Volume</span>
                <input id="miniVol" type="range" min="0" max="1" step="0.01" value="1">
                <a id="miniOpen" class="muted" href="#" target="_blank" rel="noopener" style="text-decoration:none;justify-self:end">Open in Apple Music ↗</a>
              </div>
            </div>
          </div>

          <!-- RIGHT: Now Playing / Viz / Time Capsule -->
          <div class="panel" id="pane-am-side">
            <div class="tabs" style="margin-top:0">
              <button class="tab active" data-side="np">Now Playing</button>
              <button class="tab" data-side="viz">Visualizer</button>
              <button class="tab" data-side="capsule">Time Capsule</button>
            </div>

            <div id="side-np">
              <div style="display:flex;gap:14px;align-items:center;margin-top:6px">
                <img id="npArt" style="width:84px;height:84px;border-radius:14px;object-fit:cover;background:#0c1422" alt="">
                <div style="min-width:0">
                  <div id="npTitle" style="font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">—</div>
                  <div id="npArtist" class="muted" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">—</div>
                  <div id="npMeta" class="muted" style="margin-top:6px;font-size:13px">—</div>
                </div>
              </div>
              <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
                <a id="npOpen" class="btn" target="_blank" rel="noopener">Open in Apple Music ↗</a>
                <button id="npSave" class="btn" title="(future) Save to your playlist">Save</button>
                <button id="npShare" class="btn" title="(future) Copy share link">Share</button>
              </div>
            </div>

            <div id="side-viz" style="display:none;margin-top:6px">
              <canvas id="viz" width="600" height="220" style="width:100%;height:220px;border-radius:12px;background:linear-gradient(180deg,rgba(139,92,246,.08),rgba(34,211,238,.06));"></canvas>
            </div>

            <div id="side-capsule" style="display:none;margin-top:6px">
              <div id="capsuleBody" class="muted">Generate a list and start playback to see weekly trivia here.</div>
            </div>
          </div>
        </div><!-- /.am-grid -->
      </div>
    </div>
  </div>

  <!-- Tracklist -->
  <div class="panel" style="margin-top:16px">
    <h2>Your Music Time Machine Playlist</h2>
    <p class="muted" style="margin-bottom:6px">
      Ever wonder <strong>what songs were popular on your birthday?</strong>
      Just pick a date and genre, and we'll <strong>generate a music playlist</strong>
      of the top songs from that week, based on <strong>historical Billboard charts</strong>.
      The tracklist will appear below.
    </p>
    <div id="list" class="list"></div>
  </div>
</div>

<script>
  /***** helpers / config *****/
  const qs = s => document.querySelector(s);
  const API = new URLSearchParams(location.search).get('api') || 'https://timedeck-api.onrender.com';
  const NET_TIMEOUT_MS = 180000;
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
  function toISO(mmddyyyy){ const [mm,dd,yyyy]=mmddyyyy.split('/'); return `${yyyy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}`; }
  function setTab(id){
    document.querySelectorAll('.tab[data-tab]').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
    qs('#pane-yt').style.display = id==='yt' ? '' : 'none';
    qs('#pane-am').style.display = id==='am' ? '' : 'none';
  }
  document.querySelectorAll('.tab[data-tab]').forEach(b=>b.onclick=()=>setTab(b.dataset.tab));
  function withTimeout(p,ms=NET_TIMEOUT_MS){ let t; const timer=new Promise((_,rej)=>{t=setTimeout(()=>rej(new Error(`Network timeout after ${Math.round(ms/1000)}s`)),ms)}); return Promise.race([p.finally(()=>clearTimeout(t)),timer]); }

  /***** state *****/
  let lastTracks=[]; let resolvedSongIds=[]; let isAuthorizing=false; let DEV_TOKEN=null; let playToggleInFlight=false;

  /***** YouTube *****/
  let player=null, YTapiReady=false;
  (function(){ const s=document.createElement('script'); s.src="https://www.youtube.com/iframe_api"; document.head.appendChild(s); })();
  window.onYouTubeIframeAPIReady=()=>{YTapiReady=true;};
  async function simulate(){
    const body={date:toISO(qs('#date').value.trim()),genre:qs('#genre').value,hours:Number(qs('#hours').value||3),
      repeat_gap_min:Number(qs('#gap').value||90),seed:(qs('#seed').value.trim()||undefined)?String(qs('#seed').value.trim()):undefined,limit:500};
    qs('#ytStatus').textContent='Building…'; qs('#ytErr').textContent='';
    if(player){try{player.destroy();}catch{} player=null;} qs('#ytp').innerHTML=''; qs('#ytp').style.display='none';
    qs('#ytOpen').style.display='none'; qs('#list').innerHTML=''; lastTracks=[]; resolvedSongIds=[];
    try{
      const r=await withTimeout(fetch(`${API}/v1/simulate`,{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(body)}));
      if(!r.ok){ const txt=await r.text().catch(()=> ''); throw new Error(`simulate ${r.status}: ${txt}`); }
      const data=await r.json(); lastTracks=data.tracks||[];
      if(!lastTracks.length){ qs('#ytStatus').textContent=''; qs('#ytErr').textContent='No tracks returned. Try a different date/genre.'; return; }
      renderList(lastTracks); buildYouTube(lastTracks);

      // reset apple area
      qs('#embedWrap').style.display='none'; qs('#mini').style.display='none';
      qs('#amPlayEmbed').style.display='none';
      qs('#amPlayLocal').style.display = localStorage.getItem('appleMusicUserToken') ? 'inline-block' : 'none';
      qs('#amMsg').textContent='Playlist ready. Sign in and create it, or use the built-in player.';
    }catch(err){ qs('#ytStatus').textContent=''; qs('#ytErr').textContent=err.message||String(err); }
  }
  function renderList(rows){
    if(!rows?.length){ qs('#list').innerHTML='<div class="muted">No tracks.</div>'; return; }
    const frag=document.createDocumentFragment();
    rows.slice(0,500).forEach(t=>{
      const d=document.createElement('div'); d.className='row';
      d.innerHTML=`<div class="ts">${t.timestamp.replace('T',' ')}</div>
                   <div><strong>${t.artist}</strong> — <em>${t.title}</em>
                   <span class="muted">• ${t.source_rank ?? ''}</span></div>`;
      frag.appendChild(d);
    });
    qs('#list').replaceChildren(frag);
  }
  async function buildYouTube(tracks){
    qs('#ytStatus').textContent='Resolving YouTube IDs…';
    try{
      const r=await withTimeout(fetch(`${API}/v1/yt/resolve`,{method:'POST',headers:{'content-type':'application/json'},
        body:JSON.stringify({tracks:tracks.map(t=>({artist:t.artist,title:t.title})),limit:50})}));
      if(!r.ok) throw new Error(`yt/resolve ${r.status}: ${await r.text()}`);
      const data=await r.json(); const ids=(data.ids||[]).filter(Boolean);
      if(!ids.length){ qs('#ytStatus').textContent='No playable videos found (try another date/genre).'; return; }
      const openUrl=`https://www.youtube.com/watch_videos?video_ids=${ids.join(',')}`;
      qs('#ytOpen').href=openUrl; qs('#ytOpen').style.display='inline-block';
      qs('#ytStatus').textContent=`${ids.length} videos found. Loading player...`;
      if(player){try{player.cuePlaylist(ids,0,0); qs('#ytStatus').textContent=`${ids.length} videos queued.`;}catch{player=null;}}
      if(!player){
        if(YTapiReady && qs('.tab[data-tab="yt"]').classList.contains('active')){
          qs('#ytp').style.display='block';
          player=new YT.Player('ytp',{height:'360',width:'100%',playerVars:{playsinline:1,rel:0,modestbranding:1,origin:location.origin},
            events:{onReady:(e)=>{e.target.cuePlaylist(ids,0,0); qs('#ytStatus').textContent=`${ids.length} videos queued.`;}}});
        }else if(!YTapiReady){ qs('#ytStatus').textContent='YouTube API is still loading. Use "Open in YouTube".'; }
        else { qs('#ytStatus').textContent=`${ids.length} videos ready. Switch to YouTube tab to play.`; }
      }
    }catch(err){ qs('#ytErr').textContent=err.message; qs('#ytStatus').textContent=''; }
  }

  /***** MusicKit base *****/
  let music=null, musicInitPromise=null;
  function waitForMusicKitLoaded(timeoutMs=10000){
    if(window.MusicKit && typeof window.MusicKit.configure==='function') return Promise.resolve();
    return new Promise((resolve,reject)=>{const t=setTimeout(()=>reject(new Error('MusicKit load timed out')),timeoutMs);
      window.addEventListener('musickitloaded',()=>{clearTimeout(t); resolve();},{once:true});});
  }
  async function fetchDeveloperToken(){
    if(DEV_TOKEN) return DEV_TOKEN;
    const r=await withTimeout(fetch(`${API}/v1/apple/dev-token`,{headers:{accept:'application/json'}}));
    if(!r.ok) throw new Error(`dev-token ${r.status}`);
    const {token}=await r.json(); if(!token||token.trim().length<20) throw new Error('Invalid developer token');
    DEV_TOKEN=token.trim(); return DEV_TOKEN;
  }
  async function getWebMusicInstance(force=false){
    if(music && !force) return music;
    if(!musicInitPromise || force){
      musicInitPromise=(async()=>{
        await waitForMusicKitLoaded();
        const developerToken=await fetchDeveloperToken();
        window.MusicKit.configure({developerToken,app:{name:'TapeDeck Time Machine',build:'web'}});
        let inst=null; for(let i=0;i<40;i++){try{inst=window.MusicKit.getInstance();}catch{} if(inst) break; await sleep(50);}
        if(!inst) throw new Error('MusicKit instance missing');
        const stored=localStorage.getItem('appleMusicUserToken'); if(stored) inst.musicUserToken=stored;

        if(!inst._tdtmBound){
          inst._tdtmBound=true;
          inst.addEventListener('nowPlayingItemDidChange',()=>{updateNowPlaying(inst);});
          inst.addEventListener('playbackTimeDidChange',()=>{updateTimes(inst);});
          inst.addEventListener('playbackStateDidChange',(evt)=>{const PS=window.MusicKit?.PlaybackStates||{};
            const isPlaying=evt?.state===PS.playing; setPlayIcon(isPlaying);});
        }
        music=inst; return music;
      })().catch(e=>{musicInitPromise=null; throw e;});
    }
    return musicInitPromise;
  }

  /***** Apple search (dev token only) *****/
  async function appleCatalogSearch(term,storefront='us',limit=1){
    const dev=await fetchDeveloperToken();
    const url=new URL(`https://api.music.apple.com/v1/catalog/${encodeURIComponent(storefront)}/search`);
    url.searchParams.set('term',term); url.searchParams.set('types','songs'); url.searchParams.set('limit',String(limit));
    const r=await withTimeout(fetch(url.toString(),{headers:{Authorization:`Bearer ${dev}`}}),15000);
    if(!r.ok) throw new Error(`Apple search ${r.status}`); return r.json();
  }

  /***** Embed helpers *****/
  function isEmbeddableAppleUrl(url){try{const u=new URL(url);return /music\.apple\.com$/.test(u.hostname)&&!u.pathname.includes('/library/');}catch{return false;}}
  function toEmbedUrl(url,id,storefront='us'){ if(url&&isEmbeddableAppleUrl(url)) return url.replace('://music.apple.com/','://embed.music.apple.com/');
    if(id&&id.startsWith('pl.')) return `https://embed.music.apple.com/${encodeURIComponent(storefront)}/playlist/${encodeURIComponent(id)}`; return null;}
  function showEmbed(embedUrl,openUrl){qs('#openInAm').href=openUrl||embedUrl; qs('#amEmbed').src=embedUrl;
    qs('#embedWrap').style.display=''; qs('#mini').style.display='none'; qs('#embedNote').style.display='none';}

  /***** Apple auth + create *****/
  function showAmControls(){ qs('#amSign').style.display='none'; qs('#amCreate').style.display='inline-block';
    qs('#amPlayLocal').style.display=lastTracks.length?'inline-block':'none'; }

  async function amSignIn(){
    if(isAuthorizing) return; isAuthorizing=true;
    try{
      qs('#amMsg').textContent='Contacting Apple…';
      let m=await getWebMusicInstance(true);
      const tok=await m.authorize(); await sleep(120);
      if(!tok||tok.length<20){qs('#amMsg').textContent='Sign-in cancelled or failed. Apple Music subscription required for full playback.'; return;}
      localStorage.setItem('appleMusicUserToken',tok); m.musicUserToken=tok; await getWebMusicInstance(true);
      qs('#amMsg').textContent='Signed in. Create your playlist or use the built-in player.'; showAmControls();
      if(lastTracks.length) qs('#amPlayLocal').style.display='inline-block';
    }catch(e){qs('#amMsg').textContent='Sign-in failed: '+(e.message||e);} finally{isAuthorizing=false;}
  }

  async function amCreatePlaylist(){
    const userToken=localStorage.getItem('appleMusicUserToken');
    if(!userToken){qs('#amMsg').textContent='Please sign in first.'; return;}
    if(!lastTracks?.length){qs('#amMsg').textContent='Generate a tracklist first.'; return;}
    qs('#amMsg').textContent='Creating playlist…';
    try{
      const name=`TimeDeck — ${qs('#date').value} — ${qs('#genre').value.toLowerCase()}`;
      const r=await withTimeout(fetch(`${API}/v1/apple/create-playlist`,{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({userToken,name,tracks:lastTracks.map(t=>({artist:t.artist,title:t.title}))})}));
      if(!r.ok){ const j=await r.json().catch(()=>({detail:'Unknown error during create'})); throw new Error(j.detail||`Create failed with status ${r.status}`); }
      const j=await r.json(); const {url,id,storefront}=j||{};
      if(url) localStorage.setItem('applePlaylistUrl',url);
      if(id) localStorage.setItem('applePlaylistId',id);
      if(storefront) localStorage.setItem('applePlaylistStorefront',storefront);
      qs('#amMsg').textContent=`Playlist created! Added ${j.added_count} of ${j.total_tracks} tracks.`;
      const embedCandidate=toEmbedUrl(url,id,storefront||'us');
      if(embedCandidate){ qs('#amPlayEmbed').style.display='inline-block'; showEmbed(embedCandidate,url||embedCandidate); }
      else{
        qs('#amPlayEmbed').style.display='none';
        const open=url || (id?`https://music.apple.com/${storefront||'us'}/playlist/${encodeURIComponent(id)}`:null);
        if(open){ qs('#embedWrap').style.display=''; qs('#amEmbed').style.display='none'; qs('#openInAm').href=open;
          const note=qs('#embedNote'); note.textContent='This playlist can’t be embedded (library/private). Use “Open in Apple Music”, or play below.'; note.style.display='block';}
        qs('#amPlayLocal').style.display='inline-block';
      }
    }catch(e){qs('#amMsg').textContent='Create failed: '+(e.message||String(e));}
  }
  function amPlayEmbed(){
    const url=localStorage.getItem('applePlaylistUrl'); const id=localStorage.getItem('applePlaylistId');
    const sf=localStorage.getItem('applePlaylistStorefront')||'us';
    const embedUrl=toEmbedUrl(url,id,sf);
    const openUrl=url||(id?`https://music.apple.com/${sf}/playlist/${encodeURIComponent(id)}`:'#');
    if(embedUrl) showEmbed(embedUrl,openUrl);
    else{ qs('#embedWrap').style.display=''; qs('#amEmbed').style.display='none'; qs('#openInAm').href=openUrl;
      const note=qs('#embedNote'); note.textContent='This playlist can’t be embedded (library/private). Use “Open in Apple Music”, or play below.'; note.style.display='block';}
  }

  /***** Mini-player wiring *****/
  const mini={root:qs('#mini'),art:qs('#miniArt'),title:qs('#miniTitle'),artist:qs('#miniArtist'),
    t1:qs('#miniT1'),t2:qs('#miniT2'),seek:qs('#miniSeek'),vol:qs('#miniVol'),
    open:qs('#miniOpen'),btnPrev:qs('#btnPrev'),btnPlayPause:qs('#btnPlayPause'),btnNext:qs('#btnNext')};

  function fmtTime(sec){ sec=Math.max(0,Math.floor(sec||0)); const m=Math.floor(sec/60), s=sec%60; return `${m}:${String(s).padStart(2,'0')}`; }
  function setPlayIcon(isPlaying){ mini.btnPlayPause.textContent=isPlaying?'⏸':'▶'; }

  function updateNowPlaying(m){
    const item=m?.player?.nowPlayingItem; const a=item?.attributes||item||{};
    const title=a.name||a.title||'—', artist=a.artistName||a.artist||'—';
    mini.title.textContent=title; mini.artist.textContent=artist;
    const tmpl=(a.artwork&&a.artwork.url)||a.artworkUrl||''; const art=tmpl?tmpl.replace('{w}','200').replace('{h}','200'):'';
    if(art){ mini.art.src=art; mini.art.alt=title; mini.art.classList.add('ready'); } else { mini.art.removeAttribute('src'); mini.art.classList.remove('ready'); }
    mini.open.href=a.url||'#';
    updateRightNowPlayingFromMusicKit(m); // update the right-hand panel too
  }
  function updateTimes(m){
    const p=m?.player; if(!p) return;
    const cur=Number(p.currentPlaybackTime||0), dur=Number(p.currentPlaybackDuration||0);
    mini.t1.textContent=fmtTime(cur); mini.t2.textContent=dur?fmtTime(dur):'0:00';
    const max=Math.max(1,Math.floor(dur*10)); const val=Math.min(max,Math.floor(cur*10));
    if(Number(mini.seek.max)!==max) mini.seek.max=max; mini.seek.value=val;
  }

  async function appleCatalogResolveList(tracks,storefront){
    const ids=[]; for(let i=0;i<tracks.length;i++){ const t=tracks[i];
      if((i+1)%5===0||i+1===tracks.length) qs('#amMsg').textContent=`Resolving… (${i+1}/${tracks.length})`;
      try{ const term=`${t.artist} ${t.title}`.replace(/\s+\(.*?\)|-+\s*(radio edit|remaster.*|remix.*)/ig,'').trim();
        const res=await appleCatalogSearch(term,storefront,1); const id=res?.results?.songs?.data?.[0]?.id; if(id) ids.push(id); await sleep(50);}catch{}}
    return ids;
  }
  async function buildLocalQueueAndPlay(){
    let m=await getWebMusicInstance(); if(!m.musicUserToken){qs('#amMsg').textContent='Please sign in to Apple Music first.'; return;}
    if(!lastTracks?.length){qs('#amMsg').textContent='Generate a tracklist first.'; return;}
    const storefront=m.storefrontId||'us';
    if(!resolvedSongIds.length){ qs('#amMsg').textContent=`Resolving ${lastTracks.length} tracks for playback…`;
      resolvedSongIds=await appleCatalogResolveList(lastTracks,storefront); }
    if(!resolvedSongIds.length){ qs('#amMsg').textContent='No playable tracks were found in Apple Music.'; return; }

    try{ if(m.player?.isPlaying) await m.pause(); }catch{}
    qs('#amMsg').textContent='Preparing player…';
    await m.setQueue({songs:resolvedSongIds}); await sleep(50); await m.play();

    mini.root.style.display='block'; updateNowPlaying(m); updateTimes(m); setPlayIcon(true);
    qs('#embedWrap').style.display='none'; qs('#amMsg').textContent=`Now playing ${resolvedSongIds.length} tracks.`;
  }
  mini.btnPlayPause.onclick=async()=>{ const m=await getWebMusicInstance(); if(!m?.player) return;
    if(playToggleInFlight) return; playToggleInFlight=true;
    try{ if(m.player.isPlaying){ await m.pause(); setPlayIcon(false);} else { await m.play(); setPlayIcon(true);} }
    finally{ playToggleInFlight=false; } };
  mini.btnPrev.onclick=async()=>{ const m=await getWebMusicInstance(); try{await m.skipToPreviousItem();}catch{} };
  mini.btnNext.onclick=async()=>{ const m=await getWebMusicInstance(); try{await m.skipToNextItem();}catch{} };
  mini.seek.oninput=async(e)=>{ const m=await getWebMusicInstance(); const dur=m?.player?.currentPlaybackDuration||0; const target=(Number(e.target.value)/10);
    if(dur){ try{ await m.seekToTime(Math.min(target,dur-0.25)); }catch{} } };
  mini.vol.oninput=async(e)=>{ const m=await getWebMusicInstance(); if(m?.player) m.player.volume=Number(e.target.value); };

  /***** Right-side panel wiring *****/
  // Tabs
  document.querySelectorAll('#pane-am-side .tab').forEach(b=>{
    b.onclick=()=>{ document.querySelectorAll('#pane-am-side .tab').forEach(x=>x.classList.remove('active')); b.classList.add('active');
      const k=b.dataset.side; qs('#side-np').style.display=k==='np'?'':'none';
      qs('#side-viz').style.display=k==='viz'?'':'none'; qs('#side-capsule').style.display=k==='capsule'?'':'none';
      if(k==='viz') startViz(); else stopViz();
    };
  });
  // Update Now Playing panel using MusicKit item
  function updateRightNowPlayingFromMusicKit(m){
    const item=m?.player?.nowPlayingItem; const a=item?.attributes||item||{};
    const title=a.name||a.title||'—'; const artist=a.artistName||a.artist||'—';
    const artTmpl=(a.artwork&&a.artwork.url)||a.artworkUrl||''; const art=artTmpl?artTmpl.replace('{w}','400').replace('{h}','400'):'';
    qs('#npTitle').textContent=title; qs('#npArtist').textContent=artist;
    if(art){ qs('#npArt').src=art; qs('#npArt').alt=title; }
    qs('#npOpen').href=a.url||'#';

    // try to match this item back to lastTracks to show rank + date
    const match=lastTracks.find(t=>(t.title||'').toLowerCase()===title.toLowerCase() && (t.artist||'').toLowerCase()===artist.toLowerCase());
    const rank = match?.source_rank ? `Rank this week: #${match.source_rank}` : '';
    const when = match?.timestamp ? ` • ${match.timestamp.slice(0,10)}` : '';
    qs('#npMeta').textContent = `${rank}${when}` || '—';

    if(match){
      qs('#capsuleBody').innerHTML =
        `<div><strong>Week of:</strong> ${match.timestamp.slice(0,10)}</div>
         <div><strong>Chart:</strong> ${qs('#genre').value}</div>
         ${rank ? `<div><strong>Position:</strong> ${match.source_rank}</div>` : ''}
         <div class="muted" style="margin-top:6px;font-size:13px">More trivia coming soon.</div>`;
    }
  }

  // Faux visualizer (smooth, no private APIs)
  let vizRAF=0;
  function startViz(){
    const c=qs('#viz'); if(!c) return; const ctx=c.getContext('2d'); let t=0;
    cancelAnimationFrame(vizRAF);
    const loop=()=>{ const w=c.width,h=c.height; ctx.clearRect(0,0,w,h);
      const g=ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#8b5cf6'); g.addColorStop(1,'#22d3ee'); ctx.fillStyle=g;
      const bars=48,pad=6; for(let i=0;i<bars;i++){ const p=i/(bars-1); const phase=t*0.05+i*0.35; const amp=(Math.sin(phase)+1)/2;
        const ease=0.8-Math.abs(p-0.5); const hBar=(amp*ease)*h*0.9+6; const bw=(w-pad*(bars+1))/bars; const x=pad+i*(bw+pad); const y=h-hBar;
        ctx.fillRect(x,y,bw,hBar); ctx.globalAlpha=0.08; ctx.fillRect(x,y-12,bw,hBar+24); ctx.globalAlpha=1; }
      t+=1; vizRAF=requestAnimationFrame(loop); };
    vizRAF=requestAnimationFrame(loop);
  }
  function stopViz(){ cancelAnimationFrame(vizRAF); vizRAF=0; }

  /***** init *****/
  (function(){
    const tok=localStorage.getItem('appleMusicUserToken');
    if(tok){ qs('#amMsg').textContent='Signed in. Create your playlist or use the built-in player.'; showAmControls(); }
    const have=localStorage.getItem('applePlaylistUrl')||localStorage.getItem('applePlaylistId');
    if(have) qs('#amPlayEmbed').style.display='inline-block';
  })();

  /***** wire *****/
  qs('#go').onclick=simulate;
  qs('#amSign').onclick=amSignIn;
  qs('#amCreate').onclick=amCreatePlaylist;
  qs('#amPlayEmbed').onclick=amPlayEmbed;
  qs('#amPlayLocal').onclick=()=>buildLocalQueueAndPlay();

  setTab('yt');
</script>

</body>
</html>
