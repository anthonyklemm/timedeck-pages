<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TapeDeck Time Machine</title>

  <!-- MusicKit JS -->
  <script src="https://js-cdn.music.apple.com/musickit/v3/musickit.js"></script>

  <!-- Meta / Social -->
  <meta name="description" content="Rewind the radio you grew up with. Generate playlists from any date and genre, powered by Billboard chart data.">
  <link rel="icon" href="/logo.svg" type="image/svg+xml"><!-- no favicon.ico until you add one -->
  <link rel="apple-touch-icon" href="/logo.svg">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://tapedecktimemachine.com/">
  <meta property="og:title" content="TapeDeck Time Machine - Historical Music Playlist Generator">
  <meta property="og:description" content="Rewind the radio you grew up with. Generate playlists from any date and genre.">
  <meta property="og:image" content="https://tapedecktimemachine.com/tapedeck-preview.png">
  <meta property="og:image:width" content="1200"><meta property="og:image:height" content="630">
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://tapedecktimemachine.com/">
  <meta property="twitter:title" content="TapeDeck Time Machine - Historical Music Playlist Generator">
  <meta property="twitter:description" content="Rewind the radio you grew up with. Generate playlists from any date and genre.">
  <meta property="twitter:image" content="https://tapedecktimemachine.com/tapedeck-preview.png">

  <!-- GA -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HPZT6BMJVD"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-HPZT6BMJVD');
  </script>

  <style>
    :root{
      --bg:#0a0f17;--panel:#111827;--muted:#94a3b8;--text:#e5e7eb;
      --accent:#8b5cf6;--accent2:#22d3ee;--shadow:0 12px 48px rgba(2,10,20,.45)
    }
    *{box-sizing:border-box}
    body{margin:0;background:
      radial-gradient(1200px 600px at 10% -10%, #0e1630 0%, transparent 60%),
      radial-gradient(700px 400px at 120% 10%, #06101f 0%, transparent 60%), #0a0f17;
      color:var(--text); font:16px/1.5 -apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;}
    .wrap{max-width:1100px;margin:40px auto;padding:0 18px}
    .bar{display:flex;align-items:center;gap:14px}
    .bar a { color: inherit; text-decoration: none; display: flex; align-items: center; gap: 14px; }
    .logo{width:36px;height:36px;border-radius:12px;background:
      linear-gradient(135deg,#8b5cf6 0%,#22d3ee 55%,#16a34a 120%);
      display:grid;place-items:center;color:#fff;font-weight:800;box-shadow:var(--shadow);text-decoration:none; flex-shrink: 0;}
    h1{font-size:22px;margin:0}
    .panel{background:rgba(17,24,39,.75);border:1px solid rgba(148,163,184,.12);
      border-radius:18px;padding:16px;box-shadow:var(--shadow)}
    .grid{display:grid;grid-template-columns:1.2fr 1fr 1fr 1fr 1fr auto; gap:12px; align-items:end}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px 2px}
    input,select,button{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(148,163,184,.18);
      background:#0c1422;color:var(--text);outline:none;font-size:1rem}
    button.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));border:0;font-weight:700;cursor:pointer}
    button:disabled{background:#475569;color:#cbd5e1;cursor:not-allowed}
    .tabs{display:flex;gap:10px;margin:14px 0 8px}
    .tab{padding:9px 14px;border-radius:999px;border:1px solid rgba(148,163,184,.2);
      background:#0c1422;color:var(--text);cursor:pointer}
    .tab.active{background:linear-gradient(135deg,rgba(139,92,246,.25),rgba(34,211,238,.18));border-color:transparent}
    .cols{display:grid;grid-template-columns:1.05fr .95fr; gap:16px}
    .box{min-height:380px}
    iframe{width:100%;height:360px;border:0;border-radius:12px;box-shadow:var(--shadow)}
    .btn{display:inline-block;margin-top:8px;padding:10px 14px;border-radius:12px;border:1px solid rgba(148,163,184,.2);
      background:#0c1422;color:#e5e7eb;text-decoration:none;font-weight:700;cursor:pointer}
    .btn.inline{padding:8px 10px}
    .btn.ghost{background:transparent}
    .muted{color:var(--muted)}
    .list{padding:12px 8px;max-height:420px;overflow:auto}
    .row{display:grid;grid-template-columns:110px 1fr;gap:14px; padding:10px 6px;border-bottom:1px dashed rgba(148,163,184,.12)}
    .ts{font:12px/1.3 ui-monospace,SFMono-Regular,Menlo,monospace;color:var(--muted)}
    .err{color:#fda4af;margin-top:6px; white-space: pre-wrap; word-break: break-all;}
    .ok{color:#86efac;margin-top:6px}

    /* Embed styles (REMOVED) */
    .linkRow{display:flex; gap:10px; flex-wrap:wrap}

    /* Simple Player styles (RESTORED) */
    .simplePlayer { display: none; margin-top: 12px; background: rgba(12,20,34,.8); border:1px solid rgba(148,163,184,.12); border-radius:14px; padding:10px; }
    .simplePlayer .spRow1 { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; }
    .simplePlayer .spMeta { min-width: 0; }
    .simplePlayer .spTitle { font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .simplePlayer .spControls { display: flex; gap: 6px; align-items: center; }
    .simplePlayer .spControls .btn { padding: 6px 10px; margin-top: 0; } /* Removed margin-top */
    .simplePlayer .spMsg { font-size: 11px; margin-top: 4px; color: var(--muted); }

    @media (max-width:800px){.grid{grid-template-columns:1fr 1fr}.grid>div:last-child{grid-column:1/-1}}
    @media (max-width:700px){.wrap{margin:20px auto}.cols{grid-template-columns:1fr}h1{font-size:18px}}
    @media (max-width:500px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>

<div class="wrap">
  <!-- Link added to logo/title -->
  <div class="bar" style="margin-bottom:14px">
    <a href="/">
      <div class="logo">TD</div>
      <h1>TapeDeck Time Machine</h1>
    </a>
  </div>

  <!-- Controls -->
  <div class="panel">
    <!-- ... (Grid remains the same) ... -->
    <div class="grid">
      <div><label>Date</label><input id="date" placeholder="mm/dd/yyyy" value="07/01/2002"></div>
      <div><label>Genre</label>
        <select id="genre"> <option>Alternative</option><option>Hot-100</option><option>Pop</option><option>Rock</option><option>Country</option><option>R&B/Hip-Hop</option><option>Dance/Electronic</option> </select>
      </div>
      <div><label>Hours</label><select id="hours"><option>0.5</option><option selected>1</option><option>2</option><option>3</option></select></div>
      <div><label>Repeat gap (min)</label><input id="gap" type="number" value="90"></div>
      <div><label>Seed (opt)</label><input id="seed" placeholder="e.g. 20020701"></div>
      <div><label>&nbsp;</label><button id="go" class="primary">Generate</button></div>
    </div>

    <!-- ... (Tabs remain the same) ... -->
    <div class="tabs"> <button class="tab active" data-tab="yt">YouTube</button> <button class="tab" data-tab="am">Apple Music</button> <button class="tab" data-tab="sp" disabled title="Coming soon">Spotify</button> </div>
    <div class="muted" style="margin:-6px 0 8px 2px">Spotify sign-in is under construction. Coming soon!</div>

    <div class="cols">
      <!-- YouTube -->
      <div class="panel box" id="pane-yt"> <!-- ... (unchanged) ... --> </div>

      <!-- Apple Music Pane -->
      <div class="panel box" id="pane-am" style="display:none">
        <div id="amWrap">
          <p class="muted" style="margin-bottom:8px">Generate a list, sign in, then create or play the playlist.</p>
          <div class="linkRow">
            <button class="btn" id="amSign">Sign in to Apple Music</button>
            <button class="btn" id="amCreate" style="display:none">Create Playlist</button>
            <!-- RENAMED BUTTON -->
            <button class="btn" id="amPlay" style="display:none">Play Playlist</button>
          </div>
          <div id="amMsg" class="muted" style="margin-top:8px"></div>

          <!-- REMOVED Official Apple Music Embed -->

          <!-- Simple Player (Fallback) -->
          <div id="simplePlayer" class="simplePlayer">
            <div class="spRow1">
              <div class="spMeta">
                <div id="spTitle" class="spTitle">—</div>
              </div>
              <div class="spControls">
                <button id="spBtnPrev" class="btn inline ghost" title="Previous">⟨⟨</button>
                <button id="spBtnPlayPause" class="btn inline" title="Play/Pause">▶</button>
                <button id="spBtnNext" class="btn inline ghost" title="Next">⟩⟩</button>
              </div>
            </div>
             <div id="spMsg" class="spMsg"></div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Tracklist -->
  <div class="panel" style="margin-top:16px"> <!-- ... (unchanged) ... --> </div>
</div>

<script>
  // ---------- config & helpers ----------
  const qs = s => document.querySelector(s);
  const API = new URLSearchParams(location.search).get('api') || 'https://timedeck-api.onrender.com';
  const NET_TIMEOUT_MS = 180000;
  const NATIVE_HOST = 'https://tapedecktimemachine.com';
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  function toISO(mmddyyyy){ /* ... unchanged ... */ }
  function setTab(id){ /* ... unchanged ... */ }
  document.querySelectorAll('.tab').forEach(b=>b.onclick=()=>setTab(b.dataset.tab));
  function withTimeout(promise, ms = NET_TIMEOUT_MS) { /* ... unchanged ... */ }

  // ---------- state ----------
  let lastTracks = [];
  let DEV_TOKEN = null;
  let currentPlaylistInfo = { id: null, url: null, storefront: 'us' }; // Store created playlist info

  // ---------- YouTube ----------
  // ... (unchanged) ...
  let player = null, YTapiReady = false;
  (function(){ const tag=document.createElement('script'); tag.src="https://www.youtube.com/iframe_api"; document.head.appendChild(tag); })();
  window.onYouTubeIframeAPIReady = () => { YTapiReady = true; console.log("YT API Ready"); };
  async function simulate(){ /* ... (Reset AM simple player too) ... */ 
    qs('#go').disabled = true;
    qs('#ytStatus').textContent = 'Building…';
    qs('#ytErr').textContent = '';
    qs('#list').innerHTML = '';
    lastTracks = [];
    showSimplePlayer(false); // Hide simple player
    if (player) { try{ player.destroy(); }catch{} player = null; }
    qs('#ytp').innerHTML = '';
    qs('#ytp').style.display = 'none';
    qs('#ytOpen').style.display = 'none';

    try{
      const body = {
        date: toISO(qs('#date').value.trim()),
        genre: qs('#genre').value,
        hours: Number(qs('#hours').value || 3),
        repeat_gap_min: Number(qs('#gap').value || 90),
        seed: (qs('#seed').value.trim() || undefined) ? String(qs('#seed').value.trim()) : undefined,
        limit: 500
      };
      const r = await withTimeout(fetch(`${API}/v1/simulate`, { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body) }));
      if(!r.ok){ const txt = await r.text().catch(()=> ''); throw new Error(`simulate ${r.status}: ${txt}`); }
      const data = await r.json();
      lastTracks = data.tracks || [];
      if(!lastTracks.length){ qs('#ytStatus').textContent=''; qs('#ytErr').textContent='No tracks returned. Try a different date/genre.'; return; }
      renderList(lastTracks);
      buildYouTube(lastTracks);
    }catch(err){
      console.error('[simulate] failed:', err);
      if (!qs('#ytErr').textContent) { qs('#ytErr').textContent = err.message || String(err); }
      qs('#ytStatus').textContent = '';
    } finally {
      qs('#go').disabled = false;
    }
  }
  function renderList(rows){ /* ... unchanged ... */ }
  async function buildYouTube(tracks){ /* ... unchanged ... */ }

  // ---------- Universal Link / custom-scheme listener (native) ----------
  // ... (unchanged) ...
   (function(){
    const Cap = window.Capacitor || {}; const App = Cap.Plugins && Cap.Plugins.App;
    function parseQuery(u){ /* ... */ }
    if (App && App.addListener) {
      App.addListener('appUrlOpen', ({ url }) => {
        /* ... */
        if (q.token) { localStorage.setItem('appleMusicUserToken', q.token); updateAmUIState(); getMusicInstance().catch(e => console.warn("[AM Init BG after native auth]", e)); }
        else { /* ... */ }
      }); console.log('[AM] appUrlOpen listener attached');
    } else { console.warn('[AM] Capacitor App plugin not available for appUrlOpen listener.'); }
  })();


  // ---------- MusicKit Initialization (V11 - Fixed const/let) ----------
  let musicInstance = null; // Holds the instance once configured
  let musicInstancePromise = null; // Tracks the initial configure promise

  function waitForMusicKitLoaded(timeoutMs = 15000) { /* ... unchanged ... */ }
  async function fetchDeveloperToken() { /* ... unchanged ... */ }

  async function configureMusicKit() {
    await waitForMusicKitLoaded();
    const developerToken = await fetchDeveloperToken();

    console.log('[AM Configure] Configuring MusicKit...');
    window.MusicKit.configure({
      developerToken: developerToken,
      app: { name: 'TapeDeck Time Machine', build: 'web' }
    });

    console.log('[AM Configure] Getting instance...');
    // --- CORRECTED FIX: Use 'let' ---
    let instance = null; // Initialize as null, declare with let
    for (let i = 0; i < 5; i++) {
        instance = window.MusicKit.getInstance(); // Assign using let
        if (instance) break;
        console.warn(`[AM Configure] getInstance attempt ${i+1} failed, retrying...`);
        await sleep(200);
    }
    // --- END FIX ---
    if (!instance) throw new Error('MusicKit instance failed after configure and retries.');

    console.log('[AM Configure] Instance obtained.');
    instance.storefrontId = instance.storefrontId || window.mkDefaultStorefront || 'us';
    console.log('[AM Configure] Storefront set to:', instance.storefrontId);

    const storedToken = localStorage.getItem('appleMusicUserToken');
    if (storedToken && !instance.musicUserToken) {
      instance.musicUserToken = storedToken;
      console.log('[AM Configure] Applied stored user token.');
    }

    // --- Register Event Listeners ---
    instance.removeEventListener('authorizationStatusDidChange', handleAuthorizationStatusChange);
    instance.addEventListener('authorizationStatusDidChange', handleAuthorizationStatusChange);
    console.log('[AM Configure] Attached auth listener.');
    
    // Attach Simple Player listeners
    instance.removeEventListener('playbackStateDidChange', simplePlayerStateChanged);
    instance.removeEventListener('nowPlayingItemDidChange', simplePlayerItemChanged);
    instance.addEventListener('playbackStateDidChange', simplePlayerStateChanged);
    instance.addEventListener('nowPlayingItemDidChange', simplePlayerItemChanged);
    console.log('[AM Configure] Attached player listeners.');
    // --- End Register Event Listeners ---

    console.log('[AM Configure] Initial configuration complete. Current auth status:', instance.authorizationStatus);
    return instance;
  }

  function getMusicInstance() {
    if (musicInstance) return Promise.resolve(musicInstance);
    if (!musicInstancePromise) {
      musicInstancePromise = configureMusicKit()
        .then(instance => {
          musicInstance = instance; // Cache it
          console.log('[AM GetInstance] Initialization successful.');
          updateAmUIState(); // Update UI
          return instance;
        })
        .catch(e => {
          console.error('[AM GetInstance] Initialization failed:', e);
          qs('#amMsg').textContent = 'Failed to initialize Apple Music: ' + (e.message || e);
          musicInstancePromise = null; // Allow retry
          musicInstance = null;
          throw e;
        });
    }
    return musicInstancePromise;
  }

  // Centralized UI Update Function
  function updateAmUIState() {
      const hasToken = !!localStorage.getItem('appleMusicUserToken');
      console.log('[AM UI Update] Updating UI based on token presence:', hasToken);
      qs('#amSign').style.display = hasToken ? 'none' : 'inline-block';
      qs('#amCreate').style.display = hasToken ? 'inline-block' : 'none';
      // Show Play button if signed in (it will check for tracks on click)
      qs('#amPlay').style.display = hasToken ? 'inline-block' : 'none';

      if (hasToken) {
          if (qs('#amMsg').textContent.startsWith('Sign-in') || qs('#amMsg').textContent.startsWith('Error') || qs('#amMsg').textContent.startsWith('Failed')) {
              qs('#amMsg').textContent = 'Signed in. Generate a list to play or create.';
          }
      } else {
          // Hide players on sign out
          showSimplePlayer(false);
          if (!qs('#amMsg').textContent.startsWith('Error') && !qs('#amMsg').textContent.startsWith('Failed')) {
              qs('#amMsg').textContent = '';
          }
      }
  }

  // Event Handler for Auth Changes
  function handleAuthorizationStatusChange(event) {
      console.log('[AM Event] Auth status changed:', event.authorizationStatus);
      const instance = musicInstance || event.target || window.MusicKit.getInstance();
      if (event.authorizationStatus === 'authorized' && instance && instance.musicUserToken) {
          localStorage.setItem('appleMusicUserToken', instance.musicUserToken);
      } else {
           localStorage.removeItem('appleMusicUserToken');
      }
      updateAmUIState(); // Update UI
  }
  // --- End MusicKit Initialization ---


  // ---------- Native-first sign-in (Browser.open) ----------
  async function amSignIn(){ /* ... unchanged ... */ }

  // ---------- REST API Search Helper ----------
  async function appleCatalogSearch(term, storefront = 'us', limit = 1) {
      const devToken = await fetchDeveloperToken();
      if (!devToken) { console.error("appleCatalogSearch: Dev token not available."); return null; }
      const url = `https://api.music.apple.com/v1/catalog/${encodeURIComponent(storefront)}/search?term=${encodeURIComponent(term)}&limit=${limit}&types=songs`;
      try {
          const r = await fetch(url, { headers: { 'Authorization': `Bearer ${devToken}` } });
          if (!r.ok) { console.warn(`REST Search failed (${r.status}) for: ${term}`); return null; }
          return await r.json();
      } catch (e) { console.warn(`REST Search network error for "${term}":`, e); return null; }
  }


  // ---------- Play Playlist (Programmatic + Custom UI) ----------
  async function amPlayPlaylist() {
    qs('#amMsg').textContent = '';
    showSimplePlayer(false); // Hide old player
    
    let m;
    try {
      console.log('[AM Play] Getting MusicKit instance...');
      m = await getMusicInstance(); // Ensures configured

      if (!m || !m.isAuthorized) {
        console.log('[AM Play] Not authorized.');
        qs('#amMsg').textContent = 'Sign-in required. Please click "Sign in to Apple Music".';
        updateAmUIState(); return;
      }

      console.log('[AM Play] Waiting for API readiness...');
      qs('#amMsg').textContent = 'Connecting to Apple Music API...';
      let apiReady = false;
      for (let i = 0; i < 15; i++) { // Retry up to 15 times (3 seconds total)
          if (m && m.api && typeof m.api.search === 'function') {
              apiReady = true; console.log(`[AM Play] API ready after ${i} retries.`); break;
          }
          console.warn(`[AM Play] API not ready on instance 'm', retry ${i+1}...`); await sleep(200);
      }
      if (!apiReady) throw new Error('MusicKit API failed to become ready in time.');

      m.storefrontId = m.storefrontId || 'us';
      console.log('[AM Play] Instance ready for search with storefront:', m.storefrontId);

    } catch (e) {
      console.error('[AM Play] init/check failed:', e);
      qs('#amMsg').textContent = 'Apple Music connection issue: ' + (e.message || e);
      updateAmUIState(); return;
    }

    if (!lastTracks?.length) { qs('#amMsg').textContent = 'Generate a tracklist first.'; return; }

    // --- Search logic ---
    qs('#amMsg').textContent = `Searching for ${lastTracks.length} tracks...`;
    const songIds = [];
    let i = 0;
    const storefront = m.storefrontId;
    for (const t of lastTracks) {
      i++;
      if (i % 5 === 0 || i === lastTracks.length) { qs('#amMsg').textContent = `Searching... (${i}/${lastTracks.length})`; }
      try {
        const term = `${t.artist} ${t.title}`; let id = null;
        if (m.api && typeof m.api.search === 'function') {
            try { const res = await withTimeout(m.api.search(term, { types: ['songs'], limit: 1, storefront: storefront }), 5000); id = res?.songs?.data?.[0]?.id; }
            catch (apiSearchErr) { console.warn(`MusicKit API search failed for "${term}", trying REST:`, apiSearchErr); id = null; }
        } else { console.warn(`MusicKit API search not available, falling back to REST for: ${term}`); }
        if (!id) { console.log(`[AM Play] Falling back to REST search for: ${term}`); const res = await appleCatalogSearch(term, storefront, 1); id = res?.results?.songs?.data?.[0]?.id; }
        if (id) { songIds.push(id); } else { console.warn(`[AM Play] Track not found in ${storefront}: ${term}`); }
        await sleep(100);
      } catch (e) { console.warn(`[AM Play] search loop error for "${t.artist} - ${t.title}":`, e); }
    }

    if (!songIds.length) { qs('#amMsg').textContent = 'None of the tracks could be found in Apple Music.'; return; }

    qs('#amMsg').textContent = `Found ${songIds.length} tracks. Adding to queue...`;
    try {
      await m.setQueue({ songs: songIds });
      await m.play();
      showSimplePlayer(true); // Show the simple player
      // UI updates will be handled by the event listeners
      qs('#amMsg').textContent = `Now playing ${songIds.length} tracks!`;
    } catch (e) { console.error('[AM Play] playback failed:', e); qs('#amMsg').textContent = 'Error starting playback: ' + (e.message || e); }
  }

  // ---------- Create playlist (shared) ----------
  async function amCreatePlaylist(){
    const userToken = localStorage.getItem('appleMusicUserToken');
    if(!userToken){ qs('#amMsg').textContent='Please sign in first.'; updateAmUIState(); return; }
    if(!lastTracks?.length){ qs('#amMsg').textContent='Generate a tracklist first.'; return; }

    qs('#amMsg').textContent='Creating playlist…';
    showSimplePlayer(false); // Hide simple player
    qs('#embedWrap').style.display = 'none'; // Hide embed

    try{
      const name = `TimeDeck — ${qs('#date').value} — ${qs('#genre').value.toLowerCase()}`;
      const r = await withTimeout(fetch(`${API}/v1/apple/create-playlist`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userToken, name, tracks: lastTracks.map(t=>({artist:t.artist,title:t.title})) })
      }));
      if(!r.ok){
        const j = await r.json().catch(() => ({ detail: 'Unknown error during create' }));
        throw new Error(j.detail || `Create failed with status ${r.status}`);
      }
      const j = await r.json();
      const { playlist_id, playlist_url, storefront, added_count, total_tracks_searched } = j || {};

      if (!playlist_id) throw new Error("Playlist created, but backend didn't return an ID.");

      // Store playlist info
      currentPlaylistInfo.id = playlist_id;
      currentPlaylistInfo.url = playlist_url;
      currentPlaylistInfo.storefront = storefront || 'us';
      
      qs('#amMsg').textContent = `Playlist created! Added ${added_count} of ${total_tracks_searched} tracks.`;
      
      // --- Attempt to load Embed ---
      let embedUrl = playlist_url ? deriveEmbedFromUrl(playlist_url) : null;
      if (!embedUrl && playlist_id) embedUrl = buildEmbedFromId(playlist_id, currentPlaylistInfo.storefront);
      const openUrl = playlist_url || (playlist_id ? `https://music.apple.com/${currentPlaylistInfo.storefront}/playlist/${encodeURIComponent(playlist_id)}` : '#');

      if (embedUrl) {
        console.log('[AM Create] Attempting to load embed:', embedUrl);
        showEmbed(embedUrl, openUrl); // This function now handles showing the embedWrap
        qs('#embedNote').textContent = 'If player stays blank, playlist might be private. Use "Simple Player".';
        qs('#embedNote').style.display = 'block';
      } else {
        console.warn('[AM Create] Could not generate an embed URL.');
        showEmbed(null, openUrl, true); // Show with error
        qs('#amMsg').textContent = `Playlist created! Added ${added_count}. Embed unavailable.`;
      }

    } catch(e){
      console.error('[AM Create] Failed:', e);
      qs('#amMsg').textContent = 'Create failed: ' + (e.message || String(e));
    }
    // Update UI state *after* create is done (to show simple player button)
    updateAmUIState();
  }

  // --- Show Embed Function ---
  function showEmbed(embedUrl, openUrl, showError = false){
    const wrap = qs('#embedWrap');
    const frame = qs('#amEmbed');
    const note = qs('#embedNote');
    qs('#openInAm').href = openUrl || '#';
    wrap.style.display = 'block'; // Show the wrapper

    if (embedUrl && !showError) {
        frame.src = embedUrl;
        frame.style.display = 'block';
        note.textContent = 'If player stays blank, playlist might be private. Use "Simple Player".';
        note.style.display = 'block';
    } else {
        frame.style.display = 'none'; // Hide iframe
        note.textContent = 'Could not render an embed for this playlist. Use "Simple Player" or "Open in Apple Music".';
        note.style.display = 'block';
    }
  }

  // --- Copy Link Helper ---
  qs('#copyLink').onclick = async () => { /* ... unchanged ... */ };


  // ---------- Simple Programmatic Player (Fallback) ----------
  let simplePlayerInterval = null; // To update simple player time

  function showSimplePlayer(show = true) { /* ... unchanged ... */ }
  function updateSimplePlayerUI() {
      if (!musicInstance || !musicInstance.player || !musicInstance.player.nowPlayingItem) {
          qs('#spTitle').textContent = '—';
          qs('#spBtnPlayPause').textContent = '▶';
          return;
      }
      const item = musicInstance.player.nowPlayingItem;
      const attr = item.attributes || {};
      // Show Artist - Title
      qs('#spTitle').textContent = `${attr.artistName || '?'} - ${attr.name || '?'}`; 
      qs('#spBtnPlayPause').textContent = musicInstance.player.isPlaying ? '⏸' : '▶';
  }
  function simplePlayerStateChanged(event) {
      console.log('[AM Simple Player] State changed:', event.state);
      updateSimplePlayerUI();
      // Remove time/seek logic from here
  }
  function simplePlayerItemChanged(event) {
      console.log('[AM Simple Player] Item changed');
      updateSimplePlayerUI();
  }

  async function amPlaySimple() {
    qs('#amMsg').textContent = '';
    qs('#embedWrap').style.display = 'none'; // Hide embed
    showSimplePlayer(false); // Hide old player

    let m;
    try {
      console.log('[AM Play Simple] Getting MusicKit instance...');
      m = await getMusicInstance();

      if (!m || !m.isAuthorized) {
        console.log('[AM Play Simple] Not authorized.');
        qs('#amMsg').textContent = 'Sign-in required.';
        updateAmUIState(); return;
      }

      const playlistId = currentPlaylistInfo.id; // Get ID from create step
      if (!playlistId) {
          qs('#amMsg').textContent = 'Please create a playlist first.';
          return;
      }

      if (!m.player || typeof m.play !== 'function' || typeof m.setQueue !== 'function') {
           console.error('[AM Play Simple] Player API not ready.');
           throw new Error('MusicKit Player failed to become ready.');
      }
      console.log('[AM Play Simple] Instance ready for playback.');

    } catch (e) {
      console.error('[AM Play Simple] init/check failed:', e);
      qs('#amMsg').textContent = 'Apple Music connection issue: ' + (e.message || e);
      updateAmUIState(); return;
    }

    qs('#amMsg').textContent = `Loading playlist...`;
    try {
      console.log('[AM Play Simple] Setting queue with playlist ID:', playlistId);
      // This sets the queue to the *library* playlist
      await m.setQueue({ playlist: playlistId }); 

      // Event listeners are already registered in configureMusicKit
      await m.play();
      showSimplePlayer(true); // Show the simple player UI
      updateSimplePlayerUI(); // Update with initial track
      qs('#amMsg').textContent = `Now playing created playlist!`;
      qs('#spMsg').textContent = '';
    } catch (e) {
      console.error('[AM Play Simple] playback failed:', e);
      qs('#amMsg').textContent = 'Error starting simple playback: ' + (e.message || e);
      qs('#spMsg').textContent = 'Playback Error: ' + (e.message || e);
      showSimplePlayer(true);
    }
  }

  // --- Simple Player Controls Wiring ---
  qs('#spBtnPlayPause').onclick = async () => {
    try { 
        const m = await getMusicInstance(); 
        if (!m || !m.player) return;
        if (m.player.isPlaying) {
            await m.pause();
        } else {
            await m.play();
        }
        // Event listener (simplePlayerStateChanged) will update the icon
    } catch(e){ console.error("SP Play/pause error:", e);}
  };
  qs('#spBtnPrev').onclick = async () => {
     try { const m = await getMusicInstance(); if(m) await m.skipToPreviousItem(); } catch(e){ console.warn("SP Skip Previous failed:", e); }
  };
  qs('#spBtnNext').onclick = async () => {
     try { const m = await getMusicInstance(); if(m) await m.skipToNextItem(); } catch(e){ console.warn("SP Skip Next failed:", e); }
  };


  // ---------- Initialize MusicKit on Load ----------
  document.addEventListener('DOMContentLoaded', () => {
      console.log('[AM Init] DOMContentLoaded, attempting initial MusicKit setup...');
      // Retrieve stored playlist info on load
      currentPlaylistInfo.id = localStorage.getItem('applePlaylistId');
      currentPlaylistInfo.url = localStorage.getItem('applePlaylistUrl');
      currentPlaylistInfo.storefront = localStorage.getItem('applePlaylistStorefront') || 'us';

      getMusicInstance().catch(e => {
          console.error("Initial MusicKit setup failed on load:", e);
      });
      // Update UI based on stored token *immediately*
      updateAmUIState();
  });

  // ---------- wire up ----------
  qs('#go').onclick = simulate;
  qs('#amSign').onclick = amSignIn;
  qs('#amCreate').onclick = amCreatePlaylist;
  qs('#amPlay').onclick = amPlayPlaylist; // RENAMED this button
  qs('#amPlaySimpleBtn').onclick = amPlaySimple; // This button ID is from the old file, let's wire it just in case

  setTab('yt');
</script>

</body>
</html>

