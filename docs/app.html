<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TapeDeck Time Machine</title>

  <script src="https://js-cdn.music.apple.com/musickit/v3/musickit.js"></script>

  <meta name="description" content="Rewind the radio you grew up with. Generate playlists from any date and genre, powered by Billboard chart data.">
  <link rel="icon" href="/logo.svg" type="image/svg+xml">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/logo.svg">


  <meta property="og:type" content="website">
  <meta property="og:url" content="https://tapedecktimemachine.com/">
  <meta property="og:title" content="TapeDeck Time Machine - Historical Music Playlist Generator">
  <meta property="og:description" content="Rewind the radio you grew up with. Generate playlists from any date and genre.">
  <meta property="og:image" content="https://tapedecktimemachine.com/AppIcon.png">
  <meta property="og:image:width" content="1200"><meta property="og:image:height" content="630">
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://tapedecktimemachine.com/">
  <meta property="twitter:title" content="TapeDeck Time Machine - Historical Music Playlist Generator">
  <meta property="twitter:description" content="Rewind the radio you grew up with. Generate playlists from any date and genre.">
  <meta property="twitter:image" content="https://tapedecktimemachine.com/AppIcon.png">

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HPZT6BMJVD"></script>
  <script>
    window.dataLayer=window.dataLayer||[];
    function gtag(){dataLayer.push(arguments)}
    gtag('js',new Date()); gtag('config','G-HPZT6BMJVD');
  </script>

  <style>
    :root{--bg:#0a0f17;--panel:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#8b5cf6;--accent2:#22d3ee;--shadow:0 12px 48px rgba(2,10,20,.45)}
    *{box-sizing:border-box}
    body{margin:0;background:
      radial-gradient(1200px 600px at 10% -10%, #0e1630 0%, transparent 60%),
      radial-gradient(700px 400px at 120% 10%, #06101f 0%, transparent 60%), #0a0f17;
      color:var(--text); font:16px/1.5 -apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1100px;margin:40px auto;padding:0 18px}
    .bar{display:flex;align-items:center;gap:14px;flex-wrap:wrap}
    .logo{width:36px;height:36px;border-radius:12px;background:
      linear-gradient(135deg,#8b5cf6 0%,#22d3ee 55%,#16a34a 120%);
      display:grid;place-items:center;color:#fff;font-weight:800;box-shadow:var(--shadow);text-decoration:none}
    h1{font-size:22px;margin:0}
    .social{display:flex;gap:12px;font-size:13px;margin-left:auto}
    .social a{text-decoration:none;opacity:0.7;transition:opacity 0.2s}
    .social a:hover{opacity:1}
    @media (max-width:600px){.social{margin-left:0;width:100%;margin-top:8px}}

    .panel{background:rgba(17,24,39,.75);border:1px solid rgba(148,163,184,.12);
      border-radius:18px;padding:16px;box-shadow:var(--shadow);overflow:hidden}
    .grid{display:grid;grid-template-columns:1.2fr 1fr 1fr 1fr 1fr auto;gap:12px;align-items:end}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px 2px}
    input,select,button{width:100%; min-width: 0; padding:12px;border-radius:12px;border:1px solid rgba(148,163,184,.18);
      background:#0c1422;color:var(--text);outline:none;font-size:1rem;max-width:100%;box-sizing:border-box}

    input[type="date"] { color-scheme: dark; width:100%; max-width:100%; min-width: 0; }
    input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.8); }

    button.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));border:0;font-weight:700;cursor:pointer}
    button.primary:disabled{opacity:0.6;background:var(--panel);cursor:not-allowed}
    .tabs{display:flex;gap:10px;margin:14px 0 8px; flex-wrap: wrap;}
    .tab{padding:9px 14px;border-radius:999px;border:1px solid rgba(148,163,184,.2);background:#0c1422;color:var(--text);cursor:pointer}
    .tab.active{background:linear-gradient(135deg,rgba(139,92,246,.25),rgba(34,211,238,.18));border-color:transparent}
    .tab:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Default to single column layout */
    .cols{display:grid;grid-template-columns:1fr; gap:16px}
    .box{min-height:auto}
    .grid > div { min-width: 0; } /* prevent field overflow in grid cells */

    /* Make cols 2-column only on larger screens */
    @media (min-width: 901px) {
       .cols{grid-template-columns:1.05fr .95fr;}
       #pane-sp { grid-column: span 1 / span 1; }
    }


    #ytp{max-width:100%;overflow:hidden}
    #ytp iframe{width:100%;max-width:100%;height:auto;min-height:300px; aspect-ratio: 16/9; border-radius:12px;box-shadow:var(--shadow);display:block}
    .btn{display:inline-block;margin-top:8px;padding:10px 14px;border-radius:12px;border:1px solid rgba(148,163,184,.2);
      background:#0c1422;color:#e5e7eb;text-decoration:none;font-weight:700;cursor:pointer}
    .muted{color:var(--muted)}
    .list{padding:12px 8px;max-height:420px;overflow:auto}
    .row{display:grid;grid-template-columns:110px 1fr;gap:14px;padding:10px 6px;border-bottom:1px dashed rgba(148,163,184,.12)}
    .ts{font:12px/1.3 ui-monospace,SFMono-Regular,Menlo,monospace;color:var(--muted)}
    .err{color:#fda4af;margin-top:6px}

    /* Mini-player (Apple Music) */
    .mini{display:none;margin-top:12px;background:rgba(12,20,34,.8);border:1px solid rgba(148,163,184,.12);border-radius:14px;padding:10px 12px}
    .mini .np{display:flex;align-items:center;gap:16px}
    .mini .np-text{min-width:0;flex:1; overflow: hidden;}
    .mini .title{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .mini .artist{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .mini .controls{display:flex;align-items:center;gap:8px}
    .mini .icon{width:44px;min-width:44px;height:40px;border-radius:10px;border:1px solid rgba(148,163,184,.22);background:#0c1422;color:#e5e7eb;cursor:pointer}
    .mini .open{padding:9px 12px;border-radius:10px;border:1px solid rgba(148,163,184,.22);background:#0c1422;color:#e5e7eb;text-decoration:none}

    /* Visualizer Canvas */
    #viz { width:100%; height:220px; border-radius:12px; background:linear-gradient(180deg,rgba(139,92,246,.08),rgba(34,211,238,.06)); }

    @media (max-width:900px){
      .grid{grid-template-columns: 1fr 1fr; gap: 10px;}
      #ytp iframe{min-height:220px}
      .cols{grid-template-columns:1fr;}
      #pane-sp { grid-column: span 1 / span 1; }
      #pane-am-right { display: none; }
      .wrap{padding:0 12px}
    }
    @media (max-width:600px){
      .grid{grid-template-columns: 1fr; gap: 8px;}
      input,select,button{padding:10px;font-size:0.95rem}
      label{font-size:11px}
    }
    @media (max-width:500px){
      #ytp iframe{min-height:200px}
      .panel{padding:12px}
    }
  </style>
</head>
<body>

<div class="wrap">
  <div class="bar" style="margin-bottom:14px">
    <a class="logo" href="/index.html" title="Back to home">TD</a>
    <h1>TapeDeck Time Machine</h1>
    <div class="social">
      <a href="https://medium.com/@anthony.klemm" target="_blank" rel="noopener">üìù Medium</a>
      <a href="https://www.linkedin.com/in/anthony-klemm-57886512" target="_blank" rel="noopener">üíº LinkedIn</a>
    </div>
  </div>

  <div class="panel">
    <div class="grid">
      <div><label>Date</label><input id="date" type="date" value="2002-07-01"></div>
      <div><label>Genre</label>
        <select id="genre">
          <option>Alternative</option><option>Hot-100</option><option>Pop</option>
          <option>Rock</option><option>Country</option><option>R&B/Hip-Hop</option><option>Dance/Electronic</option>
        </select>
      </div>
      <div><label>Hours</label><select id="hours"><option>0.5</option><option selected>1</option><option>2</option><option>3</option></select></div>
      <div><label>Repeat gap (min)</label><input id="gap" type="number" value="90"></div>
      <div><label>Seed (opt)</label><input id="seed" placeholder="e.g. 20020701"></div>
      <div><label>¬†</label><button id="go" class="primary">Generate</button></div>
    </div>

    <div class="tabs">
      <button class="tab" data-tab="yt">YouTube</button>
      <button class="tab active" data-tab="am">Apple Music</button>
      <button class="tab" data-tab="sp">Spotify</button>
    </div>

    <div class="cols">
      <div class="panel box" id="pane-am-left" style="display: block;">
        <p class="muted" style="margin-bottom:8px">
          Generate a list, sign in, and create the playlist.
        </p>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn" id="amSign">Sign in to Apple Music</button>
          <button class="btn" id="amCreate" style="display:none">Create Playlist</button>
          </div>
        <div id="amMsg" class="muted" style="margin-top:8px"></div>
        <div id="mini" class="mini">
          <div class="np">
            <div class="np-text">
              <div class="title" id="miniTitle">‚Äî</div>
              <div class="artist" id="miniArtist">‚Äî</div>
            </div>
            <div class="controls">
              <button id="btnPrev" class="icon" title="Previous">‚ü®‚ü®</button>
              <button id="btnPlayPause" class="icon" title="Play">‚ñ∂</button>
              <button id="btnNext" class="icon" title="Next">‚ü©‚ü©</button>
              <a id="miniOpen" class="open" href="#" target="_blank" rel="noopener">Open ‚Üó</a>
            </div>
          </div>
        </div>
      </div>

      <div class="panel box" id="pane-am-right" style="display: block;">
         <div id="side-viz">
            <div class="muted" style="margin-bottom: 4px;">Visualizer</div>
            <canvas id="viz" width="600" height="220"></canvas>
         </div>
      </div>

      <div class="panel box" id="pane-yt" style="display:none">
        <div id="ytWrap">
          <div class="muted" id="ytStatus">Waiting for a simulation‚Ä¶</div>
          <div id="ytp"></div>
          <a class="btn" id="ytOpen" href="#" target="_blank" rel="noopener" style="display:none">Open in YouTube</a>
          <div id="ytErr" class="err"></div>
        </div>
      </div>

      <div class="panel box" id="pane-sp" style="display:none;">
        <p class="muted" style="margin-bottom:8px">
          <strong>Spotify sign in is only available for users registered in TapeDeck Time Machine's early-adopters group. If you are interested in joining, email support@tapedecktimemachine.com your request.</strong> Sign in to your Spotify account to create and save playlists.
        </p>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn" id="spSign">Sign in to Spotify</button>
          <button class="btn" id="spCreate" style="display:none">Create Playlist</button>
        </div>
        <div id="spMsg" class="muted" style="margin-top:8px"></div>
        </div>

    </div> </div> <div class="panel" style="margin-top:16px">
    <h2>Your Music Time Machine Playlist</h2>
    <p class="muted" style="margin-bottom:6px">
      Ever wonder <strong>what songs were popular on your birthday?</strong>
      Just pick a date and genre, and we'll <strong>generate a music playlist</strong>
      of the top songs from that week, based on <strong>historical Billboard charts</strong>.
      The tracklist will appear below.
    </p>
    <div id="list" class="list"></div>
  </div>
</div>

<script>
  /* ===== Helpers & config ===== */
  const qs = s => document.querySelector(s);
  const API = new URLSearchParams(location.search).get('api') || 'https://timedeck-api.onrender.com';
  const NET_TIMEOUT_MS = 180000;
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
  function withTimeout(p,ms=NET_TIMEOUT_MS){ let t; const timer=new Promise((_,rej)=>{t=setTimeout(()=>rej(new Error(`Network timeout after ${Math.round(ms/1000)}s`)),ms)}); return Promise.race([p.finally(()=>clearTimeout(t)),timer]); }

  /* ===== Tabs ===== */
  function setTab(id){
    document.querySelectorAll('.tab[data-tab]').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
    const yt=qs('#pane-yt'), aml=qs('#pane-am-left'), amr=qs('#pane-am-right'), sp=qs('#pane-sp');
    const vizContainer = qs('#side-viz');

    // Hide all main content panes by default
    aml.style.display='none'; yt.style.display='none'; sp.style.display='none';
    amr.style.display = 'none';

    if(id==='yt'){
      yt.style.display='';
      stopViz();
      if(lastTracks.length > 0 && !player) buildYtPlayer(lastTracks);
    } else if (id === 'sp') {
      // Spotify left pane + show shared right pane for visualizer
      sp.style.display='';
      amr.style.display='';
      amr.appendChild(vizContainer);
      startViz();
    } else { // Default to Apple Music
      aml.style.display='';
      amr.style.display='';
      amr.appendChild(vizContainer);
      startViz();
    }
  }
  document.querySelectorAll('.tab[data-tab]').forEach(b=>b.onclick=()=>setTab(b.dataset.tab));

  /* ===== State ===== */
  let lastTracks=[]; let resolvedSongIds=[]; let DEV_TOKEN=null;
  let lastToggleTS=0;
  let amPlayLock = false; // For Apple Music play/pause guard

  /* ===== YouTube minimal ===== */
  let player=null, YTapiReady=false;
  (function(){ const s=document.createElement('script'); s.src="https://www.youtube.com/iframe_api"; document.head.appendChild(s); })();
  window.onYouTubeIframeAPIReady=()=>{YTapiReady=true;};

  async function fetchSimulation(){
    const body={date:qs('#date').value.trim(),genre:qs('#genre').value,hours:Number(qs('#hours').value||3),
      repeat_gap_min:Number(qs('#gap').value||90),seed:(qs('#seed').value.trim()||undefined)?String(qs('#seed').value.trim()):undefined,limit:500};

    // Reset relevant UI areas before fetching
    if(player){try{player.destroy();}catch{} player=null;} qs('#ytp').innerHTML=''; qs('#ytOpen').style.display='none';
    qs('#list').innerHTML='<div class="muted">Generating...</div>';
    lastTracks=[]; resolvedSongIds=[];
    qs('#amMsg').textContent = ''; qs('#spMsg').textContent = '';
    qs('#ytStatus').textContent = ''; qs('#ytErr').textContent = '';


    try{
      const r=await withTimeout(fetch(`${API}/v1/simulate`,{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(body)}));
      if(!r.ok){ const txt=await r.text().catch(()=> ''); throw new Error(`simulate ${r.status}: ${txt}`); }
      const data=await r.json(); lastTracks=data.tracks||[];
      if(!lastTracks.length){
        qs('#list').innerHTML = '<div class="muted">No tracks returned. Try a different date/genre.</div>';
        qs('#ytStatus').textContent=''; qs('#ytErr').textContent='No tracks returned.';
        qs('#amMsg').textContent='No tracks returned.';
        qs('#spMsg').textContent='No tracks returned.';
        return false;
      }
      renderList(lastTracks);
      return true;
    }catch(err){
      qs('#list').innerHTML = `<div class="err">Error generating list: ${err.message || String(err)}</div>`;
      qs('#ytStatus').textContent=''; qs('#ytErr').textContent=err.message||String(err);
      qs('#amMsg').textContent='Error generating list: '+(err.message||String(err));
      qs('#spMsg').textContent='Error generating list: '+(err.message||String(err));
      return false;
    }
  }

  async function simulate(){
    const btn = qs('#go');
    btn.disabled = true; btn.textContent = 'Building‚Ä¶';
    qs('#ytStatus').textContent='Building‚Ä¶'; qs('#ytErr').textContent='';
    qs('#amMsg').textContent='Building playlist‚Ä¶'; qs('#spMsg').textContent='Building playlist‚Ä¶';

    const success = await fetchSimulation();
    btn.disabled = false; btn.textContent = 'Generate';

    if(success){
      qs('#amCreate').style.display = localStorage.getItem('appleMusicUserToken') ? 'inline-block' : 'none';
      qs('#amMsg').textContent = localStorage.getItem('appleMusicUserToken') ? 'Playlist ready.' : 'Playlist ready. Sign in to create.';

      qs('#spCreate').style.display = localStorage.getItem('spotifyAccessToken') ? 'inline-block' : 'none';
      qs('#spMsg').textContent = localStorage.getItem('spotifyAccessToken') ? 'Playlist ready. Click Create Playlist.' : 'Playlist ready. Sign in to create it on Spotify.';

      if(qs('.tab[data-tab="yt"]').classList.contains('active')){
        buildYtPlayer(lastTracks);
      }
    }
  }

  async function buildYtPlayer(tracks){
     if(!tracks?.length) return;
    qs('#ytStatus').textContent='Resolving YouTube videos‚Ä¶'; qs('#ytErr').textContent='';
    try {
      const r = await withTimeout(fetch(`${API}/v1/yt/resolve`, {
        method: 'POST', headers: {'content-type': 'application/json'},
        body: JSON.stringify({tracks, limit: 50})
      }));
      if(!r.ok){ const txt=await r.text().catch(()=>"" ); throw new Error(`yt/resolve ${r.status}: ${txt}`); }
      const {ids} = await r.json();
      if(!ids?.length) throw new Error('No YouTube videos found for this playlist.');

      qs('#ytStatus').textContent='Loading player‚Ä¶';
      if(player){try{player.destroy();}catch{} player=null;} qs('#ytp').innerHTML='';

      let tries=0; while(!YTapiReady && tries<100){ await sleep(100); tries++; }
      if(!YTapiReady) throw new Error('YouTube API failed to load.');

      player = new YT.Player('ytp', {
        height: '360', width: '640',
        playerVars: { playlist: ids.join(','), autoplay: 1, controls: 1, loop: 1 },
        events: {
          'onReady': () => {
            qs('#ytStatus').textContent = `Playing ${ids.length} videos.`;
            const plUrl = `https://www.youtube.com/playlist?list=${ids.join(',')}`;
            qs('#ytOpen').href = plUrl;
            qs('#ytOpen').style.display = 'inline-block';
          },
          'onError': (e) => { qs('#ytErr').textContent = `Youtubeer Error: ${e.data}`; }
        }
      });
    } catch(err) {
      qs('#ytStatus').textContent=''; qs('#ytErr').textContent=err.message||String(err);
    }
  }

  function renderList(rows){
    if(!rows?.length){ qs('#list').innerHTML='<div class="muted">No tracks.</div>'; return; }
    const frag=document.createDocumentFragment();
    rows.slice(0,500).forEach(t=>{
      const d=document.createElement('div'); d.className='row';
      d.innerHTML=`<div class="ts">${t.timestamp.replace('T',' ')}</div>
                <div><strong>${t.artist}</strong> ‚Äî <em>${t.title}</em>
                <span class="muted">‚Ä¢ ${t.source_rank ?? ''}</span></div>`;
      frag.appendChild(d);
    });
    qs('#list').replaceChildren(frag);
  }

  /* ===== MusicKit setup ===== */
  let music=null, musicInitPromise=null;
  
  // (Filled from old file)
  function waitForMusicKitLoaded(timeoutMs = 10000){
    if (window.MusicKit && typeof window.MusicKit.getInstance === 'function') return Promise.resolve();
    return new Promise((resolve, reject) => {
      const t = setTimeout(()=>reject(new Error('MusicKit load timed out')), timeoutMs);
      window.addEventListener('musickitloaded', () => { clearTimeout(t); resolve(); }, { once:true });
    });
  }
  
  // (Created from old file logic)
  async function fetchDeveloperToken(){
      const r = await withTimeout(fetch(`${API}/v1/apple/dev-token`));
      if(!r.ok) throw new Error(`dev-token ${r.status}`);
      const { token: developerToken, storefront } = await r.json();
      return { developerToken, storefront };
  }
  
  // (Filled and adapted from old file)
  async function getWebMusicInstance(force=false){
    if (music && !force) return music;
    if (musicInitPromise && !force) return musicInitPromise;

    musicInitPromise = (async () => {
      await waitForMusicKitLoaded();
      
      const { developerToken, storefront } = await fetchDeveloperToken();

      window.MusicKit.configure({ developerToken, app:{ name:'TapeDeck Time Machine', build:'web' } });

      let inst = null;
      for (let i=0;i<40;i++){
        inst = (window.MusicKit.getInstance && window.MusicKit.getInstance()) || null;
        if (inst && typeof inst.play === 'function') break;
        await sleep(50);
      }
      if (!inst) throw new Error('MusicKit instance not ready');

      inst.storefrontId = storefront || 'us';
      music = inst;

      // Wire up event listeners for the mini-player
      music.addEventListener('mediaItemDidChange', () => updateNowPlaying(music, true));
      music.addEventListener('playbackStateDidChange', () => {
        updateNowPlaying(music, false);
        setPlayIcon(music.isPlaying);
      });

      return music;
    })().catch(e=>{ musicInitPromise = null; throw e; });
    
    return musicInitPromise;
  }

  /* ===== Sign-in / Create (Apple Music) ===== */
  function showAmControls(){
    qs('#amSign').style.display='none';
    qs('#amCreate').style.display='inline-block';
  }
  
  // (Filled and adapted from old file)
  async function amSignIn(){
    qs('#amMsg').textContent = 'Signing in to Apple Music...';
    try {
      const m = await getWebMusicInstance();
      const userToken = await m.authorize(); // This triggers the popup
      
      localStorage.setItem('appleMusicUserToken', userToken);
      
      qs('#amMsg').textContent = 'Signed in! You can now create playlists.';
      showAmControls();
    } catch(e) {
      console.error('[AM SignIn] failed', e);
      qs('#amMsg').textContent = 'Sign in failed: ' + (e.message || String(e));
    }
  }
  
  async function amCreatePlaylist(){
    const userToken=localStorage.getItem('appleMusicUserToken');
    if(!userToken){qs('#amMsg').textContent='Please sign in first.'; return;}
    if(!lastTracks?.length){qs('#amMsg').textContent='Generate a tracklist first.'; return;}
    qs('#amMsg').textContent='Creating playlist‚Ä¶';
    const btn = qs('#amCreate'); btn.disabled = true;
    try{
      const name=`TapeDeckTimeMachine - ${qs('#date').value} - ${qs('#genre').value}`;
      const r=await withTimeout(fetch(`${API}/v1/apple/create-playlist`,{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({userToken,name,tracks:lastTracks.map(t=>({artist:t.artist,title:t.title}))})}));
      if(!r.ok){ const j=await r.json().catch(()=>({detail:'Unknown error during create'})); throw new Error(j.detail||`Create failed with status ${r.status}`); }
      const j=await r.json();
      qs('#amMsg').textContent=`Playlist created! Added ${j.added_count} of ${j.total_tracks}.`;
    }catch(e){ qs('#amMsg').textContent='Create failed: '+(e.message||String(e)); }
    finally { btn.disabled = false; }
  }

  /* ===== Catalog helpers (Apple Music) ===== */
  
  // (Filled from old file's 'fetchSongMeta')
  async function backendSongMeta(id,storefront='us'){
    try{
      const r = await fetch(`${API}/v1/apple/song-meta?id=${encodeURIComponent(id)}&storefront=${encodeURIComponent(storefront||'us')}`);
      if (!r.ok) return null;
      return await r.json(); // { id, name, artistName, url }
    }catch{ return null; }
  }
  
  async function appleSongById(id,storefront='us'){ /* ... No changes ... */ }
  async function appleCatalogSearch(term,storefront='us',limit=1){ /* ... No changes ... */ }
  async function appleCatalogResolveList(tracks,storefront){ /* ... No changes ... */ }
  async function buildLocalQueueAndPlay(){ /* ... No changes ... */ }
  
  // (Helper function from old file, needed for play/pause)
  async function guardedPlayPause(intent='toggle'){
    const m = await getWebMusicInstance();
    if (amPlayLock) return;
    amPlayLock = true;
    try{
      const PS = window.MusicKit.PlaybackState;
      const st = m.playbackState;
      if (intent==='play'){
        if (st!==PS.playing) await m.play();
      } else if (intent==='pause'){
        if (st===PS.playing || st===PS.loading || st===PS.buffering) await m.pause();
      } else {
        if (st===PS.playing || st===PS.loading || st===PS.buffering) await m.pause();
        else await m.play();
      }
    } finally { amPlayLock = false; }
  }


  /* ===== Mini-player UI (Apple Music) ===== */
  const mini={title:qs('#miniTitle'),artist:qs('#miniArtist'),
        btnPrev:qs('#btnPrev'),btnPlayPause:qs('#btnPlayPause'),btnNext:qs('#btnNext'),open:qs('#miniOpen')};
  function setPlayIcon(isPlaying){ mini.btnPlayPause.textContent=isPlaying?'‚è∏':'‚ñ∂'; mini.btnPlayPause.title=isPlaying?'Pause':'Play'; }
  
  // (Filled from old file's 'wireNowPlayingHandlers')
  function readMeta(item){
    if (!item) return { title: '‚Äî', artist: '‚Äî', url: null, songId: null };
    let title = item.title || item.attributes?.name;
    let artist = item.artistName || item.attributes?.artistName;
    let url = item.attributes?.url || null;
    let songId = item.id || item.playParams?.catalogId;
    return { title, artist, url, songId };
  }
  
  // (Filled from old file's 'wireNowPlayingHandlers')
  async function updateNowPlaying(m,tryFetchIfMissing){
    if (!m) m = music;
    if (!m) return;
    
    const item = m.nowPlayingItem;
    let { title, artist, url, songId } = readMeta(item);

    if ((!title || !artist) && songId && tryFetchIfMissing) {
      const meta = await backendSongMeta(songId, m.storefrontId || 'us');
      if (meta) {
        title = meta.name;
        artist = meta.artistName;
        url = meta.url || null;
      }
    }
    
    mini.title.textContent = title || '‚Äî';
    mini.artist.textContent = artist || '‚Äî';
    if(url) { mini.open.href = url; mini.open.style.display = ''; }
    else { mini.open.style.display = 'none'; }
  }
  
  // (Filled from old file's 'guardedPlayPause' logic)
  mini.btnPlayPause.addEventListener('click', async (e)=>{
    try {
      await guardedPlayPause('toggle');
    } catch(e) { console.error("Play/pause failed", e); }
  });
  
  // (Filled from old file)
  mini.btnPrev.onclick=async()=>{
    try{ const m = await getWebMusicInstance(); await m.skipToPreviousItem(); }catch(e){}
  };
  
  // (Filled from old file)
  mini.btnNext.onclick=async()=>{
    try{ const m = await getWebMusicInstance(); await m.skipToNextItem(); }catch(e){}
  };


  /* ===== Right panel (viz) ===== */
  let vizRAF=null;
  function startViz(){
    const vizCanvas = qs('#viz');
    if (!vizCanvas || !vizCanvas.isConnected) {
        console.log("Visualizer canvas not visible, not starting.");
        return;
    }
    if (vizRAF !== null) return;

    const c=qs('#viz'); const ctx=c.getContext('2d'); let t=0;
    console.log("Starting Visualizer...");
    const loop=()=>{
      if(vizRAF === null) return;
      const w=c.width,h=c.height; ctx.clearRect(0,0,w,h);
      const g=ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#8b5cf6'); g.addColorStop(1,'#22d3ee'); ctx.fillStyle=g;
      const bars=48,pad=6; for(let i=0;i<bars;i++){ const p=i/(bars-1); const phase=t*0.05+i*0.35; const amp=(Math.sin(phase)+1)/2;
        const ease=0.8-Math.abs(p-0.5); const hBar=(amp*ease)*h*0.9+6; const bw=(w-pad*(bars+1))/bars; const x=pad+i*(bw+pad); const y=h-hBar;
        ctx.fillRect(x,y,bw,hBar); ctx.globalAlpha=0.08; ctx.fillRect(x,y-12,bw,hBar+24); ctx.globalAlpha=1; }
      t+=1;
      vizRAF=requestAnimationFrame(loop); };
    vizRAF=requestAnimationFrame(loop);
  }
  function stopViz(){
     if (vizRAF !== null) {
        cancelAnimationFrame(vizRAF);
        vizRAF = null;
        console.log("Visualizer stopped.");
     }
  }

  /* ===== Init ===== */
  (function(){
    // Apple Music Init
    const tok=localStorage.getItem('appleMusicUserToken');
    if(tok){ qs('#amMsg').textContent='Signed in. Create playlist is ready.'; showAmControls(); }

    // Spotify Init & Callback Handling
    const spTok = localStorage.getItem('spotifyAccessToken');
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    const spotifyToken = params.get('access_token');
    const spotifyError = params.get('spotify_error');
    let switchToSpotifyTab = false;

    if (spotifyError) {
        console.error("Spotify Login Error:", spotifyError);
        qs('#spMsg').textContent = `Spotify login failed: ${spotifyError}. Please try again.`;
        window.history.pushState("", document.title, window.location.pathname + window.location.search);
        switchToSpotifyTab = true;
    } else if (spotifyToken) {
        console.log("Spotify access token found in URL hash.");
        localStorage.setItem('spotifyAccessToken', spotifyToken);
        qs('#spSign').style.display = 'none';
        qs('#spCreate').style.display = 'inline-block';
        qs('#spMsg').textContent = 'Signed in to Spotify.';
        window.history.pushState("", document.title, window.location.pathname + window.location.search);
        switchToSpotifyTab = true;
    } else if (spTok) {
        console.log("Spotify access token found in localStorage.");
        qs('#spSign').style.display = 'none';
        qs('#spCreate').style.display = 'inline-block';
        qs('#spMsg').textContent = 'Signed in to Spotify.';
    } else {
        console.log("No Spotify access token found.");
        qs('#spMsg').textContent = 'Sign in to create Spotify playlists.';
    }

    // Restore generated list and form values if we came back from Spotify auth
    try {
      const savedList = localStorage.getItem('td_lastTracks');
      if (savedList && !lastTracks.length) {
        lastTracks = JSON.parse(savedList) || [];
        if (lastTracks.length) renderList(lastTracks);
      }
      const savedForm = localStorage.getItem('td_form');
      if (savedForm) {
        const f = JSON.parse(savedForm);
        if (f?.date) qs('#date').value = f.date;
        if (f?.genre) qs('#genre').value = f.genre;
        if (f?.hours) qs('#hours').value = String(f.hours);
        if (f?.gap) qs('#gap').value = String(f.gap);
        if (typeof f.seed !== 'undefined') qs('#seed').value = f.seed ?? '';
      }
    } catch (e) { console.warn('Restore failed', e); }
    localStorage.removeItem('td_lastTracks');
    localStorage.removeItem('td_form');

    // Set initial tab
    setTab(switchToSpotifyTab ? 'sp' : 'am');
    if (qs('.tab[data-tab="am"]').classList.contains('active') || qs('.tab[data-tab="sp"]').classList.contains('active')) {
        startViz();
    }

  })();

  /* ===== Wire buttons ===== */
  qs('#go').onclick=simulate;
  // Apple Music Buttons
  qs('#amSign').onclick=amSignIn;
  qs('#amCreate').onclick=amCreatePlaylist;

  // Spotify Buttons
  qs('#spSign').onclick = () => {
      // Persist current state so we don't lose the generated list on return
      try {
        if (lastTracks?.length) {
          localStorage.setItem('td_lastTracks', JSON.stringify(lastTracks));
        }
        localStorage.setItem('td_form', JSON.stringify({
          date: qs('#date').value,
          genre: qs('#genre').value,
          hours: qs('#hours').value,
          gap: qs('#gap').value,
          seed: qs('#seed').value
        }));
      } catch (e) { console.warn('Failed to save state before Spotify login', e); }
      window.location.href = `${API}/v1/spotify/login`;
  };
  qs('#spCreate').onclick = async () => {
      const token = localStorage.getItem('spotifyAccessToken');
      if (!token) {
          qs('#spMsg').textContent = 'Error: Not signed in. Please sign in again.';
          qs('#spSign').style.display = 'inline-block'; qs('#spCreate').style.display = 'none';
          localStorage.removeItem('spotifyAccessToken'); return;
       }
      if (!lastTracks?.length) { qs('#spMsg').textContent = 'Please generate a tracklist first.'; return; }

      const btn = qs('#spCreate'); btn.disabled = true;
      qs('#spMsg').textContent = 'Creating Spotify playlist...';
      try {
          const name = `TapeDeckTimeMachine - ${qs('#date').value} - ${qs('#genre').value}`;
          const body = { accessToken: token, name: name, tracks: lastTracks.map(t => ({ artist: t.artist, title: t.title })) };
          const r = await withTimeout(fetch(`${API}/v1/spotify/create-playlist`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) }), NET_TIMEOUT_MS);

          if (!r.ok) {
              let errorDetail = `Request failed: ${r.status}`;
              try { const j = await r.json(); errorDetail = j.detail || errorDetail; } catch (e) {}
              if (r.status === 401 || r.status === 403) {
                  errorDetail += ' Spotify session expired or insufficient permissions? Try signing in again.';
                  localStorage.removeItem('spotifyAccessToken');
                  qs('#spSign').style.display = 'inline-block'; qs('#spCreate').style.display = 'none';
              }
              throw new Error(errorDetail);
          }

          const result = await r.json();
          let message = `Spotify playlist created! Added ${result.added_count} of ${result.total_tracks} tracks.`;
          if(result.url) { message += ` <a href="${result.url}" target="_blank" rel="noopener" class="btn" style="padding: 6px 10px; font-size: 0.9em;">Open Playlist</a>`; }
          qs('#spMsg').innerHTML = message;

      } catch (e) {
          console.error("Spotify Create Playlist Error:", e);
          let msg = 'Error creating playlist: ' + (e.message || String(e));
          if ((e.message||'').includes('403')) {
            msg += ' This often means Spotify denied the profile scope (/me). Re-sign in and allow permissions (user-read-email or user-read-private) along with playlist modify scopes. If your browser blocks cookies or cross-site tracking, temporarily allow them for login.';
          }
          qs('#spMsg').textContent = msg;
          if (!localStorage.getItem('spotifyAccessToken') && qs('#spSign').style.display === 'none') {
             qs('#spSign').style.display = 'inline-block'; qs('#spCreate').style.display = 'none';
          }
      } finally {
          btn.disabled = false;
      }
  };
</script>

</body>
</html>