<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TapeDeck Time Machine</title>

  <!-- MusicKit JS -->
  <script src="https://js-cdn.music.apple.com/musickit/v3/musickit.js"></script>

  <!-- Meta / Social -->
  <meta name="description" content="Rewind the radio you grew up with. Generate playlists from any date and genre, powered by Billboard chart data.">
  <link rel="icon" href="/logo.svg" type="image/svg+xml"><!-- no favicon.ico until you add one -->
  <link rel="apple-touch-icon" href="/logo.svg">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://tapedecktimemachine.com/">
  <meta property="og:title" content="TapeDeck Time Machine - Historical Music Playlist Generator">
  <meta property="og:description" content="Rewind the radio you grew up with. Generate playlists from any date and genre.">
  <meta property="og:image" content="https://tapedecktimemachine.com/tapedeck-preview.png">
  <meta property="og:image:width" content="1200"><meta property="og:image:height" content="630">
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://tapedecktimemachine.com/">
  <meta property="twitter:title" content="TapeDeck Time Machine - Historical Music Playlist Generator">
  <meta property="twitter:description" content="Rewind the radio you grew up with. Generate playlists from any date and genre.">
  <meta property="twitter:image" content="https://tapedecktimemachine.com/tapedeck-preview.png">

  <!-- GA -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HPZT6BMJVD"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-HPZT6BMJVD');
  </script>

  <style>
    :root{
      --bg:#0a0f17;--panel:#111827;--muted:#94a3b8;--text:#e5e7eb;
      --accent:#8b5cf6;--accent2:#22d3ee;--shadow:0 12px 48px rgba(2,10,20,.45)
    }
    *{box-sizing:border-box}
    body{margin:0;background:
      radial-gradient(1200px 600px at 10% -10%, #0e1630 0%, transparent 60%),
      radial-gradient(700px 400px at 120% 10%, #06101f 0%, transparent 60%), #0a0f17;
      color:var(--text); font:16px/1.5 -apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;}
    .wrap{max-width:1100px;margin:40px auto;padding:0 18px}
    .bar{display:flex;align-items:center;gap:14px}
    .bar a { color: inherit; text-decoration: none; display: flex; align-items: center; gap: 14px; }
    .logo{width:36px;height:36px;border-radius:12px;background:
      linear-gradient(135deg,#8b5cf6 0%,#22d3ee 55%,#16a34a 120%);
      display:grid;place-items:center;color:#fff;font-weight:800;box-shadow:var(--shadow);text-decoration:none; flex-shrink: 0;}
    h1{font-size:22px;margin:0}
    .panel{background:rgba(17,24,39,.75);border:1px solid rgba(148,163,184,.12);
      border-radius:18px;padding:16px;box-shadow:var(--shadow)}
    .grid{display:grid;grid-template-columns:1.2fr 1fr 1fr 1fr 1fr auto; gap:12px; align-items:end}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px 2px}
    input,select,button{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(148,163,184,.18);
      background:#0c1422;color:var(--text);outline:none;font-size:1rem}
    button.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));border:0;font-weight:700;cursor:pointer}
    button:disabled{background:#475569;color:#cbd5e1;cursor:not-allowed}
    .tabs{display:flex;gap:10px;margin:14px 0 8px}
    .tab{padding:9px 14px;border-radius:999px;border:1px solid rgba(148,163,184,.2);
      background:#0c1422;color:var(--text);cursor:pointer}
    .tab.active{background:linear-gradient(135deg,rgba(139,92,246,.25),rgba(34,211,238,.18));border-color:transparent}
    .cols{display:grid;grid-template-columns:1.05fr .95fr; gap:16px}
    .box{min-height:380px}
    iframe{width:100%;height:360px;border:0;border-radius:12px;box-shadow:var(--shadow)}
    .btn{display:inline-block;margin-top:8px;padding:10px 14px;border-radius:12px;border:1px solid rgba(148,163,184,.2);
      background:#0c1422;color:#e5e7eb;text-decoration:none;font-weight:700;cursor:pointer}
    .muted{color:var(--muted)}
    .list{padding:12px 8px;max-height:420px;overflow:auto}
    .row{display:grid;grid-template-columns:110px 1fr;gap:14px; padding:10px 6px;border-bottom:1px dashed rgba(148,163,184,.12)}
    .ts{font:12px/1.3 ui-monospace,SFMono-Regular,Menlo,monospace;color:var(--muted)}
    .err{color:#fda4af;margin-top:6px; white-space: pre-wrap; word-break: break-all;}
    .ok{color:#86efac;margin-top:6px}

    /* Embed styles */
    .embedWrap{display:none; margin-top:12px}
    .embedBar{display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:8px; flex-wrap: wrap;}
    .linkRow{display:flex; gap:10px; flex-wrap:wrap}
    #amEmbed { height: 150px; /* Standard embed height */} /* Adjust embed iframe height */

    /* Simple Player styles */
    .simplePlayer { display: none; margin-top: 12px; background: rgba(12,20,34,.8); border:1px solid rgba(148,163,184,.12); border-radius:14px; padding:10px; }
    .simplePlayer .spRow1 { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; }
    .simplePlayer .spMeta { min-width: 0; }
    .simplePlayer .spTitle { font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .simplePlayer .spControls { display: flex; gap: 6px; align-items: center; }
    .simplePlayer .spControls .btn { padding: 6px 10px; }

    @media (max-width:800px){.grid{grid-template-columns:1fr 1fr}.grid>div:last-child{grid-column:1/-1}}
    @media (max-width:700px){.wrap{margin:20px auto}.cols{grid-template-columns:1fr}h1{font-size:18px}}
    @media (max-width:500px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>

<div class="wrap">
  <!-- Link added to logo/title -->
  <div class="bar" style="margin-bottom:14px">
    <a href="/">
      <div class="logo">TD</div>
      <h1>TapeDeck Time Machine</h1>
    </a>
  </div>

  <!-- Controls -->
  <div class="panel">
    <!-- ... (Grid remains the same) ... -->
    <div class="grid">
      <div><label>Date</label><input id="date" placeholder="mm/dd/yyyy" value="07/01/2002"></div>
      <div><label>Genre</label>
        <select id="genre"> <option>Alternative</option><option>Hot-100</option><option>Pop</option><option>Rock</option><option>Country</option><option>R&B/Hip-Hop</option><option>Dance/Electronic</option> </select>
      </div>
      <div><label>Hours</label><select id="hours"><option>0.5</option><option selected>1</option><option>2</option><option>3</option></select></div>
      <div><label>Repeat gap (min)</label><input id="gap" type="number" value="90"></div>
      <div><label>Seed (opt)</label><input id="seed" placeholder="e.g. 20020701"></div>
      <div><label>&nbsp;</label><button id="go" class="primary">Generate</button></div>
    </div>

    <!-- ... (Tabs remain the same) ... -->
    <div class="tabs"> <button class="tab active" data-tab="yt">YouTube</button> <button class="tab" data-tab="am">Apple Music</button> <button class="tab" data-tab="sp" disabled title="Coming soon">Spotify</button> </div>
    <div class="muted" style="margin:-6px 0 8px 2px">Spotify sign-in is under construction. Coming soon!</div>

    <div class="cols">
      <!-- YouTube -->
      <div class="panel box" id="pane-yt"> <!-- ... (unchanged) ... --> </div>

      <!-- Apple Music Pane -->
      <div class="panel box" id="pane-am" style="display:none">
        <div id="amWrap">
          <p class="muted" style="margin-bottom:8px">Generate a list, sign in, create the playlist, then play it below.</p>
          <div class="linkRow">
            <button class="btn" id="amSign">Sign in to Apple Music</button>
            <button class="btn" id="amCreate" style="display:none">Create Playlist</button>
            <!-- REMOVED amPlay, added amPlaySimpleBtn -->
            <button class="btn" id="amPlaySimpleBtn" style="display:none">Use Simple Player</button>
          </div>
          <div id="amMsg" class="muted" style="margin-top:8px"></div>

          <!-- Official Apple Music Embed -->
          <div id="embedWrap" class="embedWrap">
            <div class="embedBar">
              <div class="muted">Apple Music Embed</div>
              <div class="linkRow">
                <a id="openInAm" class="btn" href="#" target="_blank" rel="noopener">Open in Apple Music ↗</a>
                <button id="copyLink" class="btn">Copy Link</button>
              </div>
            </div>
            <iframe id="amEmbed" allow="autoplay *; encrypted-media *;" sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-storage-access-by-user-activation allow-top-navigation-by-user-activation" loading="lazy"></iframe>
            <div id="embedNote" class="muted" style="margin-top:8px; display:none;"></div>
          </div>

          <!-- Simple Player (Fallback) -->
          <div id="simplePlayer" class="simplePlayer">
            <div class="spRow1">
              <div class="spMeta">
                <div id="spTitle" class="spTitle">—</div>
                <!-- Removed artist to simplify -->
              </div>
              <div class="spControls">
                <button id="spBtnPrev" class="btn inline ghost" title="Previous">⟨⟨</button>
                <button id="spBtnPlayPause" class="btn inline" title="Play/Pause">▶</button>
                <button id="spBtnNext" class="btn inline ghost" title="Next">⟩⟩</button>
              </div>
            </div>
             <div id="spMsg" class="muted" style="font-size: 11px; margin-top: 4px;"></div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Tracklist -->
  <div class="panel" style="margin-top:16px"> <!-- ... (unchanged) ... --> </div>
</div>

<script>
  // ---------- config & helpers ----------
  const qs = s => document.querySelector(s);
  const API = new URLSearchParams(location.search).get('api') || 'https://timedeck-api.onrender.com';
  const NET_TIMEOUT_MS = 180000;
  const NATIVE_HOST = 'https://tapedecktimemachine.com';
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  function toISO(mmddyyyy){ /* ... unchanged ... */ }
  function setTab(id){ /* ... unchanged ... */ }
  document.querySelectorAll('.tab').forEach(b=>b.onclick=()=>setTab(b.dataset.tab));
  function withTimeout(promise, ms = NET_TIMEOUT_MS) { /* ... unchanged ... */ }

  // ---------- state ----------
  let lastTracks = [];
  let DEV_TOKEN = null;
  let currentPlaylistInfo = { id: null, url: null, storefront: 'us' }; // Store created playlist info

  // ---------- YouTube ----------
  // ... (unchanged) ...
  let player = null, YTapiReady = false;
  (function(){ const tag=document.createElement('script'); tag.src="https://www.youtube.com/iframe_api"; document.head.appendChild(tag); })();
  window.onYouTubeIframeAPIReady = () => { YTapiReady = true; console.log("YT API Ready"); };
  async function simulate(){ /* ... (Reset AM embed/player too) ... */ }
  function renderList(rows){ /* ... unchanged ... */ }
  async function buildYouTube(tracks){ /* ... unchanged ... */ }

  // ---------- Universal Link / custom-scheme listener (native) ----------
  // ... (unchanged) ...
   (function(){
    const Cap = window.Capacitor || {}; const App = Cap.Plugins && Cap.Plugins.App;
    function parseQuery(u){ /* ... */ }
    if (App && App.addListener) {
      App.addListener('appUrlOpen', ({ url }) => {
        /* ... */
        if (q.token) { localStorage.setItem('appleMusicUserToken', q.token); updateAmUIState(); getMusicInstance().catch(e => console.warn("[AM Init BG after native auth]", e)); }
        else { /* ... */ }
      }); console.log('[AM] appUrlOpen listener attached');
    } else { console.warn('[AM] Capacitor App plugin not available for appUrlOpen listener.'); }
  })();


  // ---------- MusicKit Initialization (V11 - Simplified for Embed/Fallback) ----------
  let musicInstance = null; // Holds the instance once configured
  let musicInstancePromise = null; // Tracks the initial configure promise

  function waitForMusicKitLoaded(timeoutMs = 15000) { /* ... unchanged ... */ }
  async function fetchDeveloperToken() { /* ... unchanged ... */ }
  async function configureMusicKit() { /* ... unchanged, includes event listener setup */ }
  function getMusicInstance() { /* ... unchanged ... */ }
  function updateAmUIState() {
      const hasToken = !!localStorage.getItem('appleMusicUserToken');
      console.log('[AM UI Update] Updating UI based on token presence:', hasToken);
      qs('#amSign').style.display = hasToken ? 'none' : 'inline-block';
      qs('#amCreate').style.display = hasToken ? 'inline-block' : 'none';
      // Only show Play button if a playlist has been created
      qs('#amPlaySimpleBtn').style.display = (hasToken && currentPlaylistInfo.id) ? 'inline-block' : 'none';

      if (hasToken) {
          if (qs('#amMsg').textContent.startsWith('Sign-in') || qs('#amMsg').textContent.startsWith('Error') || qs('#amMsg').textContent.startsWith('Failed')) {
              qs('#amMsg').textContent = currentPlaylistInfo.id ? 'Playlist created. Ready to play.' : 'Signed in. Create a playlist.';
          }
      } else {
          qs('#embedWrap').style.display = 'none'; // Hide embed on sign out
          qs('#simplePlayer').style.display = 'none'; // Hide simple player on sign out
          if (!qs('#amMsg').textContent.startsWith('Error') && !qs('#amMsg').textContent.startsWith('Failed')) {
              qs('#amMsg').textContent = '';
          }
      }
  }
  function handleAuthorizationStatusChange(event) { /* ... unchanged ... */ }
  // --- End MusicKit Initialization ---


  // ---------- Native-first sign-in (Browser.open) ----------
  async function amSignIn(){ /* ... unchanged ... */ }

  // ---------- Create Playlist & Attempt Embed ----------
  function deriveEmbedFromUrl(url) { /* ... unchanged ... */ }
  function buildEmbedFromId(id, storefront='us') { /* ... unchanged ... */ }
  function showEmbed(embedUrl, openUrl){ /* ... unchanged ... */ }

  async function amCreatePlaylist(){
    const userToken = localStorage.getItem('appleMusicUserToken');
    if(!userToken){ qs('#amMsg').textContent='Please sign in first.'; updateAmUIState(); return; }
    if(!lastTracks?.length){ qs('#amMsg').textContent='Generate a tracklist first.'; return; }

    qs('#amMsg').textContent='Creating playlist…';
    qs('#embedWrap').style.display = 'none'; // Hide previous embed
    qs('#simplePlayer').style.display = 'none'; // Hide simple player
    currentPlaylistInfo = { id: null, url: null, storefront: 'us' }; // Reset playlist info

    try{
      const name = `TimeDeck — ${qs('#date').value} — ${qs('#genre').value.toLowerCase()}`;
      const r = await withTimeout(fetch(`${API}/v1/apple/create-playlist`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userToken, name, tracks: lastTracks.map(t=>({artist:t.artist,title:t.title})) })
      }));
      if(!r.ok){
        const j = await r.json().catch(() => ({ detail: 'Unknown error during create' }));
        throw new Error(j.detail || `Create failed with status ${r.status}`);
      }
      const j = await r.json();
      const { playlist_id, playlist_url, storefront, added_count, total_tracks_searched } = j || {};

      if (!playlist_id) {
          throw new Error("Playlist created, but backend didn't return an ID.");
      }

      // Store playlist info
      currentPlaylistInfo.id = playlist_id;
      currentPlaylistInfo.url = playlist_url;
      currentPlaylistInfo.storefront = storefront || 'us';
      localStorage.setItem('applePlaylistId', playlist_id); // Keep storing for persistence if needed
      if (playlist_url) localStorage.setItem('applePlaylistUrl', playlist_url); else localStorage.removeItem('applePlaylistUrl');
      if (storefront) localStorage.setItem('applePlaylistStorefront', storefront); else localStorage.removeItem('applePlaylistStorefront');


      qs('#amMsg').textContent = `Playlist created! Added ${added_count} of ${total_tracks_searched} tracks. Loading embed...`;
      qs('#amPlaySimpleBtn').style.display = 'inline-block'; // Show fallback button

      // --- Attempt to load Embed ---
      let embedUrl = playlist_url ? deriveEmbedFromUrl(playlist_url) : null;
      if (!embedUrl && playlist_id) embedUrl = buildEmbedFromId(playlist_id, currentPlaylistInfo.storefront);
      const openUrl = playlist_url || (playlist_id ? `https://music.apple.com/${currentPlaylistInfo.storefront}/playlist/${encodeURIComponent(playlist_id)}` : '#');

      if (embedUrl) {
        console.log('[AM Create] Attempting to load embed:', embedUrl);
        showEmbed(embedUrl, openUrl); // This function now handles showing the embedWrap
        // Add note about fallback AFTER showing embed
        qs('#embedNote').textContent = 'If player stays blank, playlist might be private. Use "Simple Player".';
        qs('#embedNote').style.display = 'block';
      } else {
        console.warn('[AM Create] Could not generate an embed URL.');
        qs('#embedWrap').style.display = 'block'; // Show wrap anyway for links
        qs('#amEmbed').style.display = 'none';   // Hide iframe
        qs('#openInAm').href = openUrl;
        qs('#embedNote').textContent = 'Could not generate an embed URL. Use "Simple Player" or "Open in Apple Music".';
        qs('#embedNote').style.display = 'block';
        qs('#amMsg').textContent = `Playlist created! Added ${added_count}. Embed unavailable.`;
      }

    } catch(e){
      console.error('[AM Create] Failed:', e);
      qs('#amMsg').textContent = 'Create failed: ' + (e.message || String(e));
      qs('#amPlaySimpleBtn').style.display = 'none'; // Hide fallback on create error
    }
  }

  // --- Copy Link Helper ---
  qs('#copyLink').onclick = async () => { /* ... unchanged ... */ };


  // ---------- Simple Programmatic Player (Fallback) ----------
  let simplePlayerInterval = null; // To update simple player time

  // Function to show/hide and update simple player
  function showSimplePlayer(show = true) {
      const sp = qs('#simplePlayer');
      sp.style.display = show ? 'block' : 'none';
      if (!show && simplePlayerInterval) {
          clearInterval(simplePlayerInterval);
          simplePlayerInterval = null;
      }
  }

  function updateSimplePlayerUI() {
      if (!musicInstance || !musicInstance.player || !musicInstance.player.nowPlayingItem) {
          qs('#spTitle').textContent = '—';
          qs('#spBtnPlayPause').textContent = '▶';
          return;
      }
      const item = musicInstance.player.nowPlayingItem;
      const attr = item.attributes || {};
      qs('#spTitle').textContent = `${attr.artistName || '?'} - ${attr.name || '?'}`;
      qs('#spBtnPlayPause').textContent = musicInstance.player.isPlaying ? '⏸' : '▶';
  }

  // Event listener for simple player state changes
  function simplePlayerStateChanged(event) {
      console.log('[AM Simple Player] State changed:', event.state);
      updateSimplePlayerUI();
      // Add interval timer only when playing
      if (event.state === MusicKit.PlaybackStates.playing && !simplePlayerInterval) {
          // No time display in simple player for now
      } else if (event.state !== MusicKit.PlaybackStates.playing && simplePlayerInterval) {
          clearInterval(simplePlayerInterval);
          simplePlayerInterval = null;
      }
  }
  function simplePlayerItemChanged(event) {
      console.log('[AM Simple Player] Item changed');
      updateSimplePlayerUI();
  }

  // Main function to start the simple player
  async function amPlaySimple() {
    qs('#amMsg').textContent = '';
    qs('#embedWrap').style.display = 'none'; // Hide embed if showing
    showSimplePlayer(false); // Hide old player if any

    let m;
    try {
      console.log('[AM Play Simple] Getting MusicKit instance...');
      m = await getMusicInstance();

      if (!m || !m.isAuthorized) {
        console.log('[AM Play Simple] Not authorized.');
        qs('#amMsg').textContent = 'Sign-in required.';
        updateAmUIState(); return;
      }

      const playlistId = currentPlaylistInfo.id; // Get ID from create step
      if (!playlistId) {
          qs('#amMsg').textContent = 'Please create a playlist first.';
          return;
      }

       // Check API readiness minimally (playback doesn't need search)
      if (!m.player || typeof m.play !== 'function' || typeof m.setQueue !== 'function') {
           console.error('[AM Play Simple] Player API not ready.');
           throw new Error('MusicKit Player failed to become ready.');
      }
      console.log('[AM Play Simple] Instance ready for playback.');

    } catch (e) {
      console.error('[AM Play Simple] init/check failed:', e);
      qs('#amMsg').textContent = 'Apple Music connection issue: ' + (e.message || e);
      updateAmUIState(); return;
    }

    // --- Set Queue using Playlist ID and Play ---
    qs('#amMsg').textContent = `Loading playlist...`;
    try {
      // Use setQueue with the library playlist ID
      // NOTE: This requires the 'music-user-token' and works for LIBRARY items.
      console.log('[AM Play Simple] Setting queue with playlist ID:', playlistId);
      await m.setQueue({ playlist: playlistId });

      // Add listeners specific to simple player updates
      m.removeEventListener('playbackStateDidChange', simplePlayerStateChanged); // Avoid duplicates
      m.removeEventListener('nowPlayingItemDidChange', simplePlayerItemChanged);
      m.addEventListener('playbackStateDidChange', simplePlayerStateChanged);
      m.addEventListener('nowPlayingItemDidChange', simplePlayerItemChanged);


      await m.play();
      showSimplePlayer(true); // Show the simple player UI
      updateSimplePlayerUI(); // Update with initial track
      qs('#amMsg').textContent = `Now playing created playlist!`;
      qs('#spMsg').textContent = ''; // Clear simple player message area
    } catch (e) {
      console.error('[AM Play Simple] playback failed:', e);
      qs('#amMsg').textContent = 'Error starting simple playback: ' + (e.message || e);
      qs('#spMsg').textContent = 'Playback Error: ' + (e.message || e); // Show error in simple player
      showSimplePlayer(true); // Show player even on error to display message
    }
  }

  // --- Simple Player Controls Wiring ---
  qs('#spBtnPlayPause').onclick = async () => {
    try { const m = await getMusicInstance(); if (m?.player?.isPlaying) m.pause(); else m.play(); } catch(e){ console.error("SP Play/pause error:", e);}
  };
  qs('#spBtnPrev').onclick = async () => {
     try { const m = await getMusicInstance(); if(m) await m.skipToPreviousItem(); } catch(e){ console.warn("SP Skip Previous failed:", e); }
  };
  qs('#spBtnNext').onclick = async () => {
     try { const m = await getMusicInstance(); if(m) await m.skipToNextItem(); } catch(e){ console.warn("SP Skip Next failed:", e); }
  };


  // ---------- Initialize MusicKit on Load ----------
  document.addEventListener('DOMContentLoaded', () => {
      console.log('[AM Init] DOMContentLoaded, attempting initial MusicKit setup...');
      // Retrieve stored playlist info on load
      currentPlaylistInfo.id = localStorage.getItem('applePlaylistId');
      currentPlaylistInfo.url = localStorage.getItem('applePlaylistUrl');
      currentPlaylistInfo.storefront = localStorage.getItem('applePlaylistStorefront') || 'us';

      getMusicInstance().catch(e => {
          console.error("Initial MusicKit setup failed on load:", e);
      });
      // Update UI based on stored token immediately
      updateAmUIState();
  });

  // ---------- wire up ----------
  qs('#go').onclick = simulate;
  qs('#amSign').onclick = amSignIn;
  qs('#amCreate').onclick = amCreatePlaylist;
  qs('#amPlaySimpleBtn').onclick = amPlaySimple; // Wire up simple player button

  setTab('yt');
</script>

</body>
</html>

