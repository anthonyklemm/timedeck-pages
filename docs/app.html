<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TapeDeck Time Machine</title>

<!-- MusicKit v3 -->
<script src="https://js-cdn.music.apple.com/musickit/v3/musickit.js"></script>

<link rel="icon" href="/logo.svg" type="image/svg+xml">
<link rel="alternate icon" href="/favicon.ico">
<link rel="apple-touch-icon" href="/logo.svg">
<meta name="description" content="Rewind the radio you grew up with. Generate playlists from any date and genre, powered by Billboard chart data.">

<style>
  :root{
    --bg:#0a0f17;--panel:#111827;--muted:#9aa6b2;--text:#e5e7eb;
    --accent:#8b5cf6;--accent2:#22d3ee;--shadow:0 12px 48px rgba(2,10,20,.45)
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:
    radial-gradient(1200px 600px at 10% -10%, #0e1630 0%, transparent 60%),
    radial-gradient(700px 400px at 120% 10%, #06101f 0%, transparent 60%), #0a0f17;
    color:var(--text); font:16px/1.5 -apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:1100px;margin:28px auto;padding:0 18px;overflow-x:hidden}

  /* Header */
  .bar{display:flex;align-items:center;gap:14px;margin-bottom:14px}
  .logo{
    flex:0 0 36px; width:36px;height:36px;border-radius:12px;
    background:linear-gradient(135deg,#8b5cf6 0%,#22d3ee 55%,#16a34a 120%);
    display:grid;place-items:center;color:#fff;font-weight:800;box-shadow:var(--shadow)
  }
  h1{font-size:22px;margin:0}

  .panel{background:rgba(17,24,39,.75);border:1px solid rgba(148,163,184,.12);
    border-radius:18px;padding:16px;box-shadow:var(--shadow)}
  .muted{color:var(--muted)}

  /* Top grid — phone:1, tablet:2, desktop:6 */
  .grid{display:grid;gap:12px;align-items:end}
  @media (min-width:0px){.grid{grid-template-columns:1fr}}
  @media (min-width:640px){.grid{grid-template-columns:1fr 1fr}}
  @media (min-width:980px){.grid{grid-template-columns:1.1fr 1fr .8fr .9fr 1.1fr auto}}
  .grid>div{min-width:0} /* prevent tiny overflow on iOS */
  label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px 2px}

  input,select,button{
    width:100%;max-width:100%;
    padding:12px;border-radius:12px;border:1px solid rgba(148,163,184,.18);
    background:#0c1422;color:var(--text);outline:none;font-size:1rem
  }
  input[type="date"]{-webkit-appearance:none;appearance:none}
  button.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));border:0;font-weight:700;cursor:pointer}

  /* Tabs */
  .tabs{display:flex;gap:10px;margin:14px 0 8px}
  .tab{padding:9px 14px;border-radius:999px;border:1px solid rgba(148,163,184,.2);
    background:#0c1422;color:var(--text);cursor:pointer}
  .tab.active{background:linear-gradient(135deg,rgba(139,92,246,.25),rgba(34,211,238,.18));border-color:transparent}

  /* Two-column main area */
  .cols{display:grid;gap:16px}
  @media (min-width:0px){.cols{grid-template-columns:1fr}}
  @media (min-width:980px){.cols{grid-template-columns:1.05fr 1fr}}
  .box{min-height:240px}

  .btn{display:inline-block;padding:11px 16px;border-radius:12px;border:1px solid rgba(148,163,184,.2);
    background:#0c1422;color:var(--text);font-weight:700;text-align:center;cursor:pointer}

  /* Controls */
  .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{display:inline-grid;place-items:center;width:46px;height:42px;border-radius:12px;border:1px solid rgba(148,163,184,.2);background:#0c1422;cursor:pointer;font-weight:700}
  .openBtn{padding:10px 14px;border-radius:12px;border:1px solid rgba(148,163,184,.2);background:#0c1422;font-weight:700}

  /* Now-playing line */
  .nowline{display:flex;gap:10px;align-items:center;margin:8px 0 10px;min-width:0}
  .titletext{flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#c6d0db}

  /* Visualizer */
  .viz{height:260px;border-radius:16px;background:linear-gradient(180deg,#111b33 0%,#0c1222 100%);
    position:relative;overflow:hidden;border:1px solid rgba(148,163,184,.12)}
  .bars{position:absolute;inset:12px;display:flex;align-items:flex-end;gap:6px}
  .bar{width:10px;background:linear-gradient(180deg,#25e0ff,#7b6cff);opacity:.85;border-radius:6px}
  .rtabs{display:flex;gap:10px;margin-bottom:10px}
  .rtab{padding:8px 12px;border-radius:999px;border:1px solid rgba(148,163,184,.2);background:#0c1422}
  .rtab.active{background:linear-gradient(135deg,rgba(139,92,246,.25),rgba(34,211,238,.18));border-color:transparent}

  /* Track list rows */
  .list{padding:12px 8px;max-height:420px;overflow:auto}
  .row{display:grid;grid-template-columns:110px 1fr;gap:14px; padding:10px 6px;border-bottom:1px dashed rgba(148,163,184,.12)}
  .ts{font:12px/1.3 ui-monospace,SFMono-Regular,Menlo,monospace;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">

  <!-- Header -->
  <a class="bar" href="/index.html">
    <div class="logo">TD</div>
    <h1>TapeDeck Time Machine</h1>
  </a>

  <div class="panel">
    <!-- Top form -->
    <div class="grid">
      <div>
        <label>Date</label>
        <input id="date" type="date" value="2002-07-01">
      </div>
      <div>
        <label>Genre</label>
        <select id="genre">
          <option>Alternative</option><option>Hot-100</option><option>Pop</option>
          <option>Rock</option><option>Country</option><option>R&B/Hip-Hop</option><option>Dance/Electronic</option>
        </select>
      </div>
      <div>
        <label>Hours</label>
        <select id="hours"><option>0.5</option><option selected>1</option><option>2</option><option>3</option></select>
      </div>
      <div>
        <label>Repeat gap (min)</label>
        <input id="gap" type="number" value="90">
      </div>
      <div>
        <label>Seed (opt)</label>
        <input id="seed" placeholder="e.g. 20020701">
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="go" class="primary">Generate</button>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab" data-tab="yt">YouTube</button>
      <button class="tab active" data-tab="am">Apple Music</button>
      <button class="tab" data-tab="sp">Spotify</button>
    </div>
    <div class="muted" style="margin:-6px 0 8px 2px">Spotify sign-in and playback are under construction.</div>

    <div class="cols" id="cols">
      <!-- Left: Apple Music actions + mini controls -->
      <div class="panel box" id="pane-am">
        <p class="muted" style="margin-top:0">Generate a list, sign in, create the playlist, then play it below with the
          official Apple embed. If embedding isn’t possible, we’ll use a built-in player.</p>

        <div style="display:grid;gap:12px;margin-bottom:12px">
          <button class="btn" id="amCreate">Create Playlist</button>
          <button class="btn" id="amPlay">Play with Built-In Player</button>
        </div>

        <div id="amMsg" class="muted" style="margin:4px 0 8px"></div>

        <!-- Now playing line -->
        <div class="nowline">
          <div class="titletext" id="amNow">—</div>
        </div>

        <!-- Controls row -->
        <div class="controls" style="margin-top:6px">
          <button class="pill" id="btnPrev" title="Previous">≪</button>
          <button class="pill" id="btnPlayPause" title="Play / Pause">⏯</button>
          <button class="pill" id="btnNext" title="Next">≫</button>
          <button class="openBtn" id="btnOpen" title="Open in Apple Music">Open ↗</button>
        </div>
      </div>

      <!-- Right: Visualizer -->
      <div class="panel box" id="rightPanel">
        <div class="rtabs">
          <div class="rtab active">Visualizer</div>
          <div class="rtab" id="spTab" style="display:none">Time Capsule</div>
        </div>
        <div class="viz" id="viz">
          <div class="bars" id="bars"></div>
        </div>
      </div>
    </div>

    <!-- Spotify stubbed panel (shown when Spotify tab selected) -->
    <div class="panel box" id="pane-sp" style="display:none;margin-top:12px">
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <button class="btn" id="spConnect">Connect Spotify</button>
        <button class="btn" id="spCreate" disabled>Create Spotify Playlist</button>
        <button class="btn" id="spOpen" disabled>Open in Spotify ↗</button>
      </div>
      <div class="muted" id="spMsg" style="margin-top:8px">Sign in to enable playlist creation.</div>
    </div>
  </div>

  <!-- Track list -->
  <div class="panel" style="margin-top:16px">
    <h2>Your Music Time Machine Playlist</h2>
    <p class="muted" style="margin-bottom:6px">
      Ever wonder <strong>what songs were popular on your birthday?</strong>
      Just pick a date and genre, and we'll <strong>generate a music playlist</strong>
      of the top songs from that week, based on <strong>historical Billboard charts</strong>.
      The tracklist will appear below.
    </p>
    <div id="list" class="list"></div>
  </div>
</div>

<script>
/* ---------- config & helpers ---------- */
const qs = s => document.querySelector(s);
const API = new URLSearchParams(location.search).get('api') || 'https://timedeck-api.onrender.com';
const NET_TIMEOUT_MS = 180000;
const delay = ms => new Promise(r=>setTimeout(r,ms));

function withTimeout(promise, ms = NET_TIMEOUT_MS) {
  let t; const timer = new Promise((_, rej)=>{ t=setTimeout(()=>rej(new Error(`Network timeout after ${Math.round(ms/1000)}s`)), ms); });
  return Promise.race([promise.finally(()=>clearTimeout(t)), timer]);
}
function fmtDateForAPI(value){
  if(!value) return '';
  if (/^\d{4}-\d{2}-\d{2}$/.test(value)) return value;
  const m = value.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (m){ const [_,mm,dd,yyyy]=m; return `${yyyy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}`; }
  return value;
}

/* ---------- state ---------- */
let lastTracks = [];
let music = null;
let amCurrentSongURL = null;
let amPlayLock = false;

/* ---------- Visualizer ---------- */
(function makeBars(){
  const bars = qs('#bars');
  const n = 28;
  for(let i=0;i<n;i++){
    const b = document.createElement('div');
    b.className = 'bar';
    b.style.height = (Math.random()*70 + 20) + '%';
    bars.appendChild(b);
  }
  function animate(){
    [...bars.children].forEach((b,i)=>{
      const t = (performance.now()/800 + i*0.15);
      const h = 18 + 62*(0.5+0.5*Math.sin(t));
      b.style.height = h + '%';
    });
    requestAnimationFrame(animate);
  }
  animate();
})();

/* ---------- Tabs ---------- */
function setTab(id){
  document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
  qs('#pane-am').style.display = id==='am' ? '' : 'none';
  qs('#pane-sp').style.display = id==='sp' ? '' : 'none';
}
document.querySelectorAll('.tab').forEach(b=>b.onclick=()=>setTab(b.dataset.tab));

/* ---------- List rendering ---------- */
function renderList(rows){
  const wrap = qs('#list');
  if(!rows?.length){ wrap.innerHTML = '<div class="muted">No tracks.</div>'; return; }
  const frag = document.createDocumentFragment();
  rows.slice(0,500).forEach(t=>{
    const d = document.createElement('div'); d.className='row';
    d.innerHTML = `<div class="ts">${t.timestamp.replace('T',' ')}</div>
                   <div><strong>${t.artist}</strong> — <em>${t.title}</em>
                   <span class="muted">• ${t.source_rank ?? ''}</span></div>`;
    frag.appendChild(d);
  });
  wrap.replaceChildren(frag);
}

/* ---------- Simulate ---------- */
async function simulate(){
  const body = {
    date: fmtDateForAPI(qs('#date').value.trim()),
    genre: qs('#genre').value,
    hours: Number(qs('#hours').value || 3),
    repeat_gap_min: Number(qs('#gap').value || 90),
    seed: (qs('#seed').value.trim() || undefined) ? String(qs('#seed').value.trim()) : undefined,
    limit: 500
  };
  lastTracks = [];
  qs('#amMsg').textContent = 'Building…';
  try{
    const r = await withTimeout(fetch(`${API}/v1/simulate`, {
      method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body)
    }));
    if(!r.ok){ throw new Error(`simulate ${r.status}`); }
    const data = await r.json();
    lastTracks = data.tracks || [];
    renderList(lastTracks);
    qs('#amMsg').textContent = lastTracks.length ? `Ready: ${lastTracks.length} tracks.` : 'No tracks.';
  }catch(e){
    console.error('[simulate] failed', e);
    qs('#amMsg').textContent = 'Failed: ' + (e.message || e);
  }
}

/* ---------- MusicKit bootstrapping (robust) ---------- */
function waitForMusicKitLoaded(timeoutMs = 10000){
  if (window.MusicKit && typeof window.MusicKit.getInstance === 'function') return Promise.resolve();
  return new Promise((resolve, reject) => {
    const t = setTimeout(()=>reject(new Error('MusicKit load timed out')), timeoutMs);
    window.addEventListener('musickitloaded', () => { clearTimeout(t); resolve(); }, { once:true });
  });
}
let musicInitPromise = null;
async function getWebMusicInstance(){
  if (music) return music;
  if (!musicInitPromise) {
    musicInitPromise = (async () => {
      await waitForMusicKitLoaded();
      const r = await withTimeout(fetch(`${API}/v1/apple/dev-token`));
      if(!r.ok) throw new Error(`dev-token ${r.status}`);
      const { token: developerToken, storefront } = await r.json();

      window.MusicKit.configure({ developerToken, app:{ name:'TapeDeck Time Machine', build:'web' } });

      // wait until instance exists
      let inst = null;
      for (let i=0;i<40;i++){ // ~2s
        inst = (window.MusicKit.getInstance && window.MusicKit.getInstance()) || null;
        if (inst && typeof inst.play === 'function') break;
        await delay(50);
      }
      if (!inst) throw new Error('MusicKit instance not ready');

      inst.storefrontId = storefront || 'us';
      music = inst;
      wireNowPlayingHandlers(music);
      return music;
    })().catch(e=>{ musicInitPromise = null; throw e; });
  }
  return musicInitPromise;
}

/* ---------- Now playing title (uses /v1/apple/song-meta) ---------- */
async function fetchSongMeta(id, storefront) {
  try{
    const r = await fetch(`${API}/v1/apple/song-meta?id=${encodeURIComponent(id)}&storefront=${encodeURIComponent(storefront||'us')}`);
    if (!r.ok) return null;
    return await r.json(); // { id, name, artistName, url }
  }catch{ return null; }
}
function renderNow(title, artist) {
  const el = qs('#amNow');
  if (!el) return;
  const t = [artist, title].filter(Boolean).join(' — ');
  el.textContent = t || '—';
}
function wireNowPlayingHandlers(music) {
  const update = async () => {
    const item = music.nowPlayingItem;
    if (!item) { renderNow('', ''); amCurrentSongURL = null; return; }
    let title = item.title || item.attributes?.name;
    let artist = item.artistName || item.attributes?.artistName;
    amCurrentSongURL = null;

    const songId = item.id || item.playParams?.catalogId;
    if ((!title || !artist) && songId) {
      const meta = await fetchSongMeta(songId, music.storefrontId || 'us');
      if (meta) { title = meta.name; artist = meta.artistName; amCurrentSongURL = meta.url || null; }
    }
    renderNow(title, artist);
  };
  music.addEventListener('mediaItemDidChange', update);
  music.addEventListener('playbackStateDidChange', update);
  update();
}

/* ---------- Apple: Create playlist via backend ---------- */
async function amCreatePlaylist(){
  try{
    const m = await getWebMusicInstance();
    if(!m.isAuthorized) await m.authorize();
    if(!lastTracks?.length){ qs('#amMsg').textContent='Generate a tracklist first.'; return; }

    qs('#amMsg').textContent='Creating playlist…';
    const name = `TimeDeck — ${qs('#date').value} — ${qs('#genre').value.toLowerCase()}`;
    const body = {
      userToken: m.musicUserToken,
      name,
      tracks: lastTracks.map(t=>({ artist:t.artist, title:t.title }))
    };
    const r = await withTimeout(fetch(`${API}/v1/apple/create-playlist`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
    }));
    const j = await r.json().catch(()=> ({}));
    if(!r.ok){ throw new Error(j.detail || `Create failed (${r.status})`); }

    qs('#amMsg').textContent = `Playlist created! Added ${j.added_count} of ${j.total_tracks}.`;
  }catch(e){
    console.error('[AM Create] failed', e);
    qs('#amMsg').textContent = 'Create failed: ' + (e.message || e);
  }
}

/* ---------- Helper: normalize MusicKit search response ---------- */
function pickSongIdFromSearch(res){
  const songs =
    res?.results?.songs?.data ??
    res?.songs?.data ??
    res?.data ??
    [];
  return (songs.length ? songs[0].id : null);
}

/* ---------- Apple: Built-in play (search → queue) ---------- */
async function amPlayBuiltIn(){
  if(!lastTracks?.length){ qs('#amMsg').textContent='Generate a tracklist first.'; return; }
  try{
    const m = await getWebMusicInstance();
    if(!m.isAuthorized) await m.authorize();

    const storefront = m.storefrontId || 'us';
    qs('#amMsg').textContent = `Searching ${lastTracks.length} tracks…`;

    const songIds = [];
    let i = 0;

    for (const t of lastTracks) {
      i++;
      if (i%6===0) qs('#amMsg').textContent = `Searching… (${i}/${lastTracks.length})`;

      try{
        const q1 = `${t.artist} ${t.title}`;
        const q2 = `${t.artist} - ${t.title}`;

        let res = await m.api.search(q1, { types:['songs'], limit:1, storefront });
        let id = pickSongIdFromSearch(res);

        if (!id) {
          res = await m.api.search(q2, { types:['songs'], limit:1, storefront });
          id = pickSongIdFromSearch(res);
        }

        if (id) songIds.push(id);
      }catch(_){}  // ignore individual misses

      await delay(100);
    }

    if (!songIds.length){
      qs('#amMsg').textContent = 'No Apple matches found.';
      return;
    }

    await m.setQueue({ songs: songIds });
    await guardedPlayPause('play');
    qs('#amMsg').textContent = `Now playing ${songIds.length} tracks.`;
  }catch(e){
    console.error('[AM Play] failed', e);
    qs('#amMsg').textContent = 'Playback failed: ' + (e.message || e);
  }
}

/* ---------- Guarded play/pause & transport ---------- */
async function guardedPlayPause(intent='toggle'){
  const m = await getWebMusicInstance();
  if (amPlayLock) return;
  amPlayLock = true;
  try{
    const PS = window.MusicKit.PlaybackState;
    const st = m.playbackState;
    if (intent==='play'){
      if (st!==PS.playing) await m.play();
    } else if (intent==='pause'){
      if (st===PS.playing || st===PS.loading || st===PS.buffering) await m.pause();
    } else {
      if (st===PS.playing || st===PS.loading || st===PS.buffering) await m.pause();
      else await m.play();
    }
  } finally { amPlayLock = false; }
}

/* ---------- Spotify (stubs you can hook up) ---------- */
let spAuthed = false;
function activateSpotifyUI(){
  spAuthed = true;
  qs('#spCreate').disabled = false;
  qs('#spOpen').disabled = false;
  qs('#spMsg').textContent = 'Connected. You can create a playlist.';
}
qs('#spConnect').onclick = () => {
  // Back-end should start OAuth login and redirect back here
  // e.g., location.href = `${API}/v1/spotify/login?redirect_uri=${encodeURIComponent(location.href)}`
  qs('#spMsg').textContent = 'Redirecting to Spotify sign-in…';
};
qs('#spCreate').onclick = async () => {
  if (!spAuthed) return;
  // POST to your backend endpoint to create playlist & add tracks
  // await fetch(`${API}/v1/spotify/create-playlist`, { ... })
};
qs('#spOpen').onclick = () => {
  // After backend returns playlist id, open https://open.spotify.com/playlist/<id>
};

/* ---------- Wire UI ---------- */
qs('#go').onclick = simulate;
qs('#amCreate').onclick = amCreatePlaylist;
qs('#amPlay').onclick = amPlayBuiltIn;

qs('#btnPrev').onclick = async ()=>{ try{ const m = await getWebMusicInstance(); await m.skipToPreviousItem(); }catch(e){} };
qs('#btnNext').onclick = async ()=>{ try{ const m = await getWebMusicInstance(); await m.skipToNextItem(); }catch(e){} };
qs('#btnPlayPause').onclick = ()=> guardedPlayPause('toggle');
qs('#btnOpen').onclick = ()=>{ if (amCurrentSongURL) window.open(amCurrentSongURL,'_blank','noopener'); else window.open('https://music.apple.com/','_blank','noopener'); };

/* ---------- Defaults ---------- */
setTab('am');
</script>
</body>
</html>
