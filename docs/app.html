<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TapeDeck Time Machine</title>

  <!-- MusicKit JS -->
  <script src="https://js-cdn.music.apple.com/musickit/v3/musickit.js"></script>

  <!-- Meta / Social -->
  <meta name="description" content="Rewind the radio you grew up with. Generate playlists from any date and genre, powered by Billboard chart data.">
  <link rel="icon" href="/logo.svg" type="image/svg+xml"><!-- no favicon.ico until you add one -->
  <link rel="apple-touch-icon" href="/logo.svg">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://tapedecktimemachine.com/">
  <meta property="og:title" content="TapeDeck Time Machine - Historical Music Playlist Generator">
  <meta property="og:description" content="Rewind the radio you grew up with. Generate playlists from any date and genre.">
  <meta property="og:image" content="https://tapedecktimemachine.com/tapedeck-preview.png">
  <meta property="og:image:width" content="1200"><meta property="og:image:height" content="630">
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://tapedecktimemachine.com/">
  <meta property="twitter:title" content="TapeDeck Time Machine - Historical Music Playlist Generator">
  <meta property="twitter:description" content="Rewind the radio you grew up with. Generate playlists from any date and genre.">
  <meta property="twitter:image" content="https://tapedecktimemachine.com/tapedeck-preview.png">

  <!-- GA -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HPZT6BMJVD"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-HPZT6BMJVD');
  </script>

  <style>
    :root{
      --bg:#0a0f17;--panel:#111827;--muted:#94a3b8;--text:#e5e7eb;
      --accent:#8b5cf6;--accent2:#22d3ee;--shadow:0 12px 48px rgba(2,10,20,.45)
    }
    *{box-sizing:border-box}
    body{margin:0;background:
      radial-gradient(1200px 600px at 10% -10%, #0e1630 0%, transparent 60%),
      radial-gradient(700px 400px at 120% 10%, #06101f 0%, transparent 60%), #0a0f17;
      color:var(--text); font:16px/1.5 -apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;}
    .wrap{max-width:1100px;margin:40px auto;padding:0 18px}
    .bar{display:flex;align-items:center;gap:14px}
    .logo{width:36px;height:36px;border-radius:12px;background:
      linear-gradient(135deg,#8b5cf6 0%,#22d3ee 55%,#16a34a 120%);
      display:grid;place-items:center;color:#fff;font-weight:800;box-shadow:var(--shadow);text-decoration:none}
    h1{font-size:22px;margin:0}
    .panel{background:rgba(17,24,39,.75);border:1px solid rgba(148,163,184,.12);
      border-radius:18px;padding:16px;box-shadow:var(--shadow)}
    .grid{display:grid;grid-template-columns:1.2fr 1fr 1fr 1fr 1fr auto; gap:12px; align-items:end}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px 2px}
    input,select,button{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(148,163,184,.18);
      background:#0c1422;color:var(--text);outline:none;font-size:1rem}
    button.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));border:0;font-weight:700;cursor:pointer}
    .tabs{display:flex;gap:10px;margin:14px 0 8px}
    .tab{padding:9px 14px;border-radius:999px;border:1px solid rgba(148,163,184,.2);
      background:#0c1422;color:var(--text);cursor:pointer}
    .tab.active{background:linear-gradient(135deg,rgba(139,92,246,.25),rgba(34,211,238,.18));border-color:transparent}
    .cols{display:grid;grid-template-columns:1.05fr .95fr; gap:16px}
    .box{min-height:380px}
    iframe{width:100%;height:360px;border:0;border-radius:12px;box-shadow:var(--shadow)}
    .btn{display:inline-block;margin-top:8px;padding:10px 14px;border-radius:12px;border:1px solid rgba(148,163,184,.2);
      background:#0c1422;color:#e5e7eb;text-decoration:none;font-weight:700;cursor:pointer}
    .btn.inline{padding:8px 10px}
    .btn.ghost{background:transparent}
    .muted{color:var(--muted)}
    .list{padding:12px 8px;max-height:420px;overflow:auto}
    .row{display:grid;grid-template-columns:110px 1fr;gap:14px; padding:10px 6px;border-bottom:1px dashed rgba(148,163,184,.12)}
    .ts{font:12px/1.3 ui-monospace,SFMono-Regular,Menlo,monospace;color:var(--muted)}
    .err{color:#fda4af;margin-top:6px}
    .ok{color:#86efac;margin-top:6px}

    /* Mini-player */
    .mini{display:none;margin-top:12px;background:rgba(12,20,34,.8);border:1px solid rgba(148,163,184,.12);border-radius:14px;padding:10px}
    .mini .row1{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
    .mini .art{width:44px;height:44px;border-radius:10px;background:#0c1422;object-fit:cover}
    .mini .meta{min-width:0}
    .mini .title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .mini .artist{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .mini .controls{display:flex;gap:6px;align-items:center}
    .mini .controls .btn{padding:6px 10px}
    .mini .row2{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;margin-top:8px}
    .mini input[type="range"]{width:100%}
    .mini .row3{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;margin-top:8px}
    .mini .vol{display:flex;align-items:center;gap:8px}
    .mini .open{font-size:12px}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(148,163,184,.2);border-radius:999px;padding:6px 10px;background:#0c1422}

    @media (max-width:800px){.grid{grid-template-columns:1fr 1fr}.grid>div:last-child{grid-column:1/-1}}
    @media (max-width:700px){.wrap{margin:20px auto}.cols{grid-template-columns:1fr}h1{font-size:18px}}
    @media (max-width:500px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>

<div class="wrap">
  <div class="bar" style="margin-bottom:14px">
    <a class="logo" href="/" title="Back to home">TD</a>
    <h1>TapeDeck Time Machine</h1>
  </div>

  <div class="panel">
    <div class="grid">
      <div><label>Date</label><input id="date" placeholder="mm/dd/yyyy" value="07/01/2002"></div>
      <div><label>Genre</label>
        <select id="genre">
          <option>Alternative</option><option>Hot-100</option><option>Pop</option>
          <option>Rock</option><option>Country</option><option>R&B/Hip-Hop</option><option>Dance/Electronic</option>
        </select>
      </div>
      <div><label>Hours</label><select id="hours"><option>0.5</option><option selected>1</option><option>2</option><option>3</option></select></div>
      <div><label>Repeat gap (min)</label><input id="gap" type="number" value="90"></div>
      <div><label>Seed (opt)</label><input id="seed" placeholder="e.g. 20020701"></div>
      <div><label>&nbsp;</label><button id="go" class="primary">Generate</button></div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="yt">YouTube</button>
      <button class="tab" data-tab="am">Apple Music</button>
      <button class="tab" data-tab="sp" disabled title="Coming soon">Spotify</button>
    </div>
    <div class="muted" style="margin:-6px 0 8px 2px">Spotify sign-in is under construction. Coming soon!</div>

    <div class="cols">
      <div class="panel box" id="pane-yt">
        <div id="ytWrap">
          <div class="muted" id="ytStatus">Waiting for a simulation‚Ä¶</div>
          <div id="ytp"></div>
          <a class="btn" id="ytOpen" href="#" target="_blank" rel="noopener" style="display:none">Open in YouTube</a>
          <div id="ytErr" class="err"></div>
        </div>
      </div>

      <div class="panel box" id="pane-am" style="display:none">
        <div id="amWrap">
          <div class="muted" style="margin-bottom:8px">Sign in with Apple Music to play or create a playlist.</div>
          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <button class="btn" id="amSign">Sign in to Apple Music</button>
            <button class="btn" id="amPlay" style="display:none">Play Playlist</button>
            <button class="btn" id="amCreate" style="display:none">Create Playlist</button>
            <button class="btn" id="amTest" style="display:none">Test Apple Track</button>
          </div>
          <div id="amMsg" class="muted" style="margin-top:8px"></div>

          <!-- Mini-player (Apple MusicKit driven) -->
          <div id="mini" class="mini">
            <div class="row1">
              <img id="miniArt" class="art" alt="">
              <div class="meta">
                <div id="miniTitle" class="title">‚Äî</div>
                <div id="miniArtist" class="artist">‚Äî</div>
              </div>
              <div class="controls">
                <button id="btnPrev" class="btn inline">‚ü®‚ü®</button>
                <button id="btnPlayPause" class="btn inline">‚ñ∂</button>
                <button id="btnNext" class="btn inline">‚ü©‚ü©</button>
                <button id="btnShuffle" class="btn inline ghost" title="Shuffle">üîÄ</button>
                <button id="btnRepeat" class="btn inline ghost" title="Repeat">üîÅ</button>
              </div>
            </div>
            <div class="row2">
              <div id="miniT1" class="muted" style="font-variant-numeric: tabular-nums;">0:00</div>
              <input id="miniSeek" type="range" min="0" max="1000" value="0">
              <div id="miniT2" class="muted" style="font-variant-numeric: tabular-nums;">0:00</div>
            </div>
            <div class="row3">
              <span class="badge">Apple Music MiniPlayer</span>
              <div class="vol">
                <span class="muted" style="font-size:12px;">Vol</span>
                <input id="miniVol" type="range" min="0" max="1" step="0.01" value="1">
              </div>
              <a id="miniOpen" class="open muted" href="#" target="_blank" rel="noopener" style="text-decoration:none">Open in Apple Music ‚Üó</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="panel" style="margin-top:16px">
    <h2>Your Music Time Machine Playlist</h2>
    <p class="muted" style="margin-bottom:6px">
      Ever wonder <strong>what songs were popular on your birthday?</strong>
      Just pick a date and genre, and we'll <strong>generate a music playlist</strong>
      of the top songs from that week, based on <strong>historical Billboard charts</strong>.
      The tracklist will appear below.
    </p>
    <div id="list" class="list"></div>
  </div>
</div>

<script>
  // ---------- helpers / config ----------
  const qs = s => document.querySelector(s);
  const API = new URLSearchParams(location.search).get('api') || 'https://timedeck-api.onrender.com';
  const NET_TIMEOUT_MS = 180000;
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  function toISO(mmddyyyy){ const [mm,dd,yyyy] = mmddyyyy.split('/'); return `${yyyy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}`; }
  function setTab(id){
    document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
    qs('#pane-yt').style.display = id==='yt' ? '' : 'none';
    qs('#pane-am').style.display = id==='am' ? '' : 'none';
  }
  document.querySelectorAll('.tab').forEach(b=>b.onclick=()=>setTab(b.dataset.tab));
  function withTimeout(promise, ms = NET_TIMEOUT_MS) {
    let t; const timer = new Promise((_, rej)=>{ t=setTimeout(()=>rej(new Error(`Network timeout after ${Math.round(ms/1000)}s`)), ms); });
    return Promise.race([promise.finally(()=>clearTimeout(t)), timer]);
  }

  // ---------- state ----------
  let lastTracks = [];
  let isAuthorizing = false;
  let DEV_TOKEN = null;

  // ---------- YouTube ----------
  let player = null, YTapiReady = false;
  (function(){ const tag=document.createElement('script'); tag.src="https://www.youtube.com/iframe_api"; document.head.appendChild(tag); })();
  window.onYouTubeIframeAPIReady = () => { YTapiReady = true; };

  async function simulate(){
    const body = {
      date: toISO(qs('#date').value.trim()),
      genre: qs('#genre').value,
      hours: Number(qs('#hours').value || 3),
      repeat_gap_min: Number(qs('#gap').value || 90),
      seed: (qs('#seed').value.trim() || undefined) ? String(qs('#seed').value.trim()) : undefined,
      limit: 500
    };
    qs('#ytStatus').textContent = 'Building‚Ä¶';
    qs('#ytErr').textContent = '';

    if (player) { try{ player.destroy(); }catch{} player = null; }
    qs('#ytp').innerHTML = ''; qs('#ytp').style.display = 'none';
    qs('#ytOpen').style.display = 'none'; qs('#list').innerHTML = '';
    lastTracks = [];

    try{
      const r = await withTimeout(fetch(`${API}/v1/simulate`, {
        method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body)
      }));
      if(!r.ok){ const txt = await r.text().catch(()=> ''); throw new Error(`simulate ${r.status}: ${txt}`); }
      const data = await r.json();
      lastTracks = data.tracks || [];
      if(!lastTracks.length){ qs('#ytStatus').textContent=''; qs('#ytErr').textContent='No tracks returned. Try a different date/genre.'; return; }
      renderList(lastTracks);
      buildYouTube(lastTracks);
    }catch(err){
      qs('#ytStatus').textContent = '';
      qs('#ytErr').textContent = err.message || String(err);
    }
  }

  function renderList(rows){
    if(!rows?.length){ qs('#list').innerHTML = '<div class="muted">No tracks.</div>'; return; }
    const frag = document.createDocumentFragment();
    rows.slice(0,500).forEach(t=>{
      const d = document.createElement('div'); d.className='row';
      d.innerHTML = `<div class="ts">${t.timestamp.replace('T',' ')}</div>
                     <div><strong>${t.artist}</strong> ‚Äî <em>${t.title}</em>
                     <span class="muted">‚Ä¢ ${t.source_rank ?? ''}</span></div>`;
      frag.appendChild(d);
    });
    qs('#list').replaceChildren(frag);
  }

  async function buildYouTube(tracks){
    qs('#ytStatus').textContent = 'Resolving YouTube IDs‚Ä¶';
    try{
      const r = await withTimeout(fetch(`${API}/v1/yt/resolve`, {
        method:'POST', headers:{'content-type':'application/json'},
        body: JSON.stringify({ tracks: tracks.map(t=>({artist:t.artist,title:t.title})), limit:50 })
      }));
      if(!r.ok){ throw new Error(`yt/resolve ${r.status}: ${await r.text()}`); }
      const data = await r.json();
      const ids = (data.ids || []).filter(Boolean);

      if(!ids.length){ qs('#ytStatus').textContent = 'No playable videos found (try another date/genre).'; return; }

      const openUrl = `https://www.youtube.com/watch_videos?video_ids=${ids.join(',')}`;
      qs('#ytOpen').href = openUrl; qs('#ytOpen').style.display = 'inline-block';
      qs('#ytStatus').textContent = `${ids.length} videos found. Loading player...`;

      if (player) {
        try{ player.cuePlaylist(ids, 0, 0); qs('#ytStatus').textContent = `${ids.length} videos queued.`; }
        catch { player = null; }
      }
      if (!player) {
        if (YTapiReady && qs('.tab[data-tab="yt"]').classList.contains('active')) {
          qs('#ytp').style.display = 'block';
          player = new YT.Player('ytp', {
            height: '360', width: '100%',
            playerVars: { playsinline: 1, rel: 0, modestbranding: 1, origin: location.origin },
            events: { onReady: (e) => { e.target.cuePlaylist(ids, 0, 0); qs('#ytStatus').textContent = `${ids.length} videos queued.`; } }
          });
        } else if (!YTapiReady) {
          qs('#ytStatus').textContent = 'YouTube API is still loading. Use "Open in YouTube".';
        } else {
          qs('#ytStatus').textContent = `${ids.length} videos ready. Switch to YouTube tab to play.`;
        }
      }
    }catch(err){
      qs('#ytErr').textContent = err.message; qs('#ytStatus').textContent = '';
    }
  }

  // ---------- MusicKit robust loader ----------
  let music = null;
  let musicInitPromise = null;

  function waitForMusicKitLoaded(timeoutMs = 10000){
    if (window.MusicKit && typeof window.MusicKit.configure === 'function') return Promise.resolve();
    return new Promise((resolve, reject) => {
      const t = setTimeout(()=>reject(new Error('MusicKit load timed out')), timeoutMs);
      window.addEventListener('musickitloaded', () => { clearTimeout(t); resolve(); }, { once:true });
    });
  }

  async function fetchDeveloperToken() {
    if (DEV_TOKEN) return DEV_TOKEN;
    const r = await withTimeout(fetch(`${API}/v1/apple/dev-token`, { headers: { 'accept':'application/json' } }));
    if (!r.ok) throw new Error(`dev-token ${r.status}`);
    const { token } = await r.json();
    if (!token || typeof token !== 'string' || token.trim().length < 20) throw new Error('Invalid developer token');
    DEV_TOKEN = token.trim();
    return DEV_TOKEN;
  }

  async function getWebMusicInstance(force = false){
    if (music && !force) return music;
    if (!musicInitPromise || force) {
      musicInitPromise = (async () => {
        await waitForMusicKitLoaded();
        const developerToken = await fetchDeveloperToken();

        window.MusicKit.configure({
          developerToken,
          app: { name: 'TapeDeck Time Machine', build: 'web' }
        });

        // Wait for instance
        let inst = null;
        for (let i = 0; i < 40; i++) { try { inst = window.MusicKit.getInstance(); } catch {}
          if (inst) break; await sleep(50);
        }
        if (!inst) throw new Error('MusicKit instance missing after configure');

        const stored = localStorage.getItem('appleMusicUserToken');
        if (stored) inst.musicUserToken = stored;

        // Best-effort storefront
        try {
          if (!inst.storefrontId && inst.api && typeof inst.api.storefront === 'function') {
            const sf = await inst.api.storefront();
            inst.storefrontId = (sf?.data?.[0]?.id) || 'us';
          }
        } catch { inst.storefrontId = inst.storefrontId || 'us'; }
        inst.storefrontId = inst.storefrontId || 'us';

        music = inst;
        registerPlayerEvents(inst);   // wire events once
        return music;
      })().catch(e => { musicInitPromise = null; throw e; });
    }
    return musicInitPromise;
  }

  // ---------- Apple Music REST Catalog Search (dev token) ----------
  async function appleCatalogSearch(term, storefront = 'us', limit = 1) {
    const dev = await fetchDeveloperToken();
    const url = new URL(`https://api.music.apple.com/v1/catalog/${encodeURIComponent(storefront)}/search`);
    url.searchParams.set('term', term);
    url.searchParams.set('types', 'songs');
    url.searchParams.set('limit', String(limit));
    const r = await withTimeout(fetch(url.toString(), { headers: { Authorization: `Bearer ${dev}` } }), 15000);
    if (!r.ok) throw new Error(`Apple search ${r.status}`);
    return r.json();
  }

  // ---------- Mini-player wiring ----------
  const mini = {
    root: qs('#mini'),
    art: qs('#miniArt'),
    title: qs('#miniTitle'),
    artist: qs('#miniArtist'),
    t1: qs('#miniT1'),
    t2: qs('#miniT2'),
    seek: qs('#miniSeek'),
    vol: qs('#miniVol'),
    open: qs('#miniOpen'),
    btnPrev: qs('#btnPrev'),
    btnPlayPause: qs('#btnPlayPause'),
    btnNext: qs('#btnNext'),
    btnShuffle: qs('#btnShuffle'),
    btnRepeat: qs('#btnRepeat'),
    showing: false,
  };

  function fmtTime(sec){
    sec = Math.max(0, Math.floor(sec||0));
    const m = Math.floor(sec/60), s = sec%60;
    return `${m}:${String(s).padStart(2,'0')}`;
  }
  function artworkURL(art, size=120){
    // Apple artwork templating: .../{w}x{h}bb.jpg
    const u = art?.url || '';
    return u ? u.replace('{w}', size).replace('{h}', size) : '';
  }
  function showMini() {
    if (!mini.showing) { mini.root.style.display = 'block'; mini.showing = true; }
  }
  function setPlayIcon(isPlaying){ mini.btnPlayPause.textContent = isPlaying ? '‚è∏' : '‚ñ∂'; }
  function setShuffleIcon(on){ mini.btnShuffle.style.opacity = on ? 1 : 0.6; }
  function setRepeatIcon(mode){
    // 0 off, 1 one, 2 all (MusicKit constant values; visual hint only)
    const map = {0:'üîÅ',1:'üîÇ',2:'üîÅ'};
    mini.btnRepeat.textContent = map[mode] || 'üîÅ';
    mini.btnRepeat.style.opacity = mode ? 1 : 0.6;
  }

  function updateNowPlaying(m){
    const item = m?.player?.nowPlayingItem;
    const attr = item?.attributes || {};
    mini.title.textContent = attr.name || '‚Äî';
    mini.artist.textContent = attr.artistName || '‚Äî';
    const art = artworkURL(attr.artwork, 120);
    if (art) { mini.art.src = art; mini.art.alt = attr.name || ''; }
    mini.open.href = attr.url || '#';
  }

  function updateTimes(m){
    const cur = m?.player?.currentPlaybackTime || 0;
    const dur = m?.player?.currentPlaybackDuration || 0;
    mini.t1.textContent = fmtTime(cur);
    mini.t2.textContent = dur ? fmtTime(dur) : '0:00';
    mini.seek.max = Math.max(1, Math.floor(dur*10));
    mini.seek.value = Math.floor(cur*10);
  }

  function registerPlayerEvents(m){
    if (!m || !m.player) return;

    // Avoid double binding: use a flag
    if (m._tdtmBound) return;
    m._tdtmBound = true;

    m.addEventListener('playbackStateDidChange', () => {
      const st = m.player.playbackState; // 2 playing, 3 paused (values may vary; icon uses isPlaying)
      setPlayIcon(!!m.player.isPlaying);
      showMini();
    });
    m.addEventListener('nowPlayingItemDidChange', () => {
      updateNowPlaying(m);
    });
    m.addEventListener('playbackTimeDidChange', () => {
      updateTimes(m);
    });
  }

  // ---------- UI helpers ----------
  function showAmControls() {
    qs('#amSign').style.display = 'none';
    qs('#amPlay').style.display = 'inline-block';
    qs('#amCreate').style.display = 'inline-block';
    qs('#amTest').style.display = 'inline-block';
    showMini(); // reveal mini shell; it'll populate as soon as something is playing
  }

  // ---------- Sign-in ----------
  async function amSignIn(){
    if (isAuthorizing) return;
    isAuthorizing = true;
    try {
      qs('#amMsg').textContent = 'Contacting Apple‚Ä¶';
      let m = await getWebMusicInstance(true);
      const tok = await m.authorize();
      await sleep(150);
      if (!tok || typeof tok !== 'string' || tok.length < 20) {
        qs('#amMsg').textContent = 'Sign-in cancelled or failed. Apple Music subscription required for full playback.';
        return;
      }
      localStorage.setItem('appleMusicUserToken', tok);
      m.musicUserToken = tok;
      m = await getWebMusicInstance(true);

      if (!m.musicUserToken) {
        qs('#amMsg').textContent = 'Apple Music did not return a valid session. Please try again.';
        return;
      }
      qs('#amMsg').textContent = 'Signed in. Generate a list to play or create.';
      showAmControls();
    } catch(e){
      qs('#amMsg').textContent = 'Sign-in failed: ' + (e.message || e);
    } finally { isAuthorizing = false; }
  }

  // ---------- REST search ‚Üí queue ‚Üí play ----------
  async function amPlayPlaylist() {
    qs('#amMsg').textContent = '';
    let m;
    try {
      m = await getWebMusicInstance();
      if (!m.musicUserToken) {
        qs('#amMsg').textContent = 'Please sign in to Apple Music first (subscriber account required).';
        return;
      }
      const storefront = m.storefrontId || 'us';
      if (!lastTracks?.length) {
        qs('#amMsg').textContent = 'Generate a tracklist first.';
        return;
      }

      qs('#amMsg').textContent = `Searching for ${lastTracks.length} tracks...`;
      const songIds = [];
      for (let i=0; i<lastTracks.length; i++){
        const t = lastTracks[i];
        if ((i+1) % 5 === 0 || i+1 === lastTracks.length) {
          qs('#amMsg').textContent = `Searching... (${i+1}/${lastTracks.length})`;
        }
        try {
          const term = `${t.artist} ${t.title}`.replace(/\s+\(.*?\)|-+\s*(radio edit|remaster.*|remix.*)/ig, '').trim();
          const res = await appleCatalogSearch(term, storefront, 1);
          const id = res?.results?.songs?.data?.[0]?.id;
          if (id) songIds.push(id);
          await sleep(60);
        } catch {}
      }

      if (!songIds.length) { qs('#amMsg').textContent = 'None of the tracks could be found in Apple Music.'; return; }

      qs('#amMsg').textContent = `Found ${songIds.length} tracks. Adding to queue...`;
      await m.setQueue({ songs: songIds });
      await m.play();
      setPlayIcon(true);
      updateNowPlaying(m); updateTimes(m);
      showMini();
      qs('#amMsg').textContent = `Now playing ${songIds.length} tracks!`;
    } catch (e) {
      qs('#amMsg').textContent = 'Playback failed: ' + (e.message || e);
    }
  }

  // ---------- Create playlist (backend) ----------
  async function amCreatePlaylist(){
    const userToken = localStorage.getItem('appleMusicUserToken');
    if(!userToken){ qs('#amMsg').textContent='Please sign in first.'; return; }
    if(!lastTracks?.length){ qs('#amMsg').textContent='Generate a tracklist first.'; return; }

    qs('#amMsg').textContent='Creating playlist‚Ä¶';
    try{
      const name = `TimeDeck ‚Äî ${qs('#date').value} ‚Äî ${qs('#genre').value.toLowerCase()}`;
      const r = await withTimeout(fetch(`${API}/v1/apple/create-playlist`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userToken, name, tracks: lastTracks.map(t=>({artist:t.artist,title:t.title})) })
      }));
      if(!r.ok){
        const j = await r.json().catch(() => ({ detail: 'Unknown error during create' }));
        throw new Error(j.detail || `Create failed with status ${r.status}`);
      }
      const j = await r.json();
      qs('#amMsg').textContent = `Playlist created! Added ${j.added_count} of ${j.total_tracks} tracks.`;
    } catch(e){
      qs('#amMsg').textContent = 'Create failed: ' + (e.message || String(e));
    }
  }

  // ---------- One-track sanity (still handy) ----------
  async function amTestOne() {
    qs('#amMsg').textContent = 'Running Apple Music sanity test...';
    try {
      let m = await getWebMusicInstance(true);
      if (!m.isAuthorized) {
        const tok = await m.authorize();
        if (!tok) throw new Error('No user token from Apple (cancelled or not a subscriber).');
        localStorage.setItem('appleMusicUserToken', tok);
        m.musicUserToken = tok;
        m = await getWebMusicInstance(true);
      }
      const storefront = m.storefrontId || 'us';
      const res = await appleCatalogSearch('rick astley never gonna give you up', storefront, 1);
      const id = res?.results?.songs?.data?.[0]?.id;
      if (!id) throw new Error('Search returned no songs.');
      await m.setQueue({ songs: [id] });
      await m.play();
      setPlayIcon(true);
      updateNowPlaying(m); updateTimes(m);
      showMini();
      qs('#amMsg').textContent = 'Sanity test playing! (If you hear audio, tokens are fine.)';
    } catch (e) {
      qs('#amMsg').innerHTML =
        'Sanity test failed: ' + (e.message || e) +
        '<br><span class="muted">Likely causes: no active Apple Music subscription, invalid developer token, or storefront mismatch.</span>';
    }
  }

  // ---------- Mini-player controls ----------
  qs('#btnPlayPause').onclick = async () => {
    const m = await getWebMusicInstance();
    if (m?.player?.isPlaying) { await m.pause(); setPlayIcon(false); }
    else { await m.play(); setPlayIcon(true); }
  };
  qs('#btnPrev').onclick = async () => { const m = await getWebMusicInstance(); try{ await m.skipToPreviousItem(); }catch{} };
  qs('#btnNext').onclick = async () => { const m = await getWebMusicInstance(); try{ await m.skipToNextItem(); }catch{} };
  qs('#miniSeek').oninput = async (e) => {
    const m = await getWebMusicInstance();
    const dur = m?.player?.currentPlaybackDuration || 0;
    const target = (Number(e.target.value)/10);
    if (dur) { try{ await m.seekToTime(Math.min(target, dur-0.25)); }catch{} }
  };
  qs('#miniVol').oninput = async (e) => {
    const m = await getWebMusicInstance();
    if (m?.player) m.player.volume = Number(e.target.value);
  };
  qs('#btnShuffle').onclick = async () => {
    const m = await getWebMusicInstance();
    if (!m?.player) return;
    // Toggle: 0 off -> 1 on (MusicKit sets constants but boolean works too)
    m.player.shuffleMode = m.player.shuffleMode ? 0 : 1;
    setShuffleIcon(!!m.player.shuffleMode);
  };
  qs('#btnRepeat').onclick = async () => {
    const m = await getWebMusicInstance();
    if (!m?.player) return;
    // Cycle repeat: 0 off -> 2 all -> 1 one -> 0
    const next = (m.player.repeatMode === 0) ? 2 : (m.player.repeatMode === 2 ? 1 : 0);
    m.player.repeatMode = next;
    setRepeatIcon(next);
  };

  // ---------- initial state ----------
  (function(){
    const storedToken = localStorage.getItem('appleMusicUserToken');
    if (storedToken) {
      qs('#amMsg').textContent = 'Signed in. Generate a list to play or create.';
      showAmControls();
      getWebMusicInstance(true).catch(()=>{});
    }
  })();

  // ---------- wire up ----------
  qs('#go').onclick = simulate;
  qs('#amSign').onclick = amSignIn;
  qs('#amPlay').onclick = amPlayPlaylist;
  qs('#amCreate').onclick = amCreatePlaylist;
  qs('#amTest').onclick = amTestOne;

  setTab('yt');
</script>

</body>
</html>
