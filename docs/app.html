<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TapeDeck Time Machine</title>

<!-- MusicKit v3 -->
<script src="https://js-cdn.music.apple.com/musickit/v3/musickit.js" defer></script>

<style>
  :root{
    --bg:#0c1218; --panel:#121a22; --panel2:#0f161d;
    --text:#dfe7ef; --muted:#9fb1c4; --accent1:#8a7dff; --accent2:#2cd3ff;
    --ring:#223240; --good:#29d39a; --warn:#ffbe55; --bad:#ff6b6b;
    --btn-grad: linear-gradient(90deg,var(--accent1),var(--accent2));
    --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:radial-gradient(1200px 600px at 10% -10%, #121b27 0%, #0c1218 55%) fixed, var(--bg);
    color:var(--text); font:16px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif;
  }
  a{color:inherit; text-decoration:none}
  .max{max-width:1180px;margin:24px auto;padding:0 16px}

  /* Header */
  .bar{display:flex;align-items:center;gap:12px;margin:8px 0 18px}
  .logo{display:flex;align-items:center;gap:12px}
  .logo img{width:36px;height:36px;border-radius:9px;box-shadow:0 6px 18px rgba(0,0,0,.35)}
  .title{font-weight:700;font-size:22px;letter-spacing:.2px}

  /* Card containers */
  .frame{border-radius:var(--radius); background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.00)) , var(--panel);
         box-shadow:0 12px 40px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.03); padding:18px}
  .grid{
    display:grid; gap:14px;
    grid-template-columns: 1fr;
  }
  /* tablet */
  @media (min-width:760px){
    .grid{grid-template-columns: repeat(2, 1fr);}
  }
  /* desktop */
  @media (min-width:1060px){
    .grid{grid-template-columns: repeat(4, 1fr);}
  }

  label{display:block;color:var(--muted);font-size:12px;margin:6px 0 8px}
  .ctl{
    width:100%; border:1px solid var(--ring); background:var(--panel2); color:var(--text);
    border-radius:10px; padding:12px 12px; outline:none;
  }
  .ctl:focus{border-color:#2b4458; box-shadow:0 0 0 3px rgba(44,211,255,.12)}
  select.ctl{appearance:none}

  .tabs{display:flex;gap:10px;margin:14px 0 4px;flex-wrap:wrap}
  .seg{
    padding:10px 16px;border-radius:999px;background:var(--panel2); border:1px solid var(--ring); color:var(--text);
    cursor:pointer; user-select:none;
  }
  .seg.active{background:radial-gradient(120% 140% at 20% 20%, rgba(138,125,255,.25), rgba(44,211,255,.18)), #0f1720; border-color:#34526b}

  .btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;
       padding:12px 16px;border-radius:12px;border:1px solid var(--ring); background:var(--panel2); color:var(--text);
       cursor:pointer; user-select:none; white-space:nowrap}
  .btn.primary{background:var(--btn-grad); border-color:transparent; color:#0d1220; font-weight:700}
  .btn:disabled{opacity:.5; cursor:not-allowed}

  .row{display:flex;gap:10px;flex-wrap:wrap}
  .spacer{flex:1}

  /* Two-panel layout below the form */
  .two{
    display:grid; gap:16px; margin-top:16px;
    grid-template-columns: 1fr;
  }
  @media (min-width:1060px){ .two{grid-template-columns: 1.2fr 1fr;} }

  .subtle{color:var(--muted); font-size:14px}

  /* Mini player */
  .player{
    border-radius:14px; background:var(--panel2); border:1px solid var(--ring); padding:12px;
  }
  .np{
    display:flex; align-items:center; gap:10px; min-height:22px;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .np .dot{width:8px;height:8px;border-radius:50%;background:var(--good); box-shadow:0 0 8px rgba(41,211,154,.7)}
  .controls{display:flex;align-items:center;gap:10px;margin-top:10px}
  .cbtn{width:44px;height:44px;border-radius:10px;border:1px solid var(--ring);background:var(--panel);display:flex;align-items:center;justify-content:center;cursor:pointer}
  .cbtn:active{transform:translateY(1px)}
  .np-title{min-width:0;overflow:hidden;text-overflow:ellipsis}

  /* Visualizer (CSS-only fake bars) */
  .viz{
    height:260px;border-radius:14px;background:linear-gradient(180deg, rgba(138,125,255,.06), rgba(44,211,255,.05)), var(--panel2);
    border:1px solid var(--ring); overflow:hidden; position:relative; padding:18px
  }
  .bars{position:absolute;inset:18px;display:flex;gap:6px;align-items:flex-end}
  .bar{flex:1;min-width:8px;background:linear-gradient(180deg, rgba(44,211,255,.85), rgba(138,125,255,.85));
       border-radius:6px; opacity:.9; animation:hop 1.6s ease-in-out infinite}
  .bar:nth-child(4n+1){animation-delay:.0s}
  .bar:nth-child(4n+2){animation-delay:.2s}
  .bar:nth-child(4n+3){animation-delay:.4s}
  .bar:nth-child(4n+4){animation-delay:.6s}
  @keyframes hop{
    0%,100%{height:20%} 20%{height:60%} 40%{height:30%} 60%{height:75%} 80%{height:40%}
  }

  .list{margin-top:18px}
  .chip{display:inline-flex;align-items:center;gap:8px;background:var(--panel2);border:1px solid var(--ring);
        padding:8px 10px;border-radius:999px;margin:4px 6px 0 0;font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <div class="max">
    <!-- Header -->
    <div class="bar">
      <a class="logo" href="/index.html" aria-label="Back to Home">
        <img src="https://tapedecktimemachine.com/favicon-196.png" alt="TD" />
        <div class="title">TapeDeck Time Machine</div>
      </a>
      <div class="spacer"></div>
    </div>

    <!-- Form card -->
    <div class="frame">
      <div class="grid">
        <div>
          <label for="date">Date</label>
          <input id="date" class="ctl" type="date" />
        </div>
        <div>
          <label for="genre">Genre</label>
          <select id="genre" class="ctl">
            <option>Alternative</option>
            <option>Pop</option>
            <option>Rock</option>
            <option>Country</option>
            <option>R&B</option>
            <option>Hip-Hop</option>
            <option>Dance</option>
            <option>Adult Contemporary</option>
          </select>
        </div>
        <div>
          <label for="hours">Hours</label>
          <select id="hours" class="ctl">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3" selected>3</option>
            <option value="4">4</option>
          </select>
        </div>
        <div>
          <label for="gap">Repeat gap (min)</label>
          <input id="gap" class="ctl" type="number" min="0" value="90" />
        </div>
        <div>
          <label for="seed">Seed (opt)</label>
          <input id="seed" class="ctl" placeholder="e.g. 20020701" />
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="btnGenerate" class="btn primary" style="width:100%;">Generate</button>
        </div>
      </div>

      <div class="tabs">
        <button class="seg active" id="tab-yt">YouTube</button>
        <button class="seg active" id="tab-am">Apple Music</button>
        <button class="seg" id="tab-spot">Spotify</button>
      </div>

      <div class="two">
        <!-- Left: actions + mini player -->
        <div class="frame" style="background:var(--panel2)">
          <p class="subtle" id="status">Generate a list, then choose how to play or save it.</p>

          <div class="row" style="margin:10px 0 8px">
            <button id="btnCreateAM" class="btn" title="Create Apple Music playlist">Create Playlist (Apple)</button>
            <button id="btnPlayAM" class="btn">Play with Built-In Player</button>
            <div class="spacer"></div>
            <button id="btnSpotifyLogin" class="btn" title="Sign in with Spotify">Spotify Sign-In</button>
            <button id="btnCreateSP" class="btn">Create Spotify Playlist</button>
          </div>

          <div class="player" id="mini">
            <div class="np" id="np">
              <div class="dot" id="npdot" hidden></div>
              <div class="np-title" id="nptitle">—</div>
              <div class="spacer"></div>
              <a id="openAM" class="btn" style="padding:6px 10px;border-radius:8px">Open ↗</a>
            </div>
            <div class="controls">
              <button class="cbtn" id="btnPrev" title="Previous" aria-label="Previous">«</button>
              <button class="cbtn" id="btnPP"   title="Play/Pause" aria-label="Play or Pause">⏯</button>
              <button class="cbtn" id="btnNext" title="Next" aria-label="Next">»</button>
            </div>
          </div>

          <div class="list" id="chips"></div>
        </div>

        <!-- Right: visualizer / “time capsule” slot -->
        <div class="frame" style="background:var(--panel2)">
          <div class="tabs" style="margin-top:-2px">
            <div class="seg active">Visualizer</div>
            <div class="seg">Time Capsule</div>
          </div>
          <div class="viz">
            <div class="bars" id="bars"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const API = location.origin.includes("tapedecktimemachine.com")
    ? "https://timedeck-api.onrender.com" /* change if your Render URL differs */
    : location.origin;

  // DOM helpers
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const setText = (el, t) => { el.textContent = t; };

  // Elements
  const dateEl = $("#date");
  const genreEl = $("#genre");
  const hoursEl = $("#hours");
  const gapEl = $("#gap");
  const seedEl = $("#seed");

  const btnGenerate = $("#btnGenerate");
  const btnCreateAM = $("#btnCreateAM");
  const btnPlayAM   = $("#btnPlayAM");
  const btnPrev = $("#btnPrev");
  const btnPP   = $("#btnPP");
  const btnNext = $("#btnNext");
  const nptitle = $("#nptitle");
  const openAM  = $("#openAM");
  const npdot   = $("#npdot");
  const chips   = $("#chips");
  const status  = $("#status");
  const btnSpotifyLogin = $("#btnSpotifyLogin");
  const btnCreateSP     = $("#btnCreateSP");

  // Default date (YYYY-MM-DD) – set today minus ~8,000 days as fun default
  const today = new Date();
  if (!dateEl.value) {
    const y = today.getFullYear(), m = String(today.getMonth()+1).padStart(2,"0"), d = String(today.getDate()).padStart(2,"0");
    dateEl.value = `${y}-${m}-${d}`;
  }

  // Visualizer bars (pure CSS animation)
  const bars = $("#bars");
  for (let i=0;i<36;i++){ const b=document.createElement("div"); b.className="bar"; bars.appendChild(b); }

  // App state
  let currentTracks = [];   // [{artist,title,timestamp,source_rank}]
  let amDevToken   = null;
  let amStorefront = "us";
  let music        = null;  // MusicKit instance
  let spotify = { access_token:null, refresh_token:null, expires_at:0 };

  // --- Helpers ---
  function iso(val){ // expect input[type=date] -> already yyyy-mm-dd
    return val || new Date().toISOString().slice(0,10);
  }

  function showStatus(t){ setText(status, t); }

  function addChips(tracks){
    chips.innerHTML = "";
    tracks.slice(0,24).forEach(t => {
      const span = document.createElement("span");
      span.className = "chip";
      span.textContent = `${t.artist} — ${t.title}`;
      chips.appendChild(span);
    });
  }

  function parseHashTokens(){
    if (!location.hash) return;
    const params = new URLSearchParams(location.hash.slice(1));
    const at = params.get("access_token");
    const rt = params.get("refresh_token");
    const exp = parseInt(params.get("expires_in") || "3600", 10);
    if (at){
      spotify.access_token = at;
      if (rt) spotify.refresh_token = rt;
      spotify.expires_at = Math.floor(Date.now()/1000) + exp - 20;
      localStorage.setItem("td_spotify", JSON.stringify(spotify));
      showStatus("Spotify signed in.");
    }
    // clean hash
    history.replaceState(null, "", location.pathname + location.search);
  }

  function loadSpotifyFromStorage(){
    try{
      const raw = localStorage.getItem("td_spotify");
      if (!raw) return;
      const s = JSON.parse(raw);
      spotify = s || spotify;
    }catch{}
  }

  // --- Apple Music init ---
  async function ensureMusicKit(){
    if (music) return music;
    // fetch dev token
    const r = await fetch(`${API}/v1/apple/dev-token`);
    if (!r.ok){ throw new Error("Failed to get Apple dev token"); }
    const j = await r.json();
    amDevToken = j.token; amStorefront = (j.storefront||"us").toLowerCase();

    // Configure MusicKit after script loads
    await new Promise(res => {
      if (window.MusicKit) return res();
      const iv = setInterval(() => { if (window.MusicKit){ clearInterval(iv); res(); } }, 30);
    });

    MusicKit.configure({
      developerToken: amDevToken,
      app: { name: "TapeDeck Time Machine", build: "1.0" }
    });
    music = MusicKit.getInstance();
    music.storefrontId = amStorefront;

    // Wire player events
    music.addEventListener("nowPlayingItemDidChange", () => {
      updateNP();
    });
    music.addEventListener("playbackStateDidChange", () => {
      // Update dot + button glyph without assuming player.isPlaying exists
      const st = music?.player?.playbackState;
      const playing = st === MusicKit.PlaybackState.playing || st === 3;
      npdot.hidden = !playing;
      btnPP.textContent = playing ? "⏸" : "▶";
    });

    return music;
  }

  function updateNP(){
    try{
      const item = music?.player?.nowPlayingItem;
      if (!item){ nptitle.textContent = "—"; openAM.removeAttribute("href"); return; }
      const name = item?.attributes?.name || "Unknown";
      const artist = item?.attributes?.artistName || "";
      nptitle.textContent = artist ? `${name} — ${artist}` : name;
      const url = item?.attributes?.url;
      if (url) { openAM.href = url; openAM.target = "_blank"; openAM.rel = "noopener"; }
    }catch{}
  }

  async function searchAppleIDs(tracks){
    if (!amDevToken) await ensureMusicKit();
    const ids = [];
    for (const t of tracks){
      const q = encodeURIComponent(`${t.artist} ${t.title}`);
      const url = `https://api.music.apple.com/v1/catalog/${amStorefront}/search?term=${q}&limit=1&types=songs`;
      try{
        const r = await fetch(url,{ headers:{Authorization:`Bearer ${amDevToken}`}});
        if (!r.ok) continue;
        const js = await r.json();
        const item = (((js.results||{}).songs||{}).data||[])[0];
        if (item) ids.push(item.id);
      }catch{}
      await new Promise(r=>setTimeout(r,120)); // gentle rate limiting
    }
    return ids;
  }

  // --- Actions ---
  btnGenerate.onclick = async () => {
    const payload = {
      date: iso(dateEl.value),
      genre: genreEl.value,
      hours: parseFloat(hoursEl.value||"1"),
      repeat_gap_min: parseInt(gapEl.value||"90", 10),
      seed: (seedEl.value||"97"),
      limit: 120
    };
    showStatus("Generating…");
    btnGenerate.disabled = true;
    try{
      const r = await fetch(`${API}/v1/simulate`, {method:"POST", headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
      if (!r.ok) throw new Error(await r.text());
      const j = await r.json();
      currentTracks = (j.tracks||[]).map(t => ({artist:t.artist,title:t.title,timestamp:t.timestamp,source_rank:t.source_rank}));
      showStatus(`Now playing ${currentTracks.length} tracks ready.`);
      addChips(currentTracks);
    }catch(e){
      console.error(e);
      showStatus("Generate failed.");
    }finally{
      btnGenerate.disabled = false;
    }
  };

  // Apple: Create playlist in user library (requires user authorize)
  btnCreateAM.onclick = async () => {
    try{
      await ensureMusicKit();
      if (!music.isAuthorized){ await music.authorize(); }
      const userToken = music.musicUserToken;
      if (!userToken){ alert("Apple authorization failed."); return; }

      const name = `TapeDeck ${iso(dateEl.value)} — ${genreEl.value}`;
      btnCreateAM.disabled = true;
      showStatus("Creating Apple playlist…");
      const r = await fetch(`${API}/v1/apple/create-playlist`, {
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userToken, name, tracks: currentTracks })
      });
      const j = await r.json();
      if (!r.ok) throw new Error(j.detail || "Apple create failed");
      showStatus(`Apple playlist created. Added ${j.added_count}/${j.total_tracks}.`);
    }catch(e){
      console.error(e);
      showStatus("Apple playlist failed.");
    }finally{
      btnCreateAM.disabled = false;
    }
  };

  // Apple: Built-in mini player
  btnPlayAM.onclick = async () => {
    try{
      if (!currentTracks.length){ showStatus("Nothing to play. Generate first."); return; }
      await ensureMusicKit();
      // Use catalog search with dev token to build a playable queue
      showStatus("Resolving Apple matches…");
      const ids = await searchAppleIDs(currentTracks.slice(0, 120));
      if (!ids.length){ showStatus("No Apple matches found."); return; }
      await music.setQueue({ songs: ids });
      await music.play();
      showStatus(`Playing ${ids.length} Apple tracks.`);
      updateNP();
    }catch(e){
      console.error(e);
      showStatus("Apple playback failed.");
    }
  };

  // Mini controls
  btnPrev.onclick = async () => { try{ await ensureMusicKit(); await music.player.skipToPreviousItem(); }catch{} };
  btnNext.onclick = async () => { try{ await ensureMusicKit(); await music.player.skipToNextItem(); }catch{} };
  btnPP.onclick   = async () => {
    try{
      await ensureMusicKit();
      const st = music.player.playbackState;
      const playing = st === MusicKit.PlaybackState.playing || st === 3;
      if (playing){ await music.pause(); } else { await music.play(); }
    }catch(e){ console.error(e); }
  };

  // Spotify
  parseHashTokens();
  loadSpotifyFromStorage();

  btnSpotifyLogin.onclick = () => {
    // Backend handles state + redirect
    window.location.href = `${API}/v1/spotify/login`;
  };

  btnCreateSP.onclick = async () => {
    const tok = spotify.access_token;
    if (!tok){ alert("Sign in to Spotify first."); return; }
    if (!currentTracks.length){ alert("Generate a list first."); return; }
    btnCreateSP.disabled = true;
    showStatus("Creating Spotify playlist…");
    try{
      const name = `TapeDeck ${iso(dateEl.value)} — ${genreEl.value}`;
      const r = await fetch(`${API}/v1/spotify/create-playlist`, {
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ accessToken: tok, name, tracks: currentTracks })
      });
      const j = await r.json();
      if (!r.ok) throw new Error(j.detail||"Spotify create failed");
      showStatus(`Spotify playlist ready. Added ${j.added_count}/${j.total_tracks}.`);
      if (j.url){ window.open(j.url, "_blank", "noopener"); }
    }catch(e){
      console.error(e);
      showStatus("Spotify playlist failed.");
    }finally{
      btnCreateSP.disabled = false;
    }
  };

})();
</script>
</body>
</html>
