<!doctype html>
<meta charset="utf-8">
<title>TapeDeck – Finishing sign-in…</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:24px;color:#e5e7eb;background:#0a0f17}
  .box{max-width:640px;margin:0 auto;background:#111827;border:1px solid #263040;border-radius:14px;padding:16px}
  .muted{color:#94a3b8}
  .err{color:#fda4af;margin-top:.75rem;white-space:pre-wrap}
</style>

<div class="box">
  <h2>Finishing sign-in…</h2>
  <div class="muted" id="msg">Please wait...</div>
  <pre id="err" class="err"></pre>
</div>

<script>
(() => {
  const $msg = (t)=>document.getElementById('msg').textContent=t||'';
  const $err = (t)=>document.getElementById('err').textContent=t||'';

  try {
    // --- PART 1: Check for redirect from Apple (token in hash) ---
    // Apple sends the token back as: #user-token=...&state=...
    if (location.hash.includes('user-token')) {
      $msg('Processing token...');
      
      const params = new URLSearchParams(location.hash.substring(1)); // Read from hash
      const token = params.get('user-token');
      const stateStr = params.get('state');

      if (!token) {
        throw new Error('Authentication response missing user token.');
      }

      // Build the new URL, converting hash to query string
      // This is what your app's deep link is expecting
      const newURL = new URL(location.pathname, location.origin);
      newURL.searchParams.set('token', token); // Set token in query

      // Decode and pass along the state (which contains 'native=1')
      if (stateStr) {
        // We decode the base64 string we made in the previous file
        const state = JSON.parse(atob(stateStr));
        if (state.api) newURL.searchParams.set('api', state.api);
        if (state.native) newURL.searchParams.set('native', state.native);
      }
      
      // Self-redirect to the new URL. The page will reload.
      location.replace(newURL.toString());

    } 
    // --- PART 2: Check for redirect to App (token in search) ---
    // On the second pass, the URL will be: ?token=...&native=1...
    else if (location.search.includes('native=1')) {
      $msg('Token found! Returning to app...');
      const qs = location.search;
      
      // This is your original deep link logic. It will now work.
      location.replace('com.tapedecktimemachine.app://auth/callback' + qs);
    } 
    // --- Fallback ---
    else {
      // This handles the non-native web flow, if any.
      $msg('Sign-in complete. You can close this window.');
    }

  } catch (e) {
    console.error(e);
    $msg('Authentication failed:');
    $err(e.message || String(e));
  }
})();
</script>
</html>