<!doctype html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TapeDeck – Apple Music sign-in</title>
<script src="https://js-cdn.music.apple.com/musickit/v3/musickit.js"></script>
<style>
  :root{--bg:#0a0f17;--panel:#111827;--muted:#94a3b8;--text:#e5e7eb}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 -apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .box{max-width:720px;margin:28px auto;background:#111827;border:1px solid #263040;border-radius:14px;padding:16px}
  .muted{color:var(--muted)}
  .err{color:#fda4af;margin-top:.75rem;white-space:pre-wrap}
  button{display:block;width:100%;font-size:1.05rem;font-weight:700;color:#fff;background:#007aff;border:0;border-radius:12px;padding:12px 16px;cursor:pointer}
  button:disabled{background:#475569;color:#cbd5e1;cursor:not-allowed}
  /* Style for diagnostic log */
  #diagLog { margin-top: 1rem; padding: 0.5rem; background: #000; border: 1px dashed #444; font-size: 0.7rem; color: #888; max-height: 100px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; }
</style>

<div class="box">
  <h2 style="margin:.2rem 0">Connect to Apple Music</h2>
  <p class="muted" id="msg">Initializing…</p>
  <button id="signInButton" disabled>Sign in with Apple Music</button>
  <pre id="err" class="err"></pre>
  <pre id="diagLog">Diagnostic Log:</pre>
</div>

<script>
(async function(){
  const btn = document.getElementById('signInButton');
  const $msg = (t)=>document.getElementById('msg').textContent=t||'';
  const $err = (t)=>document.getElementById('err').textContent=t||'';
  const diagLogEl = document.getElementById('diagLog');
  // --- Logging function ---
  const logDiag = (message, ...args) => {
      const ts = new Date().toLocaleTimeString();
      const text = args.length > 0 ? `${ts}: ${message} ${JSON.stringify(args)}` : `${ts}: ${message}`;
      diagLogEl.textContent += `\n${text}`;
      diagLogEl.scrollTop = diagLogEl.scrollHeight; // Auto-scroll
      console.log(message, ...args); // Keep console log too
  };
  // --- End logging function ---

  const qs = new URLSearchParams(location.search);
  const API = qs.get('api') || 'https://timedeck-api.onrender.com';
  const CALLBACK_HOST = 'https://tapedecktimemachine.com';
  let developerToken = null;

  function isInvalidToken(token) {
    return !token || typeof token !== 'string' || token.trim().length === 0;
  }

  function waitForMusicKit(timeout=15000){
    logDiag('Waiting for MusicKit...');
    if (window.MusicKit && window.MusicKit.getInstance) {
        logDiag('MusicKit already loaded.');
        return Promise.resolve();
    }
    return new Promise((res, rej)=>{
      const to = setTimeout(()=>{ logDiag('MusicKit load timed out.'); rej(new Error('MusicKit load timed out')); }, timeout);
      addEventListener('musickitloaded', ()=>{ logDiag('MusicKit loaded via event.'); clearTimeout(to); res(); }, { once:true });
    });
  }

  async function init(){
    try{
      logDiag('[INIT] Starting initialization...');
      $msg('Loading MusicKit…');
      await waitForMusicKit();
      logDiag('[INIT] MusicKit wait complete.');

      $msg('Requesting developer token…');
      logDiag('[INIT] Fetching dev token from:', API);
      const r = await fetch(`${API}/v1/apple/dev-token`, { cache: 'no-store' });
      logDiag('[INIT] Fetch status:', r.status);
      if(!r.ok) throw new Error(`dev-token ${r.status}`);
      const j = await r.json();
      logDiag('[INIT] Received JSON from API.');

      if (isInvalidToken(j.token)) {
        logDiag('[INIT] ERROR: API returned invalid token:', j.token);
        throw new Error('No developer token was returned from the API.');
      }

      developerToken = j.token.trim();
      logDiag(`[INIT] Developer token loaded successfully. Length: ${developerToken.length}`);

      $msg('Tap the button to open Apple sign-in.');
      btn.disabled = false;

      // --- NEW: Assign onclick AFTER button is enabled ---
      btn.onclick = doAuth;
      // --- END NEW ---

      logDiag('[INIT] Initialization complete, button enabled and click handler assigned.'); // Updated log
    }catch(e){
      logDiag('[INIT] FAILED:', e.message || String(e));
      $msg('Initialization failed.');
      $err(e.message || String(e));
    }
  }

  async function doAuth(){
    logDiag('[AUTH] Button clicked.');
    btn.disabled = true; $err(''); $msg('Redirecting to Apple…');

    try{
      if (isInvalidToken(developerToken)) {
        logDiag('[AUTH] ERROR: Developer token invalid/missing before redirect:', developerToken);
        throw new Error('Developer token is missing. Please refresh.');
      }

      logDiag(`[AUTH] Using valid developer token. Length: ${developerToken.length}`);

      const redirectURL = `${CALLBACK_HOST}/auth/callback/`;
      const authURL = new URL('https://idmsa.apple.com/IDMSWebAuth/auth2');

      authURL.searchParams.set('appIdKey', 'cbf6439019b843308571a6e7a1c7d7041a99a656606ffc8446b8259b350f4d6d');
      authURL.searchParams.set('language', 'en-US');
      authURL.searchParams.set('path', '/authorize');
      authURL.searchParams.set('redirectUrl', redirectURL);
      authURL.searchParams.set('sdkVersion', 'musickit.js/v3');

      const state = { api: qs.get('api'), native: '1' };
      const stateStr = btoa(JSON.stringify(state));
      authURL.searchParams.set('state', stateStr);
      logDiag('[AUTH] State param set:', stateStr);

      // --- Using SIMPLIFIED webAuth OBJECT ---
      const webAuth = { developerToken }; // ONLY send the token
      const webAuthStr = JSON.stringify(webAuth);
      authURL.searchParams.set('webAuthentication', webAuthStr);
      logDiag('[AUTH] SIMPLIFIED webAuthentication param set. Length:', webAuthStr.length);
      // --- END SIMPLIFIED BLOCK ---

      const finalUrlToLoad = authURL.toString();

      logDiag('[AUTH] Final URL generated. Length:', finalUrlToLoad.length);
      logDiag('[AUTH] Attempting redirect now...');

      location.href = finalUrlToLoad; // Redirect

    }catch(e){
      logDiag('[AUTH] FAILED:', e.message || String(e));
      $msg('Sign-in failed.');
      $err(e.message || String(e));
      btn.disabled = false; // allow retry
    }
  }

  // init() will assign the click handler now
  init(); // Start loading the token
})();
</script>
</html>