<!doctype html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TapeDeck – Apple Music sign-in</title>
<script src="https://js-cdn.music.apple.com/musickit/v3/musickit.js"></script>
<style>
  :root{--bg:#0a0f17;--panel:#111827;--muted:#94a3b8;--text:#e5e7eb}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 -apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .box{max-width:720px;margin:28px auto;background:#111827;border:1px solid #263040;border-radius:14px;padding:16px}
  .muted{color:var(--muted)}
  .err{color:#fda4af;margin-top:.75rem;white-space:pre-wrap}
  button{display:block;width:100%;font-size:1.05rem;font-weight:700;color:#fff;background:#007aff;border:0;border-radius:12px;padding:12px 16px;cursor:pointer}
  button:disabled{background:#475569;color:#cbd5e1;cursor:not-allowed}
  .tip{margin-top:.75rem}
</style>

<div class="box">
  <h2 style="margin:.2rem 0">Connect to Apple Music</h2>
  <p class="muted" id="msg">Initializing...</p>

  <button id="signInButton" disabled>Sign in with Apple Music</button>

  <pre id="err" class="err"></pre>
</div>

<script>
(async function(){
  const btn = document.getElementById('signInButton');
  const $msg = (t)=>document.getElementById('msg').textContent=t||'';
  const $err = (t)=>document.getElementById('err').textContent=t||'';
  const qs = new URLSearchParams(location.search);
  const API = qs.get('api') || 'https://timedeck-api.onrender.com';
  const CALLBACK_HOST = 'https://tapedecktimemachine.com';

  let developerToken; // We'll store this after pre-loading

  function waitForMusicKit(timeout=15000){
    if (window.MusicKit && window.MusicKit.getInstance) return Promise.resolve();
    return new Promise((res, rej)=>{
      const to = setTimeout(()=>rej(new Error('MusicKit load timed out')), timeout);
      addEventListener('musickitloaded', ()=>{ clearTimeout(to); res(); }, { once:true });
    });
  }

  // --- NEW: Pre-fetch the token on page load ---
  async function prepareToken() {
    try {
      $msg('Initializing MusicKit…');
      await waitForMusicKit();

      $msg('Requesting developer token…');
      const r = await fetch(`${API}/v1/apple/dev-token`, { cache: 'no-store' });
      if(!r.ok) throw new Error(`dev-token ${r.status}`);
      const { token } = await r.json();
      if(!token) throw new Error('No developer token');
      
      developerToken = token; // Store the token
      
      $msg('Tap the button to open Apple sign-in.');
      btn.disabled = false; // Enable the button

    } catch(e) {
      console.error(e);
      $msg('Initialization failed.');
      $err(e.message || String(e));
      btn.disabled = true;
    }
  }

  // --- MODIFIED: This function now intercepts the pop-up ---
  async function doAuth(){
    btn.disabled = true; $err(''); $msg('Preparing sign-in…');

    try{
      if (!developerToken) {
        throw new Error('Developer token is missing. Please refresh.');
      }
      
      // 1. THIS IS THE HACK: Temporarily replace window.open
      const originalWindowOpen = window.open;
      let authURL = '';
      window.open = (url) => {
        authURL = url; // Capture the URL
        console.log('Intercepted auth URL:', authURL);
        return null; // Prevent the pop-up
      };

      // 2. Configure MusicKit
      window.MusicKit.configure({ developerToken, app:{ name:'TapeDeck Time Machine', build:'native' } });
      let mk = window.MusicKit.getInstance();
      for (let i=0;i<10 && (!mk || typeof mk.authorize!=='function');i++){
        await new Promise(res=>setTimeout(res,100));
        mk = window.MusicKit.getInstance();
      }
      if(!mk || typeof mk.authorize!=='function') throw new Error('MusicKit not initialized');

      // 3. Call authorize(). Our hack will intercept it.
      $msg('Opening Apple sign-in…');
      try {
        await mk.authorize();
      } catch (e) {
        // This may throw a 'null' error because we blocked it.
        // We can safely ignore it as long as we got the URL.
        console.log('authorize() threw a recoverable error:', e.message);
      }
      
      // 4. Restore the original window.open
      window.open = originalWindowOpen;

      // 5. Check if we captured the URL
      if (!authURL) {
        throw new Error('Could not capture the authorization URL. Auth flow failed.');
      }

      // 6. THIS IS THE FIX: Redirect the *entire page*
      $msg('Redirecting to Apple…');
      location.href = authURL; // This is a redirect, NOT a pop-up

    }catch(e){
      console.error(e);
      $msg('Sign-in failed.');
      $err(e.message || String(e));
      btn.disabled = false; // allow retry
    }
  }

  // --- MODIFIED: Start the token prep, and listen for the click ---
  btn.addEventListener('click', doAuth, { passive: true });
  prepareToken(); // Run pre-load
  
})();
</script>
</html>