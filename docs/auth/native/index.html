<!doctype html>
<meta charset="utf-8">
<title>TapeDeck – Apple Music sign-in…</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://js-cdn.music.apple.com/musickit/v3/musickit.js"></script>
<style>
  body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:24px;color:#e5e7eb;background:#0a0f17}
  .box{max-width:640px;margin:0 auto;background:#111827;border:1px solid #263040;border-radius:14px;padding:16px}
  .muted{color:#94a3b8}
  .err{color:#fda4af;margin-top:8px;white-space:pre-wrap}
</style>

<div class="box">
  <h2>Connecting to Apple Music…</h2>
  <div id="msg" class="muted">Preparing sign-in…</div>
  <div id="err" class="err"></div>
</div>

<script>
(async () => {
  const qs = new URLSearchParams(location.search);
  // allow ?api=... override, default to your Render API
  const API = qs.get('api') || 'https://timedeck-api.onrender.com';
  const nativeFlag = '1'; // we’re in the native flow

  const $ = (id) => document.getElementById(id);
  const say = (m) => { $('msg').textContent = m; };
  const fail = (e) => { $('err').textContent = (e && e.message) ? e.message : String(e || 'Unknown error'); };

  try {
    say('Loading MusicKit…');

    // wait for MusicKit to be ready
    await new Promise((res, rej) => {
      if (window.MusicKit && typeof MusicKit.getInstance === 'function') return res();
      const t = setTimeout(() => rej(new Error('MusicKit load timed out')), 15000);
      window.addEventListener('musickitloaded', () => { clearTimeout(t); res(); }, { once: true });
    });

    say('Requesting developer token…');
    const r = await fetch(`${API}/v1/apple/dev-token`, { credentials: 'omit' });
    if (!r.ok) throw new Error(`dev-token ${r.status}`);
    const { token: developerToken } = await r.json();
    if (!developerToken) throw new Error('No developer token returned');

    // configure & get instance (with retries in case it’s slow)
    MusicKit.configure({ developerToken, app: { name: 'TapeDeck Time Machine', build: 'native' } });
    let music = MusicKit.getInstance();
    for (let i=0; i<10 && (!music || typeof music.authorize !== 'function'); i++) {
      await new Promise(res => setTimeout(res, 100));
      music = MusicKit.getInstance();
    }
    if (!music || typeof music.authorize !== 'function') {
      throw new Error('MusicKit not initialized (no authorize)');
    }

    say('Opening Apple sign-in…');
    const token = await music.authorize();   // <-- Apple sheet opens; user approves
    if (!token) throw new Error('Authorization failed (no token)');

    say('Returning to app…');
    // hand back to your app via callback; include native=1 so callback page bounces to custom scheme
    const cb = new URL('https://tapedecktimemachine.com/auth/callback/');
    cb.searchParams.set('token', token);
    cb.searchParams.set('native', nativeFlag);
    // preserve ?api override if present
    if (qs.get('api')) cb.searchParams.set('api', qs.get('api'));
    location.replace(cb.toString());
  } catch (e) {
    fail(e);
  }
})();
</script>
